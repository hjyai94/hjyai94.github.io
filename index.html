<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="HJY的装逼小站">
<meta property="og:type" content="website">
<meta property="og:title" content="HJY">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="HJY">
<meta property="og:description" content="HJY的装逼小站">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HJY">
<meta name="twitter:description" content="HJY的装逼小站">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'HR62QHMRVP',
      apiKey: '5003cc57039452aa0e152bdb9198ed17',
      indexName: 'dev_NAME',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>HJY</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HJY</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">昨夜西风凋碧树，独上高楼望尽天涯路。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/14/Brats/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/14/Brats/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-14T14:37:38+08:00">
                2018-12-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>This project is a segmentation model to diagnose brain tumor (Complete, Core) using BraTS 2016, 2017 dataset.<br>BraTS has always been focusing on the evaluation of state-of-the-art methods for the segmentation of brain tumors in multimodal magnetic resonance imaging (MRI) scans. BraTS 2018 utilizes multi-institutional pre- operative MRI scans and focuses on the segmentation of intrinsically heterogeneous (in appearance, shape, and histology) brain tumors, namely gliomas. Furthemore, to pinpoint the clinical relevance of this segmentation task, BraTS’18 also focuses on the prediction of patient overall survival, via integrative analyses of radiomic features and machine learning algorithms.You can check this project in this link：<a href="https://github.com/JooHyun-Lee/BraTs" target="_blank" rel="noopener">https://github.com/JooHyun-Lee/BraTs</a></p>
<h1 id="models"><a href="#models" class="headerlink" title="models"></a>models</h1><h2 id="init-py"><a href="#init-py" class="headerlink" title="__init__.py"></a>__init__.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.optim <span class="keyword">import</span> Adam, SGD</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .unet <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .pspnet <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .deeplab <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sys.path.append(os.path.dirname(os.path.abspath(os.path.dirname(__file__))))</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_model</span><span class="params">(args, class_num, mode)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Device Init</span></span><br><span class="line">    device = config.device</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model Init</span></span><br><span class="line">    <span class="keyword">if</span> args.model == <span class="string">'unet'</span>:</span><br><span class="line">        net = UNet(args.in_channel, class_num, drop_rate=args.drop_rate)</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'pspnet_squeeze'</span>:</span><br><span class="line">        net = pspnet_squeeze()</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'pspnet_res18'</span>:</span><br><span class="line">        net = pspnet_res18()</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'pspnet_res34'</span>:</span><br><span class="line">        net = pspnet_res34()</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'pspnet_res50'</span>:</span><br><span class="line">        net = pspnet_res50()</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'deeplab'</span>:</span><br><span class="line">        net = Deeplab_V3_Plus()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'args.model ERROR'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optimizer Init</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">'train'</span>:</span><br><span class="line">        resume = args.resume</span><br><span class="line">        <span class="comment">#optimizer = Adam(net.parameters(), lr=args.lr)</span></span><br><span class="line">        optimizer = SGD(net.parameters(), lr=args.lr, momentum=<span class="number">0.9</span>, weight_decay=<span class="number">1e-4</span>)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">'test'</span>:</span><br><span class="line">        resume = <span class="keyword">True</span></span><br><span class="line">        optimizer = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'load_model mode ERROR'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model Load</span></span><br><span class="line">    <span class="keyword">if</span> resume:</span><br><span class="line">        checkpoint = Checkpoint(net, optimizer)</span><br><span class="line">        checkpoint.load(os.path.join(args.ckpt_root, args.model+<span class="string">'.tar'</span>))</span><br><span class="line">        best_score = checkpoint.best_score</span><br><span class="line">        start_epoch = checkpoint.epoch+<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        best_score = <span class="number">0</span></span><br><span class="line">        start_epoch = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> device == <span class="string">'cuda'</span>:</span><br><span class="line">        net.cuda()</span><br><span class="line">        net = torch.nn.DataParallel(net)</span><br><span class="line">        torch.backends.cudnn.benchmark=<span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> net, optimizer, best_score, start_epoch</span><br></pre></td></tr></table></figure>
<h2 id="deeplab-py"><a href="#deeplab-py" class="headerlink" title="deeplab.py"></a>deeplab.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn.functional <span class="keyword">import</span> softmax, interpolate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"><span class="comment">#                                       #</span></span><br><span class="line"><span class="comment">#   ResNet for DeepLab v3+ Backbone     #</span></span><br><span class="line"><span class="comment">#                                       #</span></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv1x1</span><span class="params">(in_planes, out_planes, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>, bias=<span class="keyword">False</span>),</span><br><span class="line">        nn.BatchNorm2d(out_planes),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv3x3</span><span class="params">(in_planes, out_planes, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="keyword">False</span>),</span><br><span class="line">        nn.BatchNorm2d(out_planes),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv3x3_simple</span><span class="params">(in_planes, out_planes, stride=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">3</span>, stride=stride,</span><br><span class="line">                     padding=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv5x5</span><span class="params">(in_planes, out_planes, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">5</span>, stride=<span class="number">1</span>, padding=<span class="number">2</span>, bias=<span class="keyword">False</span>),</span><br><span class="line">        nn.BatchNorm2d(out_planes),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">atrous_conv</span><span class="params">(in_planes, out_planes, atrous_rate, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>,</span><br><span class="line">                  padding=atrous_rate, dilation=atrous_rate, bias=<span class="keyword">False</span>),</span><br><span class="line">        nn.BatchNorm2d(out_planes),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicBlock</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes, planes, stride=<span class="number">1</span>, downsample=None, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(BasicBlock, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        self.conv1 = conv3x3_simple(inplanes, planes, stride)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.conv2 = conv3x3_simple(planes, planes)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bottleneck</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes, planes, stride=<span class="number">1</span>, downsample=None, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(Bottleneck, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        self.conv1 = nn.Conv2d(inplanes, planes, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=stride,</span><br><span class="line">                               padding=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv3 = nn.Conv2d(planes, planes * <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(planes * <span class="number">4</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, block, layers, num_classes=<span class="number">1000</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(ResNet, self).__init__()</span><br><span class="line">        self.expansion = block.expansion</span><br><span class="line">        self.inplanes = <span class="number">64</span></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(<span class="number">64</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.maxpool = nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.layer1 = self._make_layer(block, <span class="number">64</span>, layers[<span class="number">0</span>], drop_rate=drop_rate)</span><br><span class="line">        self.layer2 = self._make_layer(block, <span class="number">128</span>, layers[<span class="number">1</span>], stride=<span class="number">2</span>, drop_rate=drop_rate)</span><br><span class="line">        self.layer3 = self._make_layer(block, <span class="number">256</span>, layers[<span class="number">2</span>], stride=<span class="number">2</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line">        self.low_conv = nn.Conv2d(<span class="number">64</span>*block.expansion, <span class="number">64</span>, kernel_size=<span class="number">3</span>,</span><br><span class="line">                                  stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.atr_conv1 = atrous_conv(<span class="number">256</span>*block.expansion,<span class="number">128</span>,<span class="number">1</span>)</span><br><span class="line">        self.atr_conv2 = atrous_conv(<span class="number">256</span>*block.expansion,<span class="number">128</span>,<span class="number">2</span>)</span><br><span class="line">        self.atr_conv3 = atrous_conv(<span class="number">256</span>*block.expansion,<span class="number">128</span>,<span class="number">4</span>)</span><br><span class="line">        self.atr_conv4 = atrous_conv(<span class="number">256</span>*block.expansion,<span class="number">128</span>,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">                n = m.kernel_size[<span class="number">0</span>] * m.kernel_size[<span class="number">1</span>] * m.out_channels</span><br><span class="line">                m.weight.data.normal_(<span class="number">0</span>, math.sqrt(<span class="number">2.</span> / n))</span><br><span class="line">            <span class="keyword">elif</span> isinstance(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_layer</span><span class="params">(self, block, planes, blocks, stride=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        downsample = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> self.inplanes != planes * block.expansion:</span><br><span class="line">            downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(self.inplanes, planes * block.expansion,</span><br><span class="line">                          kernel_size=<span class="number">1</span>, stride=stride, bias=<span class="keyword">False</span>),</span><br><span class="line">                nn.BatchNorm2d(planes * block.expansion),</span><br><span class="line">                nn.Dropout2d(p=drop_rate)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        layers = []</span><br><span class="line">        layers.append(block(self.inplanes, planes, stride, downsample, drop_rate=drop_rate))</span><br><span class="line">        self.inplanes = planes * block.expansion</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, blocks):</span><br><span class="line">            layers.append(block(self.inplanes, planes, drop_rate=drop_rate))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        x = self.bn1(x)</span><br><span class="line">        x = self.relu(x)</span><br><span class="line">        x = self.maxpool(x)</span><br><span class="line">        low_x = self.layer1(x)</span><br><span class="line">        x = self.layer2(low_x)</span><br><span class="line">        x = self.layer3(x)</span><br><span class="line">        x1 = self.atr_conv1(x)</span><br><span class="line">        x2 = self.atr_conv2(x)</span><br><span class="line">        x3 = self.atr_conv3(x)</span><br><span class="line">        x4 = self.atr_conv4(x)</span><br><span class="line">        <span class="keyword">if</span> self.expansion != <span class="number">1</span>:</span><br><span class="line">            low_x = self.low_conv(low_x)</span><br><span class="line">        <span class="keyword">return</span> torch.cat((x1,x2,x3,x4), <span class="number">1</span>), low_x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet18</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet34</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet50</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet101</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet152</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">8</span>, <span class="number">36</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet_test</span><span class="params">()</span>:</span></span><br><span class="line">    net = resnet152()</span><br><span class="line">    net = nn.DataParallel(net)</span><br><span class="line">    net.cuda()</span><br><span class="line"></span><br><span class="line">    x = torch.randn((<span class="number">1</span>,<span class="number">1</span>,<span class="number">1024</span>,<span class="number">1024</span>))</span><br><span class="line">    y1, y2 = net(x)</span><br><span class="line">    print(y1.size())</span><br><span class="line">    print(y2.size())</span><br><span class="line"></span><br><span class="line"><span class="comment">#resnet_test()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"><span class="comment">#                                       #</span></span><br><span class="line"><span class="comment">#           DeepLab V3 +                #</span></span><br><span class="line"><span class="comment">#                                       #</span></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Encoder</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(Encoder, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        self.conv1 = conv1x1(<span class="number">512</span>, <span class="number">256</span>)</span><br><span class="line">        self.atr_conv1 = atrous_conv(<span class="number">512</span>, <span class="number">256</span>, <span class="number">6</span>, drop_rate)</span><br><span class="line">        self.atr_conv2 = atrous_conv(<span class="number">512</span>, <span class="number">256</span>, <span class="number">12</span>, drop_rate)</span><br><span class="line">        self.atr_conv3 = atrous_conv(<span class="number">512</span>, <span class="number">256</span>, <span class="number">18</span>, drop_rate)</span><br><span class="line">        self.avgpool = nn.AvgPool2d(<span class="number">2</span>) <span class="comment">#impossible due to 15/2 = 7.5</span></span><br><span class="line">        self.conv2 = conv1x1(<span class="number">512</span>, <span class="number">256</span>)</span><br><span class="line">        self.conv_cat = conv1x1(<span class="number">1280</span>, <span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        y1 = self.conv1(x)</span><br><span class="line">        y2 = self.atr_conv1(x)</span><br><span class="line">        y3 = self.atr_conv2(x)</span><br><span class="line">        y4 = self.atr_conv3(x)</span><br><span class="line">        y5 = self.avgpool(x)</span><br><span class="line">        y5 = self.conv2(y5)</span><br><span class="line">        y5 = interpolate(y5, scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">        y = torch.cat([y1, y2, y3, y4], dim=<span class="number">1</span>)</span><br><span class="line">        y = self.conv_cat(y)</span><br><span class="line">        <span class="keyword">return</span> interpolate(y, scale_factor=<span class="number">4</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Deeplab_V3_Plus</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, class_num=<span class="number">2</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(Deeplab_V3_Plus, self).__init__()</span><br><span class="line">        self.resnet = resnet50(drop_rate=drop_rate)</span><br><span class="line">        self.conv0 = conv1x1(<span class="number">64</span>, <span class="number">256</span>, drop_rate)</span><br><span class="line">        self.encoder = Encoder(drop_rate)</span><br><span class="line">        self.conv1 = conv3x3(<span class="number">768</span>, <span class="number">512</span>, drop_rate)</span><br><span class="line">        self.conv2 = conv3x3(<span class="number">512</span>, <span class="number">256</span>, drop_rate)</span><br><span class="line">        self.conv3 = conv3x3(<span class="number">256</span>, class_num)</span><br><span class="line">        self.conv4 = conv5x5(class_num, class_num)</span><br><span class="line">        self.conv5 = conv5x5(class_num, class_num)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        y, low_y = self.resnet(x)</span><br><span class="line">        low_y = self.conv0(low_y)</span><br><span class="line">        y = self.encoder(y)</span><br><span class="line">        y = torch.cat([low_y, y], dim=<span class="number">1</span>)</span><br><span class="line">        y = self.conv1(y)</span><br><span class="line">        y = self.conv2(y)</span><br><span class="line">        y = self.conv3(y)</span><br><span class="line">        y = interpolate(y, scale_factor=<span class="number">4</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>)</span><br><span class="line">        y = self.conv4(y)</span><br><span class="line">        y = self.conv5(y)</span><br><span class="line">        y = softmax(y, dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deeplab_test</span><span class="params">()</span>:</span></span><br><span class="line">    net = Deeplab_V3_Plus()</span><br><span class="line">    net = nn.DataParallel(net)</span><br><span class="line">    net.cuda()</span><br><span class="line"></span><br><span class="line">    x = torch.randn((<span class="number">1</span>,<span class="number">1</span>,<span class="number">1024</span>,<span class="number">1024</span>))</span><br><span class="line">    y = net(x)</span><br><span class="line">    print(y.size())</span><br><span class="line"></span><br><span class="line"><span class="comment">#deeplab_test()</span></span><br></pre></td></tr></table></figure>
<h2 id="pspnet-py"><a href="#pspnet-py" class="headerlink" title="pspnet.py"></a>pspnet.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.nn.functional <span class="keyword">import</span> softmax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"><span class="comment">#                                           #</span></span><br><span class="line"><span class="comment">#       PSPNet Backbone Networks            #</span></span><br><span class="line"><span class="comment">#                                           #</span></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">    Implementation of dilated ResNet with deep supervision. Downsampling is changed to 8x</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicBlock</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes, planes, stride=<span class="number">1</span>, downsample=None, dilation=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(BasicBlock, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        self.conv1 = nn.Conv2d(inplanes, planes, kernel_size=<span class="number">3</span>, stride=stride,</span><br><span class="line">                               padding=dilation, dilation=dilation, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>,</span><br><span class="line">                               padding=dilation, dilation=dilation, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        <span class="comment">#out = self.dp(out) # Bottom or Here</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bottleneck</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes, planes, stride=<span class="number">1</span>, downsample=None, dilation=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(Bottleneck, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        elf.conv1 = nn.Conv2d(inplanes, planes, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=stride, dilation=dilation,</span><br><span class="line">                               padding=dilation, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv3 = nn.Conv2d(planes, planes * <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(planes * <span class="number">4</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, block, layers=<span class="params">(<span class="number">3</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">3</span>)</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        self.inplanes = <span class="number">64</span></span><br><span class="line">        super(ResNet, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>,</span><br><span class="line">                               bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(<span class="number">64</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.maxpool = nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.layer1 = self._make_layer(block, <span class="number">64</span>, layers[<span class="number">0</span>], drop_rate=drop_rate)</span><br><span class="line">        self.layer2 = self._make_layer(block, <span class="number">128</span>, layers[<span class="number">1</span>], stride=<span class="number">2</span>,</span><br><span class="line">                                       drop_rate=drop_rate)</span><br><span class="line">        self.layer3 = self._make_layer(block, <span class="number">256</span>, layers[<span class="number">2</span>], stride=<span class="number">1</span>,</span><br><span class="line">                                       dilation=<span class="number">2</span>, drop_rate=drop_rate)</span><br><span class="line">        self.layer4 = self._make_layer(block, <span class="number">512</span>, layers[<span class="number">3</span>], stride=<span class="number">1</span>,</span><br><span class="line">                                       dilation=<span class="number">4</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">                n = m.kernel_size[<span class="number">0</span>] * m.kernel_size[<span class="number">1</span>] * m.out_channels</span><br><span class="line">                m.weight.data.normal_(<span class="number">0</span>, math.sqrt(<span class="number">2.</span> / n))</span><br><span class="line">            <span class="keyword">elif</span> isinstance(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_layer</span><span class="params">(self, block, planes, blocks, stride=<span class="number">1</span>, dilation=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        downsample = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> self.inplanes != planes * block.expansion:</span><br><span class="line">            downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(self.inplanes, planes * block.expansion,</span><br><span class="line">                          kernel_size=<span class="number">1</span>, stride=stride, bias=<span class="keyword">False</span>),</span><br><span class="line">                nn.BatchNorm2d(planes * block.expansion),</span><br><span class="line">                nn.Dropout2d(drop_rate)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        layers = [block(self.inplanes, planes, stride, downsample, drop_rate=drop_rate)]</span><br><span class="line">        self.inplanes = planes * block.expansion</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, blocks):</span><br><span class="line">            layers.append(block(self.inplanes, planes, dilation=dilation, drop_rate=drop_rate))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        x = self.bn1(x)</span><br><span class="line">        x = self.relu(x)</span><br><span class="line">        x = self.maxpool(x)</span><br><span class="line"></span><br><span class="line">        x = self.layer1(x)</span><br><span class="line">        x = self.layer2(x)</span><br><span class="line">        x_3 = self.layer3(x)</span><br><span class="line">        x = self.layer4(x_3)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x, x_3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet18</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = ResNet(BasicBlock, [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], drop_rate=drop_rate)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet34</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = ResNet(BasicBlock, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], drop_rate=drop_rate)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet50</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], drop_rate=drop_rate)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="comment">#                                                   #</span></span><br><span class="line"><span class="comment">#                   PSPNet                          #</span></span><br><span class="line"><span class="comment">#                                                   #</span></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PSPModule</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, features, out_features=<span class="number">1024</span>, sizes=<span class="params">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>)</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.stages = []</span><br><span class="line">        self.stages = nn.ModuleList([self._make_stage(features, size) <span class="keyword">for</span> size <span class="keyword">in</span> sizes])</span><br><span class="line">        self.bottleneck = nn.Conv2d(features * (len(sizes) + <span class="number">1</span>), out_features, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.relu = nn.ReLU()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_stage</span><span class="params">(self, features, size)</span>:</span></span><br><span class="line">        prior = nn.AdaptiveAvgPool2d(output_size=(size, size))</span><br><span class="line">        conv = nn.Conv2d(features, features, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(prior, conv)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, feats)</span>:</span></span><br><span class="line">        h, w = feats.size(<span class="number">2</span>), feats.size(<span class="number">3</span>)</span><br><span class="line">        priors = [F.interpolate(input=stage(feats), size=(h, w),\</span><br><span class="line">                 mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>) <span class="keyword">for</span> stage <span class="keyword">in</span> self.stages] + [feats]</span><br><span class="line">        bottle = self.bottleneck(torch.cat(priors, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> self.relu(bottle)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PSPUpsample</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, out_channels, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.conv = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, out_channels, <span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.BatchNorm2d(out_channels),</span><br><span class="line">            nn.Dropout2d(p=drop_rate),</span><br><span class="line">            nn.PReLU()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        h, w = <span class="number">2</span> * x.size(<span class="number">2</span>), <span class="number">2</span> * x.size(<span class="number">3</span>)</span><br><span class="line">        p = F.interpolate(input=x, size=(h, w), mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">return</span> self.conv(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PSPNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n_classes=<span class="number">2</span>, sizes=<span class="params">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>)</span>, psp_size=<span class="number">2048</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 deep_features_size=<span class="number">1024</span>, backend=<span class="string">'resnet34'</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        <span class="keyword">if</span> backend ==<span class="string">'resnet18'</span>:</span><br><span class="line">            self.feats = resnet18(drop_rate)</span><br><span class="line">        <span class="keyword">elif</span> backend == <span class="string">'resnet34'</span>:</span><br><span class="line">            self.feats = resnet34(drop_rate)</span><br><span class="line">        <span class="keyword">elif</span> backend == <span class="string">'resnet50'</span>:</span><br><span class="line">            self.feats = resnet50(drop_rate)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'backend ERROR'</span>)</span><br><span class="line">        self.psp = PSPModule(psp_size, <span class="number">1024</span>, sizes)</span><br><span class="line">        self.up1 = PSPUpsample(<span class="number">1024</span>, <span class="number">256</span>, drop_rate)</span><br><span class="line">        self.up2 = PSPUpsample(<span class="number">256</span>, <span class="number">64</span>, drop_rate)</span><br><span class="line">        self.up3 = PSPUpsample(<span class="number">64</span>, <span class="number">64</span>, drop_rate)</span><br><span class="line"></span><br><span class="line">        self.final = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">64</span>, n_classes, kernel_size=<span class="number">1</span>),</span><br><span class="line">            nn.LogSoftmax())</span><br><span class="line"></span><br><span class="line">        <span class="comment">#self.classifier = nn.Sequential(</span></span><br><span class="line">        <span class="comment">#    nn.Linear(deep_features_size, 256),</span></span><br><span class="line">        <span class="comment">#    nn.ReLU(),</span></span><br><span class="line">        <span class="comment">#    nn.Linear(256, n_classes))</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment">#f, class_f = self.feats(x)</span></span><br><span class="line">        f, _ = self.feats(x)</span><br><span class="line">        p = self.psp(f)</span><br><span class="line">        p = self.up1(p)</span><br><span class="line">        p = self.up2(p)</span><br><span class="line">        p = self.up3(p)</span><br><span class="line">        <span class="comment">#auxiliary = F.adaptive_max_pool2d(input=class_f, output_size=(1, 1)).\</span></span><br><span class="line">        <span class="comment">#            view(-1, class_f.size(1))</span></span><br><span class="line">        p = self.final(p)</span><br><span class="line">        p = softmax(p, dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> p<span class="comment">#, self.classifier(auxiliary)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pspnet_res18</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PSPNet(sizes=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>), psp_size=<span class="number">512</span>, deep_features_size=<span class="number">256</span>,</span><br><span class="line">                  backend=<span class="string">'resnet18'</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pspnet_res34</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PSPNet(sizes=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>), psp_size=<span class="number">512</span>, deep_features_size=<span class="number">256</span>,</span><br><span class="line">                  backend=<span class="string">'resnet34'</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pspnet_res50</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PSPNet(sizes=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>), psp_size=<span class="number">2048</span>, deep_features_size=<span class="number">1024</span>,</span><br><span class="line">                  backend=<span class="string">'resnet50'</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Resnet18</span></span><br><span class="line">    <span class="comment">#net = pspnet_res18()</span></span><br><span class="line">    <span class="comment"># Resnet34</span></span><br><span class="line">    <span class="comment">#net = pspnet_res34()</span></span><br><span class="line">    <span class="comment"># Resnet50</span></span><br><span class="line">    net = pspnet_res50()</span><br><span class="line"></span><br><span class="line">    net = nn.DataParallel(net)</span><br><span class="line">    net.cuda()</span><br><span class="line"></span><br><span class="line">    x = torch.randn(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1024</span>,<span class="number">1024</span>)</span><br><span class="line">    y = net(x)</span><br><span class="line">    print(y.size())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#test()</span></span><br></pre></td></tr></table></figure>
<h2 id="unet-py"><a href="#unet-py" class="headerlink" title="unet.py"></a>unet.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> torch.nn.functional <span class="keyword">import</span> softmax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv3x3</span><span class="params">(in_c, out_c, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            bias=True, useBN=False, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> useBN:</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">                nn.ReflectionPad2d(padding),</span><br><span class="line">                nn.Conv2d(in_c, out_c, kernel_size, stride, padding=<span class="number">0</span>, bias=bias),</span><br><span class="line">                nn.BatchNorm2d(out_c),</span><br><span class="line">                nn.Dropout2d(p=drop_rate),</span><br><span class="line">                nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">                nn.ReflectionPad2d(padding),</span><br><span class="line">                nn.Conv2d(out_c, out_c, kernel_size, stride, padding=<span class="number">0</span>, bias=bias),</span><br><span class="line">                nn.BatchNorm2d(out_c),</span><br><span class="line">                nn.Dropout2d(p=drop_rate),</span><br><span class="line">                nn.ReLU(inplace=<span class="keyword">True</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">                nn.ReflectionPad2d(padding),</span><br><span class="line">                nn.Conv2d(in_c, out_c, kernel_size, stride, padding=<span class="number">0</span>, bias=bias),</span><br><span class="line">                nn.Dropout2d(p=drop_rate),</span><br><span class="line">                nn.ReLU(),</span><br><span class="line">                nn.ReflectionPad2d(padding),</span><br><span class="line">                nn.Conv2d(out_c, out_c, kernel_size, stride, padding=<span class="number">0</span>, bias=bias),</span><br><span class="line">                nn.Dropout2d(p=drop_rate),</span><br><span class="line">                nn.ReLU())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upsample</span><span class="params">(in_c, out_c, bias=True, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> nn.Sequential(</span><br><span class="line">        <span class="comment">#nn.ReflectionPad2d(1),</span></span><br><span class="line">		nn.ConvTranspose2d(in_c, out_c, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, bias=bias),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channel=<span class="number">1</span>, class_num=<span class="number">2</span>, useBN=False, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(UNet, self).__init__()</span><br><span class="line">        self.output_dim = class_num</span><br><span class="line">        self.drop_rate = drop_rate</span><br><span class="line">        self.conv1 = conv3x3(in_channel, <span class="number">64</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv2 = conv3x3(<span class="number">64</span>, <span class="number">128</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv3 = conv3x3(<span class="number">128</span>, <span class="number">256</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv4 = conv3x3(<span class="number">256</span>, <span class="number">512</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv5 = conv3x3(<span class="number">512</span>, <span class="number">1024</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line"></span><br><span class="line">        self.conv4m = conv3x3(<span class="number">1024</span>, <span class="number">512</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv3m = conv3x3(<span class="number">512</span>, <span class="number">256</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv2m = conv3x3(<span class="number">256</span>, <span class="number">128</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv1m = conv3x3(<span class="number">128</span>, <span class="number">64</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line"></span><br><span class="line">        self.conv0  = nn.Sequential(nn.ReflectionPad2d(<span class="number">1</span>),</span><br><span class="line">                                    nn.Conv2d(<span class="number">64</span>, self.output_dim, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">                                    nn.Dropout2d(p=self.drop_rate),</span><br><span class="line">                                    nn.ReLU())</span><br><span class="line">        self.max_pool = nn.MaxPool2d(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        self.upsample54 = upsample(<span class="number">1024</span>, <span class="number">512</span>, drop_rate=self.drop_rate)</span><br><span class="line">        self.upsample43 = upsample(<span class="number">512</span>, <span class="number">256</span>, drop_rate=self.drop_rate)</span><br><span class="line">        self.upsample32 = upsample(<span class="number">256</span>, <span class="number">128</span>, drop_rate=self.drop_rate)</span><br><span class="line">        self.upsample21 = upsample(<span class="number">128</span>, <span class="number">64</span>, drop_rate=self.drop_rate)</span><br><span class="line"></span><br><span class="line">		<span class="comment">## weight initialization</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d) <span class="keyword">or</span> isinstance(m, nn.ConvTranspose2d):</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                    m.bias.data.zero_()</span><br><span class="line">                nn.init.normal_(m.weight.data, mean=<span class="number">0</span>, std=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        output1 = self.conv1(x)</span><br><span class="line">        output2 = self.conv2(self.max_pool(output1))</span><br><span class="line">        output3 = self.conv3(self.max_pool(output2))</span><br><span class="line">        output4 = self.conv4(self.max_pool(output3))</span><br><span class="line">        output5 = self.conv5(self.max_pool(output4))</span><br><span class="line"></span><br><span class="line">        conv5m_out = torch.cat((self.upsample54(output5), output4), <span class="number">1</span>)</span><br><span class="line">        conv4m_out = self.conv4m(conv5m_out)</span><br><span class="line">        conv4m_out = torch.cat((self.upsample43(output4), output3), <span class="number">1</span>)</span><br><span class="line">        conv3m_out = self.conv3m(conv4m_out)</span><br><span class="line"></span><br><span class="line">        conv3m_out = torch.cat((self.upsample32(output3), output2), <span class="number">1</span>)</span><br><span class="line">        conv2m_out = self.conv2m(conv3m_out)</span><br><span class="line"></span><br><span class="line">        conv2m_out = torch.cat((self.upsample21(output2), output1), <span class="number">1</span>)</span><br><span class="line">        conv1m_out = self.conv1m(conv2m_out)</span><br><span class="line"></span><br><span class="line">        final = self.conv0(conv1m_out)</span><br><span class="line">        final = softmax(final, dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> final</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    net = UNet(class_num=<span class="number">2</span>)</span><br><span class="line">    y = net(torch.randn(<span class="number">3</span>,<span class="number">1</span>,<span class="number">240</span>,<span class="number">240</span>))</span><br><span class="line">    print(y.size())</span><br><span class="line"></span><br><span class="line"><span class="comment">#test()</span></span><br></pre></td></tr></table></figure>
<h1 id="config"><a href="#config" class="headerlink" title="config"></a>config</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># Device Init</span></span><br><span class="line">device = <span class="string">'cuda'</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">'cpu'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Model output shape Init</span></span><br><span class="line">class_num = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Data Handling Parameters</span></span><br><span class="line">complete_threshold = <span class="number">0.05</span></span><br><span class="line">complete_rate = <span class="number">0.66</span></span><br><span class="line"></span><br><span class="line">core_threshold = <span class="number">0.05</span></span><br><span class="line">core_rate = <span class="number">0.66</span></span><br><span class="line"></span><br><span class="line">enhancing_threshold = <span class="number">0.02</span></span><br><span class="line">enhancing_rate = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Data Augmentation Parameters</span></span><br></pre></td></tr></table></figure>
<h1 id="dataset-py"><a href="#dataset-py" class="headerlink" title="dataset.py"></a>dataset.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> PIL</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> accimage</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    accimage = <span class="keyword">None</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader, Dataset</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, PILLOW_VERSION</span><br><span class="line"><span class="keyword">from</span> scipy.ndimage.filters <span class="keyword">import</span> gaussian_filter</span><br><span class="line"><span class="keyword">from</span> scipy.ndimage.interpolation <span class="keyword">import</span> map_coordinates</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data_loader</span><span class="params">(args, mode)</span>:</span></span><br><span class="line">    <span class="comment"># Data Flag Check</span></span><br><span class="line">    <span class="keyword">if</span> args.data == <span class="string">'complete'</span> <span class="keyword">or</span> args.data == <span class="string">'core'</span> <span class="keyword">or</span> args.data == <span class="string">'enhancing'</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'args.data ERROR'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mode Flag Check </span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">'train'</span>:</span><br><span class="line">        shuffle = <span class="keyword">True</span></span><br><span class="line">        dataset = TrainSet(args)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">'valid'</span>:</span><br><span class="line">        shuffle = <span class="keyword">False</span></span><br><span class="line">        dataset = ValidSet(args)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">'test'</span>:</span><br><span class="line">        shuffle = <span class="keyword">False</span></span><br><span class="line">        dataset = TestSet(args)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'data_loader mode ERROR'</span>)</span><br><span class="line"></span><br><span class="line">    dataloader = DataLoader(dataset,</span><br><span class="line">                            batch_size=args.batch_size,</span><br><span class="line">                            num_workers=os.cpu_count(),</span><br><span class="line">                            shuffle=shuffle,</span><br><span class="line">                            drop_last=<span class="keyword">True</span>)</span><br><span class="line">    <span class="keyword">return</span> dataloader</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrainSet</span><span class="params">(torch.utils.data.Dataset)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.data = args.data</span><br><span class="line">        self.img_root = args.img_root</span><br><span class="line">        self.img_path1 = [] <span class="comment"># tumor ratio &gt; 5%</span></span><br><span class="line">        self.img_path2 = [] <span class="comment"># tumor ratio &lt; 5%</span></span><br><span class="line">        self.label_root = args.label_root</span><br><span class="line">        self.label_path1 = []</span><br><span class="line">        self.label_path2 = []</span><br><span class="line"></span><br><span class="line">        self.img_transform = transforms.ColorJitter(brightness=<span class="number">0.2</span>)</span><br><span class="line">        self.transform = Compose([</span><br><span class="line">                    RandomVerticalFlip(),</span><br><span class="line">                    RandomHorizontalFlip(),</span><br><span class="line">                    RandomAffine(degrees=(<span class="number">-20</span>,<span class="number">20</span>),translate=(<span class="number">0.1</span>,<span class="number">0.1</span>),</span><br><span class="line">                                 scale=(<span class="number">0.9</span>,<span class="number">1.1</span>), shear=(<span class="number">-0.2</span>,<span class="number">0.2</span>)),</span><br><span class="line">                    ElasticTransform(alpha=<span class="number">720</span>, sigma=<span class="number">24</span>)])</span><br><span class="line">        self.totensor = transforms.ToTensor()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.data == <span class="string">'complete'</span>:</span><br><span class="line">            self.patch_threshold = config.complete_threshold</span><br><span class="line">            self.data_rate = config.complete_rate</span><br><span class="line">        <span class="keyword">elif</span> self.data == <span class="string">'core'</span>:</span><br><span class="line">            self.patch_threshold = config.core_threshold</span><br><span class="line">            self.data_rate = config.core_rate</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.patch_threshold = config.enhancing_threshold</span><br><span class="line">            self.data_rate = config.core_rate</span><br><span class="line"></span><br><span class="line">        img_path = []</span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.img_root):</span><br><span class="line">            img_path += glob.glob(os.path.join(self.img_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line"></span><br><span class="line">        label_path = []</span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.label_root):</span><br><span class="line">            label_path += glob.glob(os.path.join(self.label_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(img_path)):</span><br><span class="line">            label = cv2.imread(label_path[i], cv2.IMREAD_GRAYSCALE)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.data == <span class="string">'complete'</span>:</span><br><span class="line">                tumor_ratio = (label&gt;<span class="number">25</span>).astype(np.uint8).sum()</span><br><span class="line">            <span class="keyword">elif</span> self.data == <span class="string">'core'</span>:</span><br><span class="line">                l1 = (label&gt;<span class="number">25</span>).astype(np.uint8)</span><br><span class="line">                l2 = (label&lt;<span class="number">75</span>).astype(np.uint8)</span><br><span class="line">                label1 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">                l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">                l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">                label2 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">                tumor_ratio = (np.logical_or(label1,label2).astype(np.uint8)).sum()</span><br><span class="line">                <span class="keyword">del</span> label1, label2</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">                l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">                tumor_ratio = (np.logical_and(l1,l2).astype(np.uint8)).sum()</span><br><span class="line">            tumor_ratio /= label.shape[<span class="number">0</span>]*label.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> tumor_ratio &gt; self.patch_threshold: <span class="comment"># CHANGE FOR ENHANCING</span></span><br><span class="line">                self.label_path2.append(label_path[i])</span><br><span class="line">                self.img_path2.append(img_path[i])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.label_path1.append(label_path[i])</span><br><span class="line">                self.img_path1.append(img_path[i])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Change len (ex. len(img_path2)*1.5)</span></span><br><span class="line">        <span class="keyword">return</span> len(self.img_path1) + len(self.img_path2)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> np.random.choice(<span class="number">2</span>, <span class="number">1</span>, p=[<span class="number">1</span>-self.data_rate, self.data_rate]) == <span class="number">0</span>:</span><br><span class="line">            idx = idx % len(self.img_path1)</span><br><span class="line">            <span class="comment">#idx = np.random.randint(len(self.img_path1))</span></span><br><span class="line">            img_path = self.img_path1[idx]</span><br><span class="line">            label_path = self.label_path1[idx]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            idx = np.random.randint(len(self.img_path2))</span><br><span class="line">            img_path = self.img_path2[idx]</span><br><span class="line">            label_path = self.label_path2[idx]</span><br><span class="line"></span><br><span class="line">        img = cv2.imread(img_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        img = Image.fromarray(img)</span><br><span class="line">        label = cv2.imread(label_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        <span class="keyword">if</span> self.data == <span class="string">'complete'</span>:</span><br><span class="line">            label[label &lt; <span class="number">25</span>] = <span class="number">0</span></span><br><span class="line">            label[label &gt;= <span class="number">25</span>] = <span class="number">1</span></span><br><span class="line">            label = label.astype(np.uint8)</span><br><span class="line">        <span class="keyword">elif</span> self.data == <span class="string">'core'</span>:</span><br><span class="line">            l1 = (label&gt;<span class="number">25</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">75</span>).astype(np.uint8)</span><br><span class="line">            label1 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">            l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">            label2 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">            label = np.logical_or(label1,label2).astype(np.uint8)</span><br><span class="line">            <span class="keyword">del</span> label1, label2</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">            label = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">        label = Image.fromarray(label)</span><br><span class="line">        img, label = self.transform(img,label)</span><br><span class="line">        img = self.img_transform(img)</span><br><span class="line">        label = np.expand_dims(np.array(label), <span class="number">0</span>)</span><br><span class="line">        label = label.astype(np.float32)</span><br><span class="line">        label = np.concatenate((np.absolute(label<span class="number">-1</span>) , label),axis=<span class="number">0</span>)</span><br><span class="line">        label = torch.from_numpy(label)</span><br><span class="line">        <span class="keyword">return</span> self.totensor(img), label, img_path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidSet</span><span class="params">(torch.utils.data.Dataset)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.data = args.data</span><br><span class="line">        self.img_root = args.img_root</span><br><span class="line">        self.img_path = []</span><br><span class="line">        self.label_root = args.label_root</span><br><span class="line">        self.label_path = []</span><br><span class="line">        self.totensor = transforms.ToTensor()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.img_root):</span><br><span class="line">            self.img_path += glob.glob(os.path.join(self.img_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.label_root):</span><br><span class="line">            self.label_path += glob.glob(os.path.join(self.label_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line">        self.img_path = sorted(self.img_path)</span><br><span class="line">        self.label_path = sorted(self.label_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.img_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">        img = cv2.imread(self.img_path[idx], cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        img = Image.fromarray(img)</span><br><span class="line">        label = cv2.imread(self.label_path[idx], cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        <span class="keyword">if</span> self.data == <span class="string">'complete'</span>:</span><br><span class="line">            label[label &lt; <span class="number">25</span>] = <span class="number">0</span></span><br><span class="line">            label[label &gt;= <span class="number">25</span>] = <span class="number">1</span></span><br><span class="line">            label = label.astype(np.uint8)</span><br><span class="line">        <span class="keyword">elif</span> self.data == <span class="string">'core'</span>:</span><br><span class="line">            l1 = (label&gt;<span class="number">25</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">75</span>).astype(np.uint8)</span><br><span class="line">            label1 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">            l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">            label2 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">            label = np.logical_or(label1,label2).astype(np.uint8)</span><br><span class="line">            <span class="keyword">del</span> label1, label2</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">            label = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">        label = Image.fromarray(label)</span><br><span class="line">        label = np.expand_dims(np.array(label), <span class="number">0</span>)</span><br><span class="line">        label = label.astype(np.float32)</span><br><span class="line">        label = np.concatenate((np.absolute(label<span class="number">-1</span>) , label),axis=<span class="number">0</span>)</span><br><span class="line">        label = torch.from_numpy(label)</span><br><span class="line">        <span class="keyword">return</span> self.totensor(img), label, self.img_path[idx]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestSet</span><span class="params">(torch.utils.data.Dataset)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.data = args.data</span><br><span class="line">        self.img_root = args.img_root</span><br><span class="line">        self.img_path = []</span><br><span class="line">        self.totensor = transforms.ToTensor()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.img_root):</span><br><span class="line">            self.img_path += glob.glob(os.path.join(self.img_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line">        self.img_path = sorted(self.img_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.img_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">        img = cv2.imread(self.img_path[idx], cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        img = Image.fromarray(img)</span><br><span class="line">        <span class="keyword">return</span> self.totensor(img), self.img_path[idx]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################################</span></span><br><span class="line"><span class="comment">#                                                           #</span></span><br><span class="line"><span class="comment">#       Data Transforms Functions                           # </span></span><br><span class="line"><span class="comment">#                                                           #</span></span><br><span class="line"><span class="comment">#############################################################</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">    From torchvision Transforms.py (+ Slightly changed)</span></span><br><span class="line"><span class="string">    (https://github.com/pytorch/vision/blob/master/torchvision/transforms/transforms.py)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compose</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Composes several transforms together.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        transforms (list of ``Transform`` objects): list of transforms to compose.</span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; transforms.Compose([</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt;     transforms.CenterCrop(10),</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt;     transforms.ToTensor(),</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; ])</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, transforms)</span>:</span></span><br><span class="line">        self.transforms = transforms</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> self.transforms:</span><br><span class="line">            img,label = t(img, label)</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        format_string = self.__class__.__name__ + <span class="string">'('</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> self.transforms:</span><br><span class="line">            format_string += <span class="string">'\n'</span></span><br><span class="line">            format_string += <span class="string">'    &#123;0&#125;'</span>.format(t)</span><br><span class="line">        format_string += <span class="string">'\n)'</span></span><br><span class="line">        <span class="keyword">return</span> format_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ToTensor</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Convert a ``PIL Image`` or ``numpy.ndarray`` to tensor.</span></span><br><span class="line"><span class="string">    Converts a PIL Image or numpy.ndarray (H x W x C) in the range</span></span><br><span class="line"><span class="string">    [0, 255] to a torch.FloatTensor of shape (C x H x W) in the range [0.0, 1.0].</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, pic, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            pic (PIL Image or numpy.ndarray): Image to be converted to tensor.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Tensor: Converted image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> to_tensor(pic), to_tensor(label)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__class__.__name__ + <span class="string">'()'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomVerticalFlip</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Vertically flip the given PIL Image randomly with a given probability.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        p (float): probability of the image being flipped. Default value is 0.5</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, p=<span class="number">0.5</span>)</span>:</span></span><br><span class="line">        self.p = p</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            img (PIL Image): Image to be flipped.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            PIL Image: Randomly flipped image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; self.p:</span><br><span class="line">            <span class="keyword">return</span> vflip(img), vflip(label)</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__class__.__name__ + <span class="string">'(p=&#123;&#125;)'</span>.format(self.p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomHorizontalFlip</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Horizontally flip the given PIL Image randomly with a given probability.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        p (float): probability of the image being flipped. Default value is 0.5</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, p=<span class="number">0.5</span>)</span>:</span></span><br><span class="line">        self.p = p</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            img (PIL Image): Image to be flipped.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            PIL Image: Randomly flipped image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; self.p:</span><br><span class="line">            <span class="keyword">return</span> hflip(img), hflip(label)</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__class__.__name__ + <span class="string">'(p=&#123;&#125;)'</span>.format(self.p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomRotation</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Rotate the image by angle.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        degrees (sequence or float or int): Range of degrees to select from.</span></span><br><span class="line"><span class="string">            If degrees is a number instead of sequence like (min, max), the range of degrees</span></span><br><span class="line"><span class="string">            will be (-degrees, +degrees).</span></span><br><span class="line"><span class="string">        resample (&#123;PIL.Image.NEAREST, PIL.Image.BILINEAR, PIL.Image.BICUBIC&#125;, optional):</span></span><br><span class="line"><span class="string">            An optional resampling filter. See `filters`_ for more information.</span></span><br><span class="line"><span class="string">            If omitted, or if the image has mode "1" or "P", it is set to PIL.Image.NEAREST.</span></span><br><span class="line"><span class="string">        expand (bool, optional): Optional expansion flag.</span></span><br><span class="line"><span class="string">            If true, expands the output to make it large enough to hold the entire rotated image.</span></span><br><span class="line"><span class="string">            If false or omitted, make the output image the same size as the input image.</span></span><br><span class="line"><span class="string">            Note that the expand flag assumes rotation around the center and no translation.</span></span><br><span class="line"><span class="string">        center (2-tuple, optional): Optional center of rotation.</span></span><br><span class="line"><span class="string">            Origin is the upper left corner.</span></span><br><span class="line"><span class="string">            Default is the center of the image.</span></span><br><span class="line"><span class="string">    .. _filters: https://pillow.readthedocs.io/en/latest/handbook/concepts.html#filters</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, degrees=<span class="number">360</span>, resample=False, expand=False, center=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(degrees, numbers.Number):</span><br><span class="line">            <span class="keyword">if</span> degrees &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"If degrees is a single number, it must be positive."</span>)</span><br><span class="line">            self.degrees = (-degrees, degrees)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> len(degrees) != <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"If degrees is a sequence, it must be of len 2."</span>)</span><br><span class="line">            self.degrees = degrees</span><br><span class="line"></span><br><span class="line">        self.resample = resample</span><br><span class="line">        self.expand = expand</span><br><span class="line">        self.center = center</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_params</span><span class="params">(degrees)</span>:</span></span><br><span class="line">        <span class="string">"""Get parameters for ``rotate`` for a random rotation.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            sequence: params to be passed to ``rotate`` for random rotation.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment">#angle = random.uniform(degrees[0], degrees[1])</span></span><br><span class="line">        angle_list = [<span class="number">0</span>,<span class="number">90</span>,<span class="number">180</span>,<span class="number">270</span>]</span><br><span class="line">        angle = random.choice(angle_list)</span><br><span class="line">        <span class="keyword">return</span> angle</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">            img (PIL Image): Image to be rotated.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            PIL Image: Rotated image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#angle = self.get_params(self.degrees)</span></span><br><span class="line">        angle = np.random.randint(self.degrees[<span class="number">0</span>], self.degrees[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> rotate(img, angle, self.resample, self.expand, self.center),\</span><br><span class="line">                rotate(label, angle, self.resample, self.expand, self.center)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        format_string = self.__class__.__name__ + <span class="string">'(degrees=&#123;0&#125;'</span>.format(self.degrees)</span><br><span class="line">        format_string += <span class="string">', resample=&#123;0&#125;'</span>.format(self.resample)</span><br><span class="line">        format_string += <span class="string">', expand=&#123;0&#125;'</span>.format(self.expand)</span><br><span class="line">        <span class="keyword">if</span> self.center <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            format_string += <span class="string">', center=&#123;0&#125;'</span>.format(self.center)</span><br><span class="line">        format_string += <span class="string">')'</span></span><br><span class="line">        <span class="keyword">return</span> format_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomAffine</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Random affine transformation of the image keeping center invariant</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        degrees (sequence or float or int): Range of degrees to select from.</span></span><br><span class="line"><span class="string">            If degrees is a number instead of sequence like (min, max), the range of degrees</span></span><br><span class="line"><span class="string">            will be (-degrees, +degrees). Set to 0 to deactivate rotations.</span></span><br><span class="line"><span class="string">        translate (tuple, optional): tuple of maximum absolute fraction for horizontal</span></span><br><span class="line"><span class="string">            and vertical translations. For example translate=(a, b), then horizontal shift</span></span><br><span class="line"><span class="string">            is randomly sampled in the range -img_width * a &lt; dx &lt; img_width * a and vertical shift is</span></span><br><span class="line"><span class="string">            randomly sampled in the range -img_height * b &lt; dy &lt; img_height * b. Will not translate by default.</span></span><br><span class="line"><span class="string">        scale (tuple, optional): scaling factor interval, e.g (a, b), then scale is</span></span><br><span class="line"><span class="string">            randomly sampled from the range a &lt;= scale &lt;= b. Will keep original scale by default.</span></span><br><span class="line"><span class="string">        shear (sequence or float or int, optional): Range of degrees to select from.</span></span><br><span class="line"><span class="string">            If degrees is a number instead of sequence like (min, max), the range of degrees</span></span><br><span class="line"><span class="string">            will be (-degrees, +degrees). Will not apply shear by default</span></span><br><span class="line"><span class="string">        resample (&#123;PIL.Image.NEAREST, PIL.Image.BILINEAR, PIL.Image.BICUBIC&#125;, optional):</span></span><br><span class="line"><span class="string">            An optional resampling filter. See `filters`_ for more information.</span></span><br><span class="line"><span class="string">            If omitted, or if the image has mode "1" or "P", it is set to PIL.Image.NEAREST.</span></span><br><span class="line"><span class="string">        fillcolor (int): Optional fill color for the area outside the transform in the output image. (Pillow&gt;=5.0.0)</span></span><br><span class="line"><span class="string">    .. _filters: https://pillow.readthedocs.io/en/latest/handbook/concepts.html#filters</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, degrees, translate=None, scale=None, shear=None, resample=False, fillcolor=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(degrees, numbers.Number):</span><br><span class="line">            <span class="keyword">if</span> degrees &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"If degrees is a single number, it must be positive."</span>)</span><br><span class="line">            self.degrees = (-degrees, degrees)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span> isinstance(degrees, (tuple, list)) <span class="keyword">and</span> len(degrees) == <span class="number">2</span>, \</span><br><span class="line">                <span class="string">"degrees should be a list or tuple and it must be of length 2."</span></span><br><span class="line">            self.degrees = degrees</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> translate <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">assert</span> isinstance(translate, (tuple, list)) <span class="keyword">and</span> len(translate) == <span class="number">2</span>, \</span><br><span class="line">                <span class="string">"translate should be a list or tuple and it must be of length 2."</span></span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> translate:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0.0</span> &lt;= t &lt;= <span class="number">1.0</span>):</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">"translation values should be between 0 and 1"</span>)</span><br><span class="line">        self.translate = translate</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> scale <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">assert</span> isinstance(scale, (tuple, list)) <span class="keyword">and</span> len(scale) == <span class="number">2</span>, \</span><br><span class="line">                <span class="string">"scale should be a list or tuple and it must be of length 2."</span></span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> scale:</span><br><span class="line">                <span class="keyword">if</span> s &lt;= <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">"scale values should be positive"</span>)</span><br><span class="line">        self.scale = scale</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> shear <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(shear, numbers.Number):</span><br><span class="line">                <span class="keyword">if</span> shear &lt; <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">"If shear is a single number, it must be positive."</span>)</span><br><span class="line">                self.shear = (-shear, shear)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">assert</span> isinstance(shear, (tuple, list)) <span class="keyword">and</span> len(shear) == <span class="number">2</span>, \</span><br><span class="line">                    <span class="string">"shear should be a list or tuple and it must be of length 2."</span></span><br><span class="line">                self.shear = shear</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.shear = shear</span><br><span class="line"></span><br><span class="line">        self.resample = resample</span><br><span class="line">        self.fillcolor = fillcolor</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_params</span><span class="params">(degrees, translate, scale_ranges, shears, img_size)</span>:</span></span><br><span class="line">        <span class="string">"""Get parameters for affine transformation</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            sequence: params to be passed to the affine transformation</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        angle = random.uniform(degrees[<span class="number">0</span>], degrees[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> translate <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            max_dx = translate[<span class="number">0</span>] * img_size[<span class="number">0</span>]</span><br><span class="line">            max_dy = translate[<span class="number">1</span>] * img_size[<span class="number">1</span>]</span><br><span class="line">            translations = (np.round(random.uniform(-max_dx, max_dx)),</span><br><span class="line">                            np.round(random.uniform(-max_dy, max_dy)))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            translations = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> scale_ranges <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            scale = random.uniform(scale_ranges[<span class="number">0</span>], scale_ranges[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            scale = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> shears <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            shear = random.uniform(shears[<span class="number">0</span>], shears[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shear = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> angle, translations, scale, shear</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">            img (PIL Image): Image to be transformed.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            PIL Image: Affine transformed image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ret = self.get_params(self.degrees, self.translate, self.scale, self.shear, img.size)</span><br><span class="line">        <span class="keyword">return</span> affine(img, label, *ret, resample=self.resample, fillcolor=self.fillcolor)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="string">'&#123;name&#125;(degrees=&#123;degrees&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.translate <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            s += <span class="string">', translate=&#123;translate&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.scale <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            s += <span class="string">', scale=&#123;scale&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.shear <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            s += <span class="string">', shear=&#123;shear&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.resample &gt; <span class="number">0</span>:</span><br><span class="line">            s += <span class="string">', resample=&#123;resample&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.fillcolor != <span class="number">0</span>:</span><br><span class="line">            s += <span class="string">', fillcolor=&#123;fillcolor&#125;'</span></span><br><span class="line">        s += <span class="string">')'</span></span><br><span class="line">        d = dict(self.__dict__)</span><br><span class="line">        d[<span class="string">'resample'</span>] = _pil_interpolation_to_str[d[<span class="string">'resample'</span>]]</span><br><span class="line">        <span class="keyword">return</span> s.format(name=self.__class__.__name__, **d)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">    From torchvision functional.py (+ Slightly changed)</span></span><br><span class="line"><span class="string">    (https://github.com/pytorch/vision/blob/master/torchvision/transforms/functional.py)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_is_pil_image</span><span class="params">(img)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> accimage <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span> isinstance(img, (Image.Image, accimage.Image))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> isinstance(img, Image.Image)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_tensor</span><span class="params">(pic)</span>:</span></span><br><span class="line">    <span class="string">"""Convert a ``PIL Image`` or ``numpy.ndarray`` to tensor.</span></span><br><span class="line"><span class="string">    See ``ToTensor`` for more details.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pic (PIL Image or numpy.ndarray): Image to be converted to tensor.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Tensor: Converted image.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span>(_is_pil_image(pic) <span class="keyword">or</span> _is_numpy_image(pic)):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'pic should be PIL Image or ndarray. Got &#123;&#125;'</span>.format(type(pic)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> isinstance(pic, np.ndarray):</span><br><span class="line">        <span class="comment"># handle numpy array</span></span><br><span class="line">        img = torch.from_numpy(pic.transpose((<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)))</span><br><span class="line">        <span class="comment"># backward compatibility</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(img, torch.ByteTensor):</span><br><span class="line">            <span class="keyword">return</span> img.float().div(<span class="number">255</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> accimage <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> isinstance(pic, accimage.Image):</span><br><span class="line">        nppic = np.zeros([pic.channels, pic.height, pic.width], dtype=np.float32)</span><br><span class="line">        pic.copyto(nppic)</span><br><span class="line">        <span class="keyword">return</span> torch.from_numpy(nppic)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># handle PIL Image</span></span><br><span class="line">    <span class="keyword">if</span> pic.mode == <span class="string">'I'</span>:</span><br><span class="line">        img = torch.from_numpy(np.array(pic, np.int32, copy=<span class="keyword">False</span>))</span><br><span class="line">    <span class="keyword">elif</span> pic.mode == <span class="string">'I;16'</span>:</span><br><span class="line">        img = torch.from_numpy(np.array(pic, np.int16, copy=<span class="keyword">False</span>))</span><br><span class="line">    <span class="keyword">elif</span> pic.mode == <span class="string">'F'</span>:</span><br><span class="line">        img = torch.from_numpy(np.array(pic, np.float32, copy=<span class="keyword">False</span>))</span><br><span class="line">    <span class="keyword">elif</span> pic.mode == <span class="string">'1'</span>:</span><br><span class="line">        img = <span class="number">255</span> * torch.from_numpy(np.array(pic, np.uint8, copy=<span class="keyword">False</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        img = torch.ByteTensor(torch.ByteStorage.from_buffer(pic.tobytes()))</span><br><span class="line">    <span class="comment"># PIL image mode: L, P, I, F, RGB, YCbCr, RGBA, CMYK</span></span><br><span class="line">    <span class="keyword">if</span> pic.mode == <span class="string">'YCbCr'</span>:</span><br><span class="line">        nchannel = <span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> pic.mode == <span class="string">'I;16'</span>:</span><br><span class="line">        nchannel = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        nchannel = len(pic.mode)</span><br><span class="line">    img = img.view(pic.size[<span class="number">1</span>], pic.size[<span class="number">0</span>], nchannel)</span><br><span class="line">    <span class="comment"># put it from HWC to CHW format</span></span><br><span class="line">    <span class="comment"># yikes, this transpose takes 80% of the loading time/CPU</span></span><br><span class="line">    img = img.transpose(<span class="number">0</span>, <span class="number">1</span>).transpose(<span class="number">0</span>, <span class="number">2</span>).contiguous()</span><br><span class="line">    <span class="keyword">if</span> isinstance(img, torch.ByteTensor):</span><br><span class="line">        <span class="keyword">return</span> img.float().div(<span class="number">255</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vflip</span><span class="params">(img)</span>:</span></span><br><span class="line">    <span class="string">"""Vertically flip the given PIL Image.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img (PIL Image): Image to be flipped.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        PIL Image:  Vertically flipped image.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_pil_image(img):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'img should be PIL Image. Got &#123;&#125;'</span>.format(type(img)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img.transpose(Image.FLIP_TOP_BOTTOM)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hflip</span><span class="params">(img)</span>:</span></span><br><span class="line">    <span class="string">"""Horizontally flip the given PIL Image.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img (PIL Image): Image to be flipped.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        PIL Image:  Horizontall flipped image.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_pil_image(img):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'img should be PIL Image. Got &#123;&#125;'</span>.format(type(img)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img.transpose(Image.FLIP_LEFT_RIGHT)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rotate</span><span class="params">(img, angle, resample=False, expand=False, center=None)</span>:</span></span><br><span class="line">    <span class="string">"""Rotate the image by angle.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img (PIL Image): PIL Image to be rotated.</span></span><br><span class="line"><span class="string">        angle (float or int): In degrees degrees counter clockwise order.</span></span><br><span class="line"><span class="string">        resample (``PIL.Image.NEAREST`` or ``PIL.Image.BILINEAR`` or ``PIL.Image.BICUBIC``, optional):</span></span><br><span class="line"><span class="string">            An optional resampling filter. See `filters`_ for more information.</span></span><br><span class="line"><span class="string">            If omitted, or if the image has mode "1" or "P", it is set to ``PIL.Image.NEAREST``.</span></span><br><span class="line"><span class="string">        expand (bool, optional): Optional expansion flag.</span></span><br><span class="line"><span class="string">            If true, expands the output image to make it large enough to hold the entire rotated image.</span></span><br><span class="line"><span class="string">            If false or omitted, make the output image the same size as the input image.</span></span><br><span class="line"><span class="string">            Note that the expand flag assumes rotation around the center and no translation.</span></span><br><span class="line"><span class="string">        center (2-tuple, optional): Optional center of rotation.</span></span><br><span class="line"><span class="string">            Origin is the upper left corner.</span></span><br><span class="line"><span class="string">            Default is the center of the image.</span></span><br><span class="line"><span class="string">    .. _filters: https://pillow.readthedocs.io/en/latest/handbook/concepts.html#filters</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_pil_image(img):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'img should be PIL Image. Got &#123;&#125;'</span>.format(type(img)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img.rotate(angle, resample, expand, center)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_inverse_affine_matrix</span><span class="params">(center, angle, translate, scale, shear)</span>:</span></span><br><span class="line">    <span class="comment"># Helper method to compute inverse matrix for affine transformation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># As it is explained in PIL.Image.rotate</span></span><br><span class="line">    <span class="comment"># We need compute INVERSE of affine transformation matrix: M = T * C * RSS * C^-1</span></span><br><span class="line">    <span class="comment"># where T is translation matrix: [1, 0, tx | 0, 1, ty | 0, 0, 1]</span></span><br><span class="line">    <span class="comment">#       C is translation matrix to keep center: [1, 0, cx | 0, 1, cy | 0, 0, 1]</span></span><br><span class="line">    <span class="comment">#       RSS is rotation with scale and shear matrix</span></span><br><span class="line">    <span class="comment">#       RSS(a, scale, shear) = [ cos(a)*scale    -sin(a + shear)*scale     0]</span></span><br><span class="line">    <span class="comment">#                              [ sin(a)*scale    cos(a + shear)*scale     0]</span></span><br><span class="line">    <span class="comment">#                              [     0                  0          1]</span></span><br><span class="line">    <span class="comment"># Thus, the inverse is M^-1 = C * RSS^-1 * C^-1 * T^-1</span></span><br><span class="line"></span><br><span class="line">    angle = math.radians(angle)</span><br><span class="line">    shear = math.radians(shear)</span><br><span class="line">    scale = <span class="number">1.0</span> / scale</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Inverted rotation matrix with scale and shear</span></span><br><span class="line">    d = math.cos(angle + shear) * math.cos(angle) + math.sin(angle + shear) * math.sin(angle)</span><br><span class="line">    matrix = [</span><br><span class="line">        math.cos(angle + shear), math.sin(angle + shear), <span class="number">0</span>,</span><br><span class="line">        -math.sin(angle), math.cos(angle), <span class="number">0</span></span><br><span class="line">    ]</span><br><span class="line">    matrix = [scale / d * m <span class="keyword">for</span> m <span class="keyword">in</span> matrix]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Apply inverse of translation and of center translation: RSS^-1 * C^-1 * T^-1</span></span><br><span class="line">    matrix[<span class="number">2</span>] += matrix[<span class="number">0</span>] * (-center[<span class="number">0</span>] - translate[<span class="number">0</span>]) + matrix[<span class="number">1</span>] * (-center[<span class="number">1</span>] - translate[<span class="number">1</span>])</span><br><span class="line">    matrix[<span class="number">5</span>] += matrix[<span class="number">3</span>] * (-center[<span class="number">0</span>] - translate[<span class="number">0</span>]) + matrix[<span class="number">4</span>] * (-center[<span class="number">1</span>] - translate[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Apply center translation: C * RSS^-1 * C^-1 * T^-1</span></span><br><span class="line">    matrix[<span class="number">2</span>] += center[<span class="number">0</span>]</span><br><span class="line">    matrix[<span class="number">5</span>] += center[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> matrix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">affine</span><span class="params">(img, label, angle, translate, scale, shear, resample=<span class="number">0</span>, fillcolor=None)</span>:</span></span><br><span class="line">    <span class="string">"""Apply affine transformation on the image keeping image center invariant</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img (PIL Image): PIL Image to be rotated.</span></span><br><span class="line"><span class="string">        angle (float or int): rotation angle in degrees between -180 and 180, clockwise direction.</span></span><br><span class="line"><span class="string">        translate (list or tuple of integers): horizontal and vertical translations(post-rotation translation)</span></span><br><span class="line"><span class="string">        scale (float): overall scale</span></span><br><span class="line"><span class="string">        shear (float): shear angle value in degrees between -180 to 180, clockwise direction.</span></span><br><span class="line"><span class="string">        resample (``PIL.Image.NEAREST`` or ``PIL.Image.BILINEAR`` or ``PIL.Image.BICUBIC``, optional):</span></span><br><span class="line"><span class="string">            An optional resampling filter.</span></span><br><span class="line"><span class="string">            See `filters`_ for more information.</span></span><br><span class="line"><span class="string">            If omitted, or if the image has mode "1" or "P", it is set to ``PIL.Image.NEAREST``.</span></span><br><span class="line"><span class="string">        fillcolor (int): Optional fill color for the area outside the transform in the output image. (Pillow&gt;=5.0.0)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_pil_image(img):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'img should be PIL Image. Got &#123;&#125;'</span>.format(type(img)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> isinstance(translate, (tuple, list)) <span class="keyword">and</span> len(translate) == <span class="number">2</span>, \</span><br><span class="line">        <span class="string">"Argument translate should be a list or tuple of length 2"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> scale &gt; <span class="number">0.0</span>, <span class="string">"Argument scale should be positive"</span></span><br><span class="line"></span><br><span class="line">    output_size = img.size</span><br><span class="line">    center = (img.size[<span class="number">0</span>] * <span class="number">0.5</span> + <span class="number">0.5</span>, img.size[<span class="number">1</span>] * <span class="number">0.5</span> + <span class="number">0.5</span>)</span><br><span class="line">    matrix = _get_inverse_affine_matrix(center, angle, translate, scale, shear)</span><br><span class="line">    kwargs = &#123;<span class="string">"fillcolor"</span>: fillcolor&#125; <span class="keyword">if</span> PILLOW_VERSION[<span class="number">0</span>] == <span class="string">'5'</span> <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> img.transform(output_size, Image.AFFINE, matrix, resample, **kwargs),\</span><br><span class="line">            label.transform(output_size, Image.AFFINE, matrix, resample, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">	source code From.</span></span><br><span class="line"><span class="string">	https://gist.github.com/oeway/2e3b989e0343f0884388ed7ed82eb3b0</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ElasticTransform</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Apply elastic transformation on a numpy.ndarray (H x W x C)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, alpha, sigma)</span>:</span></span><br><span class="line">        self.alpha = alpha</span><br><span class="line">        self.sigma = sigma</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, image, label)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(self.alpha, collections.Sequence):</span><br><span class="line">            alpha = random_num_generator(self.alpha)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            alpha = self.alpha</span><br><span class="line">        <span class="keyword">if</span> isinstance(self.sigma, collections.Sequence):</span><br><span class="line">            sigma = random_num_generator(self.sigma)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sigma = self.sigma</span><br><span class="line">        <span class="keyword">return</span> elastic_transform(image, label, alpha=alpha, sigma=sigma)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">elastic_transform</span><span class="params">(image, label, alpha=<span class="number">1000</span>, sigma=<span class="number">30</span>, spline_order=<span class="number">1</span>, mode=<span class="string">'nearest'</span>, random_state=np.random)</span>:</span></span><br><span class="line">    <span class="string">"""Elastic deformation of image as described in [Simard2003]_.</span></span><br><span class="line"><span class="string">    .. [Simard2003] Simard, Steinkraus and Platt, "Best Practices for</span></span><br><span class="line"><span class="string">       Convolutional Neural Networks applied to Visual Document Analysis", in</span></span><br><span class="line"><span class="string">       Proc. of the International Conference on Document Analysis and</span></span><br><span class="line"><span class="string">       Recognition, 2003.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment">#assert image.ndim == 3</span></span><br><span class="line">    image = np.array(image)</span><br><span class="line">    label = np.array(label)</span><br><span class="line">    shape = image.shape[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    dx = gaussian_filter((random_state.rand(*shape) * <span class="number">2</span> - <span class="number">1</span>),</span><br><span class="line">                         sigma, mode=<span class="string">"constant"</span>, cval=<span class="number">0</span>) * alpha</span><br><span class="line">    dy = gaussian_filter((random_state.rand(*shape) * <span class="number">2</span> - <span class="number">1</span>),</span><br><span class="line">                         sigma, mode=<span class="string">"constant"</span>, cval=<span class="number">0</span>) * alpha</span><br><span class="line"></span><br><span class="line">    x, y = np.meshgrid(np.arange(shape[<span class="number">0</span>]), np.arange(shape[<span class="number">1</span>]), indexing=<span class="string">'ij'</span>)</span><br><span class="line">    indices = [np.reshape(x + dx, (<span class="number">-1</span>, <span class="number">1</span>)), np.reshape(y + dy, (<span class="number">-1</span>, <span class="number">1</span>))]</span><br><span class="line"></span><br><span class="line">    result1 = map_coordinates(image, indices, order=spline_order, mode=mode).reshape(shape)</span><br><span class="line">    result2 = map_coordinates(label, indices, order=spline_order, mode=mode).reshape(shape)</span><br><span class="line">    <span class="keyword">return</span> Image.fromarray(result1), Image.fromarray(result2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_num_generator</span><span class="params">(config, random_state=np.random)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> config[<span class="number">0</span>] == <span class="string">'uniform'</span>:</span><br><span class="line">        ret = random_state.uniform(config[<span class="number">1</span>], config[<span class="number">2</span>], <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">elif</span> config[<span class="number">0</span>] == <span class="string">'lognormal'</span>:</span><br><span class="line">        ret = random_state.lognormal(config[<span class="number">1</span>], config[<span class="number">2</span>], <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(config)</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'unsupported format'</span>)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>
<h1 id="preprocess-py"><a href="#preprocess-py" class="headerlink" title="preprocess.py"></a>preprocess.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> nibabel <span class="keyword">as</span> nib</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> LabelBinarizer</span><br><span class="line"></span><br><span class="line">IMG_ROOT = <span class="string">'./Task01_BrainTumor/imagesTr'</span></span><br><span class="line">IMG_PATH = <span class="string">'./Task01_BrainTumor/imagesTr/BRATS_148.nii.gz'</span></span><br><span class="line">IMG_OUTPUT_ROOT = <span class="string">'./train/image_T1'</span></span><br><span class="line"></span><br><span class="line">LABEL_ROOT = <span class="string">'./Task01_BrainTumor/labelsTr'</span></span><br><span class="line">IABEL_PATH = <span class="string">'./Task01_BrainTumor/labelsTr/BRATS_148.nii.gz'</span></span><br><span class="line">LABEL_OUTPUT_ROOT = <span class="string">'./train/label'</span></span><br><span class="line"></span><br><span class="line">L0 = <span class="number">0</span>      <span class="comment"># Background</span></span><br><span class="line">L1 = <span class="number">50</span>     <span class="comment"># Necrotic and Non-enhancing Tumor</span></span><br><span class="line">L2 = <span class="number">100</span>    <span class="comment"># Edema</span></span><br><span class="line">L3 = <span class="number">150</span>    <span class="comment"># Enhancing Tumor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MRI Image channels Description</span></span><br><span class="line"><span class="comment"># ch0: FLAIR / ch1: T1 / ch2: T1c/ ch3: T2</span></span><br><span class="line"><span class="comment"># cf) In this project, we use FLAIR and T1c MRI dataset</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># Data Load Example</span></span><br><span class="line"><span class="comment">#img = nib.load(IMG_PATH)</span></span><br><span class="line"><span class="comment">#img = (img.get_fdata())[:,:,:,3]                # img shape = (240,240,155)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MRI Label Channels Description</span></span><br><span class="line"><span class="comment"># 0: Background         / 1: Necrotic and non-enhancing tumor (paper, 1+3)</span></span><br><span class="line"><span class="comment"># 2: edema (paper, 2)   / 3: Enhancing tumor (paper, 4)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># &lt;Input&gt;           &lt;Prediction&gt;</span></span><br><span class="line"><span class="comment"># FLAIR             Complete(1,2,3)</span></span><br><span class="line"><span class="comment"># FLAIR             Core(1,3)</span></span><br><span class="line"><span class="comment"># T1c               Enhancing(3)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Data Load Example</span></span><br><span class="line"><span class="comment"># label = nib.load(LABEL_PATH)</span></span><br><span class="line"><span class="comment"># label = (label.get_fdata()).astype(np.uint16)   # label shape = (240,240,155)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nii2jpg_img</span><span class="params">(img_path, output_root)</span>:</span></span><br><span class="line">    img_name = (img_path.split(<span class="string">'/'</span>)[<span class="number">-1</span>]).split(<span class="string">'.'</span>)[<span class="number">0</span>]</span><br><span class="line">    output_path = os.path.join(output_root, img_name)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(output_root)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(output_path)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    img = nib.load(img_path)</span><br><span class="line">    img = (img.get_fdata())[:,:,:,<span class="number">1</span>]</span><br><span class="line">    img = (img/img.max())*<span class="number">255</span></span><br><span class="line">    img = img.astype(np.uint8)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(img.shape[<span class="number">2</span>]):</span><br><span class="line">        filename = os.path.join(output_path, img_name+<span class="string">'_'</span>+str(i)+<span class="string">'.jpg'</span>)</span><br><span class="line">        gray_img = img[:,:,i]</span><br><span class="line">        <span class="comment">#color_img = np.expand_dims(gray_img, 3)</span></span><br><span class="line">        <span class="comment">#color_img = np.concatenate([color_img, color_img, color_img], 2)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># COLOR LABELING</span></span><br><span class="line">        <span class="comment">#c255 = np.expand_dims(np.ones(gray_img.shape)*255, 3)</span></span><br><span class="line">        <span class="comment">#c0 = np.expand_dims(np.zeros(gray_img.shape), 3)</span></span><br><span class="line">        <span class="comment">#color = np.concatenate([c0,c0,c255], 2)</span></span><br><span class="line">        <span class="comment">#color_img = color_img.astype(np.float32) + color</span></span><br><span class="line">        <span class="comment">#color_img = (color_img / color_img.max()) *255</span></span><br><span class="line"></span><br><span class="line">        cv2.imwrite(filename, gray_img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nii2jpg_label</span><span class="params">(img_path, output_root)</span>:</span></span><br><span class="line">    img_name = (img_path.split(<span class="string">'/'</span>)[<span class="number">-1</span>]).split(<span class="string">'.'</span>)[<span class="number">0</span>]</span><br><span class="line">    output_path = os.path.join(output_root, img_name)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(output_root)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(output_path)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    img = nib.load(img_path)</span><br><span class="line">    img = (img.get_fdata())[:,:,:]</span><br><span class="line">    pdb.set_trace()</span><br><span class="line">    img = img*<span class="number">50</span></span><br><span class="line">    img = img.astype(np.uint8)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(img.shape[<span class="number">2</span>]):</span><br><span class="line">        filename = os.path.join(output_path, img_name+<span class="string">'_'</span>+str(i)+<span class="string">'.jpg'</span>)</span><br><span class="line">        gray_img = img[:,:,i]</span><br><span class="line">        <span class="comment">#color_img = np.expand_dims(gray_img, 3)</span></span><br><span class="line">        <span class="comment">#color_img = np.concatenate([color_img, color_img, color_img], 2)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># COLOR LABELING</span></span><br><span class="line">        <span class="comment">#c255 = np.expand_dims(np.ones(gray_img.shape)*255, 3)</span></span><br><span class="line">        <span class="comment">#c0 = np.expand_dims(np.zeros(gray_img.shape), 3)</span></span><br><span class="line">        <span class="comment">#color = np.concatenate([c0,c0,c255], 2)</span></span><br><span class="line">        <span class="comment">#color_img = color_img.astype(np.float32) + color</span></span><br><span class="line">        <span class="comment">#color_img = (color_img / color_img.max()) *255</span></span><br><span class="line"></span><br><span class="line">        cv2.imwrite(filename, gray_img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> path <span class="keyword">in</span> os.listdir(IMG_ROOT):</span><br><span class="line">    print(path)</span><br><span class="line">    <span class="keyword">if</span> path[<span class="number">0</span>] == <span class="string">'.'</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    nii2jpg_img(os.path.join(IMG_ROOT,path), IMG_OUTPUT_ROOT)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">for path in os.listdir(LABEL_ROOT):</span></span><br><span class="line"><span class="string">    print(path)</span></span><br><span class="line"><span class="string">    if path[0] == '.':</span></span><br><span class="line"><span class="string">        continue</span></span><br><span class="line"><span class="string">    nii2jpg_label(os.path.join(LABEL_ROOT,path), LABEL_OUTPUT_ROOT)</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<h1 id="trian-py"><a href="#trian-py" class="headerlink" title="trian.py"></a>trian.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.backends.cudnn <span class="keyword">as</span> cudnn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> dataset <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(args)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Variables and logger Init</span></span><br><span class="line">    device = config.device</span><br><span class="line">    cudnn.benchmark = <span class="keyword">True</span></span><br><span class="line">    get_logger()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Data Load</span></span><br><span class="line">    trainloader = data_loader(args, mode=<span class="string">'train'</span>)</span><br><span class="line">    validloader = data_loader(args, mode=<span class="string">'valid'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model Load</span></span><br><span class="line">    net, optimizer, best_score, start_epoch =\</span><br><span class="line">        load_model(args, class_num=config.class_num, mode=<span class="string">'train'</span>)</span><br><span class="line">    log_msg = <span class="string">'\n'</span>.join([<span class="string">'%s Train Start'</span>%(args.model)])</span><br><span class="line">    logging.info(log_msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(start_epoch, start_epoch+args.epochs):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Train Model</span></span><br><span class="line">        print(<span class="string">'\n\n\nEpoch: &#123;&#125;\n&lt;Train&gt;'</span>.format(epoch))</span><br><span class="line">        net.train(<span class="keyword">True</span>)</span><br><span class="line">        loss = <span class="number">0</span></span><br><span class="line">        lr = args.lr * (<span class="number">0.5</span> ** (epoch // <span class="number">4</span>))</span><br><span class="line">        <span class="keyword">for</span> param_group <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            param_group[<span class="string">"lr"</span>] = lr</span><br><span class="line">        torch.set_grad_enabled(<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">for</span> idx, (inputs, targets, paths) <span class="keyword">in</span> enumerate(trainloader):</span><br><span class="line">            inputs, targets = inputs.to(device), targets.to(device)</span><br><span class="line">            outputs = net(inputs)</span><br><span class="line">            <span class="keyword">if</span> type(outputs) == tuple:</span><br><span class="line">                outputs = outputs[<span class="number">0</span>]</span><br><span class="line">            batch_loss = dice_coef(outputs, targets)</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            batch_loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            loss += float(batch_loss)</span><br><span class="line">            progress_bar(idx, len(trainloader), <span class="string">'Loss: %.5f, Dice-Coef: %.5f'</span></span><br><span class="line">                         %((loss/(idx+<span class="number">1</span>)), (<span class="number">1</span>-(loss/(idx+<span class="number">1</span>)))))</span><br><span class="line">        log_msg = <span class="string">'\n'</span>.join([<span class="string">'Epoch: %d  Loss: %.5f,  Dice-Coef:  %.5f'</span>\</span><br><span class="line">                         %(epoch, loss/(idx+<span class="number">1</span>), <span class="number">1</span>-(loss/(idx+<span class="number">1</span>)))])</span><br><span class="line">        logging.info(log_msg)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Validate Model</span></span><br><span class="line">        print(<span class="string">'\n\n&lt;Validation&gt;'</span>)</span><br><span class="line">        net.eval()</span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> net.module.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(module, torch.nn.modules.Dropout2d):</span><br><span class="line">                module.train(<span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">elif</span> isinstance(module, torch.nn.modules.Dropout):</span><br><span class="line">                module.train(<span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        loss = <span class="number">0</span></span><br><span class="line">        torch.set_grad_enabled(<span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">for</span> idx, (inputs, targets, paths) <span class="keyword">in</span> enumerate(validloader):</span><br><span class="line">            inputs, targets = inputs.to(device), targets.to(device)</span><br><span class="line">            outputs = net(inputs)</span><br><span class="line">            <span class="keyword">if</span> type(outputs) == tuple:</span><br><span class="line">                outputs = outputs[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">#outputs = post_process(args, inputs, outputs, save=False)</span></span><br><span class="line">            batch_loss = dice_coef(outputs, targets, backprop=<span class="keyword">False</span>)</span><br><span class="line">            loss += float(batch_loss)</span><br><span class="line">            progress_bar(idx, len(validloader), <span class="string">'Loss: %.5f, Dice-Coef: %.5f'</span></span><br><span class="line">                         %((loss/(idx+<span class="number">1</span>)), (<span class="number">1</span>-(loss/(idx+<span class="number">1</span>)))))</span><br><span class="line">        log_msg = <span class="string">'\n'</span>.join([<span class="string">'Epoch: %d  Loss: %.5f,  Dice-Coef:  %.5f'</span></span><br><span class="line">                        %(epoch, loss/(idx+<span class="number">1</span>), <span class="number">1</span>-(loss/(idx+<span class="number">1</span>)))])</span><br><span class="line">        logging.info(log_msg)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Save Model</span></span><br><span class="line">        loss /= (idx+<span class="number">1</span>)</span><br><span class="line">        score = <span class="number">1</span> - loss</span><br><span class="line">        <span class="keyword">if</span> score &gt; best_score:</span><br><span class="line">            checkpoint = Checkpoint(net, optimizer, epoch, score)</span><br><span class="line">            checkpoint.save(os.path.join(args.ckpt_root, args.model+<span class="string">'.tar'</span>))</span><br><span class="line">            best_score = score</span><br><span class="line">            print(<span class="string">"Saving..."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=__doc__)</span><br><span class="line">    parser.add_argument(<span class="string">"--resume"</span>, type=bool, default=<span class="keyword">False</span>,</span><br><span class="line">                        help=<span class="string">"Model Trianing resume."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--model"</span>, type=str, default=<span class="string">'pspnet_res50'</span>,</span><br><span class="line">                        help=<span class="string">"Model Name (unet, pspnet_squeeze, pspnet_res50,\</span></span><br><span class="line"><span class="string">                        pspnet_res34, pspnet_res50, deeplab)"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--in_channel"</span>, type=int, default=<span class="number">1</span>,</span><br><span class="line">                        help=<span class="string">"A number of images to use for input"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--batch_size"</span>, type=int, default=<span class="number">80</span>,</span><br><span class="line">                        help=<span class="string">"The batch size to load the data"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--epochs"</span>, type=int, default=<span class="number">30</span>,</span><br><span class="line">                        help=<span class="string">"The training epochs to run."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--drop_rate"</span>, type=float, default=<span class="number">0.1</span>,</span><br><span class="line">                        help=<span class="string">"Drop-out Rate"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--lr"</span>, type=float, default=<span class="number">0.001</span>,</span><br><span class="line">                        help=<span class="string">"Learning rate to use in training"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--data"</span>, type=str, default=<span class="string">"complete"</span>,</span><br><span class="line">                        help=<span class="string">"Label data type."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--img_root"</span>, type=str, default=<span class="string">"../../data/train/image_FLAIR"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the training image dataset."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--label_root"</span>, type=str, default=<span class="string">"../../data/train/label"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the training label datgaset"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--output_root"</span>, type=str, default=<span class="string">"./output/prediction"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the result predictions"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--ckpt_root"</span>, type=str, default=<span class="string">"./checkpoint"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the checkpoint files"</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    train(args)</span><br></pre></td></tr></table></figure>
<h1 id="utils-py"><a href="#utils-py" class="headerlink" title="utils.py"></a>utils.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> nibabel <span class="keyword">as</span> nib</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"><span class="keyword">import</span> pydensecrf.densecrf <span class="keyword">as</span> dcrf</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydensecrf.utils <span class="keyword">import</span> compute_unary, create_pairwise_bilateral,\</span><br><span class="line">         create_pairwise_gaussian, softmax_to_unary, unary_from_softmax</span><br><span class="line"></span><br><span class="line">_, term_width = os.popen(<span class="string">'stty size'</span>, <span class="string">'r'</span>).read().split()</span><br><span class="line">term_width = int(term_width)</span><br><span class="line"></span><br><span class="line">TOTAL_BAR_LENGTH = <span class="number">65.</span></span><br><span class="line">last_time = time.time()</span><br><span class="line">begin_time = last_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dice_coef</span><span class="params">(preds, targets, backprop=True)</span>:</span></span><br><span class="line">    smooth = <span class="number">1.0</span></span><br><span class="line">    class_num = <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> backprop:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(class_num):</span><br><span class="line">            pred = preds[:,i,:,:]</span><br><span class="line">            target = targets[:,i,:,:]</span><br><span class="line">            intersection = (pred * target).sum()</span><br><span class="line">            loss_ = <span class="number">1</span> - ((<span class="number">2.0</span> * intersection + smooth) / (pred.sum() + target.sum() + smooth))</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                loss = loss_</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                loss = loss + loss_</span><br><span class="line">        loss = loss/class_num</span><br><span class="line">        <span class="keyword">return</span> loss</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Need to generalize</span></span><br><span class="line">        targets = np.array(targets.argmax(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> len(preds.shape) &gt; <span class="number">3</span>:</span><br><span class="line">            preds = np.array(preds).argmax(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(class_num):</span><br><span class="line">            pred = (preds==i).astype(np.uint8)</span><br><span class="line">            target= (targets==i).astype(np.uint8)</span><br><span class="line">            intersection = (pred * target).sum()</span><br><span class="line">            loss_ = <span class="number">1</span> - ((<span class="number">2.0</span> * intersection + smooth) / (pred.sum() + target.sum() + smooth))</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                loss = loss_</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                loss = loss + loss_</span><br><span class="line">        loss = loss/class_num</span><br><span class="line">        <span class="keyword">return</span> loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_crf_img</span><span class="params">(inputs, outputs)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(outputs.shape[<span class="number">0</span>]):</span><br><span class="line">        img = inputs[i]</span><br><span class="line">        softmax_prob = outputs[i]</span><br><span class="line">        unary = unary_from_softmax(softmax_prob)</span><br><span class="line">        unary = np.ascontiguousarray(unary)</span><br><span class="line">        d = dcrf.DenseCRF(img.shape[<span class="number">0</span>] * img.shape[<span class="number">1</span>], <span class="number">2</span>)</span><br><span class="line">        d.setUnaryEnergy(unary)</span><br><span class="line">        feats = create_pairwise_gaussian(sdims=(<span class="number">10</span>,<span class="number">10</span>), shape=img.shape[:<span class="number">2</span>])</span><br><span class="line">        d.addPairwiseEnergy(feats, compat=<span class="number">3</span>, kernel=dcrf.DIAG_KERNEL,</span><br><span class="line">                            normalization=dcrf.NORMALIZE_SYMMETRIC)</span><br><span class="line">        feats = create_pairwise_bilateral(sdims=(<span class="number">50</span>,<span class="number">50</span>), schan=(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),</span><br><span class="line">                                          img=img, chdim=<span class="number">2</span>)</span><br><span class="line">        d.addPairwiseEnergy(feats, compat=<span class="number">10</span>, kernel=dcrf.DIAG_KERNEL,</span><br><span class="line">                            normalization=dcrf.NORMALIZE_SYMMETRIC)</span><br><span class="line">        Q = d.inference(<span class="number">5</span>)</span><br><span class="line">        res = np.argmax(Q, axis=<span class="number">0</span>).reshape((img.shape[<span class="number">0</span>], img.shape[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            crf = np.expand_dims(res,axis=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res = np.expand_dims(res,axis=<span class="number">0</span>)</span><br><span class="line">            crf = np.concatenate((crf,res),axis=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> crf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">erode_dilate</span><span class="params">(outputs, kernel_size=<span class="number">7</span>)</span>:</span></span><br><span class="line">    kernel = np.ones((kernel_size,kernel_size),np.uint8)</span><br><span class="line">    outputs = outputs.astype(np.uint8)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(outputs.shape[<span class="number">0</span>]):</span><br><span class="line">        img = outputs[i]</span><br><span class="line">        img = cv2.morphologyEx(img, cv2.MORPH_OPEN, kernel)</span><br><span class="line">        img = cv2.morphologyEx(img, cv2.MORPH_CLOSE, kernel)</span><br><span class="line">        outputs[i] = img</span><br><span class="line">    <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_process</span><span class="params">(args, inputs, outputs, input_path=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 crf_flag=True, erode_dilate_flag=True,</span></span></span><br><span class="line"><span class="function"><span class="params">                 save=True, overlap=True)</span>:</span></span><br><span class="line">    inputs = (np.array(inputs.squeeze()).astype(np.float32)) * <span class="number">255</span></span><br><span class="line">    inputs = np.expand_dims(inputs, axis=<span class="number">3</span>)</span><br><span class="line">    inputs = np.concatenate((inputs,inputs,inputs), axis=<span class="number">3</span>)</span><br><span class="line">    outputs = np.array(outputs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Conditional Random Field</span></span><br><span class="line">    <span class="keyword">if</span> crf_flag:</span><br><span class="line">        outputs = get_crf_img(inputs, outputs)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        outputs = outputs.argmax(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Erosion and Dilation</span></span><br><span class="line">    <span class="keyword">if</span> erode_dilate_flag:</span><br><span class="line">        outputs = erode_dilate(outputs, kernel_size=<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">if</span> save == <span class="keyword">False</span>:</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    outputs = outputs*<span class="number">255</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(outputs.shape[<span class="number">0</span>]):</span><br><span class="line">        path = input_path[i].split(<span class="string">'/'</span>)</span><br><span class="line">        output_folder = os.path.join(args.output_root, path[<span class="number">-2</span>])</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.mkdir(output_folder)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        output_path = os.path.join(output_folder, path[<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">if</span> overlap:</span><br><span class="line">            img = outputs[i]</span><br><span class="line">            img = np.expand_dims(img, axis=<span class="number">2</span>)</span><br><span class="line">            zeros = np.zeros(img.shape)</span><br><span class="line">            img = np.concatenate((zeros,zeros,img), axis=<span class="number">2</span>)</span><br><span class="line">            img = np.array(img).astype(np.float32)</span><br><span class="line">            img = inputs[i] + img</span><br><span class="line">            <span class="keyword">if</span> img.max() &gt; <span class="number">0</span>:</span><br><span class="line">                img = (img/img.max())*<span class="number">255</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                img = (img/<span class="number">1</span>) * <span class="number">255</span></span><br><span class="line">            cv2.imwrite(output_path, img)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            img = outputs[i]</span><br><span class="line">            cv2.imwrite(output_path, img)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">TODO: Need to fix</span></span><br><span class="line"><span class="string">def save_img(args, inputs, outputs, input_paths, overlap=True):</span></span><br><span class="line"><span class="string">    inputs = (np.array(inputs.squeeze()).astype(np.float32)) * 255</span></span><br><span class="line"><span class="string">    inputs = np.expand_dims(inputs, axis=3)</span></span><br><span class="line"><span class="string">    inputs = np.concatenate((inputs,inputs,inputs), axis=3)</span></span><br><span class="line"><span class="string">    inputs = np.expand_dims(inputs, axis=3)</span></span><br><span class="line"><span class="string">    outputs = np.array(outputs.max(1)[1])*255</span></span><br><span class="line"><span class="string">    kernel = np.ones((5,5),np.uint8)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    for i, path in enumerate(input_paths):</span></span><br><span class="line"><span class="string">        path = path.split('/')[-2]</span></span><br><span class="line"><span class="string">        if i == 0:</span></span><br><span class="line"><span class="string">            compare = path</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            if compare != path:</span></span><br><span class="line"><span class="string">                raise ValueError('Output Merge Fail')</span></span><br><span class="line"><span class="string">            pass</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    final_img = None</span></span><br><span class="line"><span class="string">    output_path = os.path.join(args.output_root, path+'.nii.gz')</span></span><br><span class="line"><span class="string">    for i in range(outputs.shape[0]):</span></span><br><span class="line"><span class="string">        if overlap:</span></span><br><span class="line"><span class="string">            img = cv2.morphologyEx(outputs[i].astype(np.uint8), cv2.MORPH_OPEN, kernel)</span></span><br><span class="line"><span class="string">            img = cv2.morphologyEx(img, cv2.MORPH_CLOSE, kernel)</span></span><br><span class="line"><span class="string">            img = np.expand_dims(img, axis=2)</span></span><br><span class="line"><span class="string">            zeros = np.zeros(img.shape)</span></span><br><span class="line"><span class="string">            img = np.concatenate((zeros,zeros,img), axis=2)</span></span><br><span class="line"><span class="string">            img = np.expand_dims(img, axis=2)</span></span><br><span class="line"><span class="string">            img = np.array(img).astype(np.float32)</span></span><br><span class="line"><span class="string">            img = inputs[i] + img</span></span><br><span class="line"><span class="string">            if img.max() &gt; 0:</span></span><br><span class="line"><span class="string">                img = (img/img.max())*255</span></span><br><span class="line"><span class="string">            else:</span></span><br><span class="line"><span class="string">                img = (img/1) * 255</span></span><br><span class="line"><span class="string">            img = np.expand_dims(img, axis=3)</span></span><br><span class="line"><span class="string">            if i == 0:</span></span><br><span class="line"><span class="string">                final_img = img</span></span><br><span class="line"><span class="string">            else:</span></span><br><span class="line"><span class="string">                final_img = np.concatenate((final_img,img),axis=3)</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            img = output[i]</span></span><br><span class="line"><span class="string">    output_path = os.path.join(args.output_root, path)</span></span><br><span class="line"><span class="string">    final_img = nib.Nifti1Pair(final_img, np.eye(4))</span></span><br><span class="line"><span class="string">    nib.save(final_img, output_path)</span></span><br><span class="line"><span class="string">    print(output_path)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Checkpoint</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model, optimizer=None, epoch=<span class="number">0</span>, best_score=<span class="number">1</span>)</span>:</span></span><br><span class="line">        self.model = model</span><br><span class="line">        self.optimizer = optimizer</span><br><span class="line">        self.epoch = epoch</span><br><span class="line">        self.best_score = best_score</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        checkpoint = torch.load(path)</span><br><span class="line">        self.model.load_state_dict(checkpoint[<span class="string">"model_state"</span>])</span><br><span class="line">        self.epoch = checkpoint[<span class="string">"epoch"</span>]</span><br><span class="line">        self.best_score = checkpoint[<span class="string">"best_score"</span>]</span><br><span class="line">        <span class="keyword">if</span> self.optimizer:</span><br><span class="line">            self.optimizer.load_state_dict(checkpoint[<span class="string">"optimizer_state"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        state_dict = self.model.module.state_dict()</span><br><span class="line">        torch.save(&#123;<span class="string">"model_state"</span>: state_dict,</span><br><span class="line">                    <span class="string">"optimizer_state"</span>: self.optimizer.state_dict(),</span><br><span class="line">                    <span class="string">"epoch"</span>: self.epoch,</span><br><span class="line">                    <span class="string">"best_score"</span>: self.best_score&#125;, path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">progress_bar</span><span class="params">(current, total, msg=None)</span>:</span></span><br><span class="line">    <span class="string">''' Source Code from 'kuangliu/pytorch-cifar'</span></span><br><span class="line"><span class="string">        (https://github.com/kuangliu/pytorch-cifar/blob/master/utils.py)</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">global</span> last_time, begin_time</span><br><span class="line">    <span class="keyword">if</span> current == <span class="number">0</span>:</span><br><span class="line">        begin_time = time.time()  <span class="comment"># Reset for new bar.</span></span><br><span class="line"></span><br><span class="line">    cur_len = int(TOTAL_BAR_LENGTH*current/total)</span><br><span class="line">    rest_len = int(TOTAL_BAR_LENGTH - cur_len) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    sys.stdout.write(<span class="string">' ['</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(cur_len):</span><br><span class="line">        sys.stdout.write(<span class="string">'='</span>)</span><br><span class="line">    sys.stdout.write(<span class="string">'&gt;'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(rest_len):</span><br><span class="line">        sys.stdout.write(<span class="string">'.'</span>)</span><br><span class="line">    sys.stdout.write(<span class="string">']'</span>)</span><br><span class="line"></span><br><span class="line">    cur_time = time.time()</span><br><span class="line">    step_time = cur_time - last_time</span><br><span class="line">    last_time = cur_time</span><br><span class="line">    tot_time = cur_time - begin_time</span><br><span class="line"></span><br><span class="line">    L = []</span><br><span class="line">    L.append(<span class="string">'  Step: %s'</span> % format_time(step_time))</span><br><span class="line">    L.append(<span class="string">' | Tot: %s'</span> % format_time(tot_time))</span><br><span class="line">    <span class="keyword">if</span> msg:</span><br><span class="line">        L.append(<span class="string">' | '</span> + msg)</span><br><span class="line"></span><br><span class="line">    msg = <span class="string">''</span>.join(L)</span><br><span class="line">    sys.stdout.write(msg)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(term_width-int(TOTAL_BAR_LENGTH)-len(msg)<span class="number">-3</span>):</span><br><span class="line">        sys.stdout.write(<span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Go back to the center of the bar.</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(term_width-int(TOTAL_BAR_LENGTH/<span class="number">2</span>)+<span class="number">2</span>):</span><br><span class="line">        sys.stdout.write(<span class="string">'\b'</span>)</span><br><span class="line">    sys.stdout.write(<span class="string">' %d/%d '</span> % (current+<span class="number">1</span>, total))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current &lt; total<span class="number">-1</span>:</span><br><span class="line">        sys.stdout.write(<span class="string">'\r'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sys.stdout.write(<span class="string">'\n'</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_time</span><span class="params">(seconds)</span>:</span></span><br><span class="line">    <span class="string">''' Source Code from 'kuangliu/pytorch-cifar'</span></span><br><span class="line"><span class="string">        (https://github.com/kuangliu/pytorch-cifar/blob/master/utils.py)</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    days = int(seconds / <span class="number">3600</span>/<span class="number">24</span>)</span><br><span class="line">    seconds = seconds - days*<span class="number">3600</span>*<span class="number">24</span></span><br><span class="line">    hours = int(seconds / <span class="number">3600</span>)</span><br><span class="line">    seconds = seconds - hours*<span class="number">3600</span></span><br><span class="line">    minutes = int(seconds / <span class="number">60</span>)</span><br><span class="line">    seconds = seconds - minutes*<span class="number">60</span></span><br><span class="line">    secondsf = int(seconds)</span><br><span class="line">    seconds = seconds - secondsf</span><br><span class="line">    millis = int(seconds*<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    f = <span class="string">''</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> days &gt; <span class="number">0</span>:</span><br><span class="line">        f += str(days) + <span class="string">'D'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> hours &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt;= <span class="number">2</span>:</span><br><span class="line">        f += str(hours) + <span class="string">'h'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> minutes &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt;= <span class="number">2</span>:</span><br><span class="line">        f += str(minutes) + <span class="string">'m'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> secondsf &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt;= <span class="number">2</span>:</span><br><span class="line">        f += str(secondsf) + <span class="string">'s'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> millis &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt;= <span class="number">2</span>:</span><br><span class="line">        f += str(millis) + <span class="string">'ms'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> f == <span class="string">''</span>:</span><br><span class="line">        f = <span class="string">'0ms'</span></span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_logger</span><span class="params">(level=<span class="string">"DEBUG"</span>, file_level=<span class="string">"DEBUG"</span>)</span>:</span></span><br><span class="line">    logger = logging.getLogger(<span class="keyword">None</span>)</span><br><span class="line">    logger.setLevel(level)</span><br><span class="line">    fomatter = logging.Formatter(</span><br><span class="line">            <span class="string">'%(asctime)s  [%(levelname)s]  %(message)s  (%(filename)s:  %(lineno)s)'</span>)</span><br><span class="line">    fileHandler = logging.handlers.TimedRotatingFileHandler(</span><br><span class="line">            <span class="string">'result.log'</span>, when=<span class="string">'d'</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    fileHandler.setLevel(file_level)</span><br><span class="line">    fileHandler.setFormatter(fomatter)</span><br><span class="line">    logger.addHandler(fileHandler)</span><br><span class="line">    <span class="keyword">return</span> logger</span><br></pre></td></tr></table></figure>
<h1 id="test-py"><a href="#test-py" class="headerlink" title="test.py"></a>test.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.backends.cudnn <span class="keyword">as</span> cudnn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> dataset <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(args)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Device Init</span></span><br><span class="line">    device = config.device</span><br><span class="line">    cudnn.benchmark = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Data Load</span></span><br><span class="line">    testloader = data_loader(args, mode=<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model Load</span></span><br><span class="line">    net, _, _, _ = load_model(args, class_num=config.class_num, mode=<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line">    net.eval()</span><br><span class="line">    torch.set_grad_enabled(<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">for</span> idx, (inputs, paths) <span class="keyword">in</span> enumerate(testloader):</span><br><span class="line">        inputs = inputs.to(device)</span><br><span class="line">        outputs = net(inputs)</span><br><span class="line">        <span class="keyword">if</span> type(outputs) == tuple:</span><br><span class="line">            outputs = outputs[<span class="number">0</span>]</span><br><span class="line">        post_process(args, inputs, outputs, paths)</span><br><span class="line">        print(idx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=__doc__)</span><br><span class="line">    parser.add_argument(<span class="string">"--model"</span>, type=str, default=<span class="string">'pspnet'</span>, <span class="comment"># Need to be fixed</span></span><br><span class="line">                        help=<span class="string">"Model Name"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--batch_size"</span>, type=int, default=<span class="number">155</span>, <span class="comment"># Need to be fixed</span></span><br><span class="line">                        help=<span class="string">"The batch size to load the data"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--data"</span>, type=str, default=<span class="string">"complete"</span>,</span><br><span class="line">                        help=<span class="string">"Label data type."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--img_root"</span>, type=str, default=<span class="string">"../data/train/image_FLAIR"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the training image dataset."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--output_root"</span>, type=str, default=<span class="string">"./output/prediction"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the results."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--ckpt_root"</span>, type=str, default=<span class="string">"./checkpoint"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the trained model checkpoint"</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    test(args)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/07/进化算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/07/进化算法/" itemprop="url">进化算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-07T20:30:01+08:00">
                2018-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程/" itemprop="url" rel="index">
                    <span itemprop="name">编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="准备在博客中新开一个分类，这个分类将记录一些实现的代码，又从别人那里借鉴来的，或者是自己写的之类的。"><a href="#准备在博客中新开一个分类，这个分类将记录一些实现的代码，又从别人那里借鉴来的，或者是自己写的之类的。" class="headerlink" title="准备在博客中新开一个分类，这个分类将记录一些实现的代码，又从别人那里借鉴来的，或者是自己写的之类的。"></a>准备在博客中新开一个分类，这个分类将记录一些实现的代码，又从别人那里借鉴来的，或者是自己写的之类的。</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/29/CRF进行图像分割/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/29/CRF进行图像分割/" itemprop="url">CRF进行图像分割</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-29T15:58:49+08:00">
                2018-11-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h1><p>最近，十分困惑条件随机场是如何工作的，为什么可以加在卷积神经网络的后面作为后处理的部分。虽然理论部分前面的博客也有写过，做过一些总结，不过因为没有实现过代码，所以仍有困惑解决不了，每念至此，心绪不宁，遂作此文，以供参考。</p>
<h1 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h1><p>本文将实现全连接随机场对非RGB的图像进行分割，主要参考文献[1]以及对应的<a href="https://github.com/lucasb-eyer/pydensecrf" target="_blank" rel="noopener">github</a>代码，另外本文需要安装pydensecrf，可以通过<code>pip install pydensecrf</code>安装，安装时需注意，pydensecrf依赖于cython，需要先安装cython。</p>
<h2 id="对非RGB图像分割"><a href="#对非RGB图像分割" class="headerlink" title="对非RGB图像分割"></a>对非RGB图像分割</h2><p>本文的代码放在了我的github中命名为CRF的仓库库中，<a href="https://github.com/hjyai94/CRF/blob/master/examples/Non%20RGB%20Example.ipynb" target="_blank" rel="noopener">链接地址</a>，这里的代码来自于<a href="https://github.com/lucasb-eyer/pydensecrf" target="_blank" rel="noopener">pydensecrf</a>。</p>
<h3 id="一元势"><a href="#一元势" class="headerlink" title="一元势"></a>一元势</h3><p>一元势包含了每个像素对应的类别，这些可以来自随机森林或者是深度神经网络的softmax。这里，我们共有两个类别，一个是前景，一个是背景，这里大小设置为$400\times 512$。我们建立了两个二维的高斯分布，并且平面显示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> multivariate_normal</span><br><span class="line"></span><br><span class="line">H, W, NLABELS = <span class="number">400</span>, <span class="number">512</span>, <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This creates a gaussian blob...</span></span><br><span class="line">pos = np.stack(np.mgrid[<span class="number">0</span>:H, <span class="number">0</span>:W], axis=<span class="number">2</span>)</span><br><span class="line">print(pos.shape)</span><br><span class="line">rv = multivariate_normal([H//<span class="number">2</span>, W//<span class="number">2</span>], (H//<span class="number">4</span>)*(W//<span class="number">4</span>))</span><br><span class="line">probs = rv.pdf(pos)</span><br><span class="line">print(probs.shape)</span><br><span class="line"><span class="comment"># ...which we project into the range [0.4, 0.6]</span></span><br><span class="line">probs = (probs-probs.min()) / (probs.max()-probs.min())</span><br><span class="line">probs = <span class="number">0.5</span> + <span class="number">0.2</span> * (probs<span class="number">-0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The first dimension needs to be equal to the number of classes.</span></span><br><span class="line"><span class="comment"># Let's have one "foreground" and one "background" class.</span></span><br><span class="line"><span class="comment"># So replicate the gaussian blob but invert it to create the probability</span></span><br><span class="line"><span class="comment"># of the "background" class to be the opposite of "foreground".</span></span><br><span class="line">probs = np.tile(probs[np.newaxis,:,:],(<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>))</span><br><span class="line">probs[<span class="number">1</span>,:,:] = <span class="number">1</span> - probs[<span class="number">0</span>,:,:]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Let's have a look:</span></span><br><span class="line">plt.figure(figsize=(<span class="number">15</span>,<span class="number">5</span>))</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>); plt.imshow(probs[<span class="number">0</span>,:,:]); plt.title(<span class="string">'Foreground probability'</span>); plt.axis(<span class="string">'off'</span>); plt.colorbar();</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>); plt.imshow(probs[<span class="number">1</span>,:,:]); plt.title(<span class="string">'Background probability'</span>); plt.axis(<span class="string">'off'</span>); plt.colorbar();</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/CRF%E8%BF%9B%E8%A1%8C%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/output_9_1.png" alt="output_9_1.png"></p>
<h3 id="使用一元势进行推断"><a href="#使用一元势进行推断" class="headerlink" title="使用一元势进行推断"></a>使用一元势进行推断</h3><p>这里我们可以使用一元势进行推断，也就是说这里我们不考虑像素间的相互关联。这样做并不是很好的推断，但是可以这么做。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Inference without pair-wise terms</span></span><br><span class="line">U = unary_from_softmax(probs)  <span class="comment"># note: num classes is first dim</span></span><br><span class="line">d = dcrf.DenseCRF2D(W, H, NLABELS)</span><br><span class="line">d.setUnaryEnergy(U)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run inference for 10 iterations</span></span><br><span class="line">Q_unary = d.inference(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The Q is now the approximate posterior, we can get a MAP estimate using argmax.</span></span><br><span class="line">map_soln_unary = np.argmax(Q_unary, axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Unfortunately, the DenseCRF flattens everything, so get it back into picture form.</span></span><br><span class="line">map_soln_unary = map_soln_unary.reshape((H,W))</span><br><span class="line"><span class="comment"># And let's have a look.</span></span><br><span class="line">plt.imshow(map_soln_unary); plt.axis(<span class="string">'off'</span>); plt.title(<span class="string">'MAP Solution without pairwise terms'</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/CRF%E8%BF%9B%E8%A1%8C%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/output_12_0.png" alt="output_12_0.png"></p>
<h3 id="二元势"><a href="#二元势" class="headerlink" title="二元势"></a>二元势</h3><p>图像处理中，我们经常使用像素间的双边关系，也就是说，我们认为有相似颜色的或者是相似的位置的像素认为是同一类。下面我们建立这样的双边关系。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">NCHAN=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create simple image which will serve as bilateral.</span></span><br><span class="line"><span class="comment"># Note that we put the channel dimension last here,</span></span><br><span class="line"><span class="comment"># but we could also have it be the first dimension and</span></span><br><span class="line"><span class="comment"># just change the `chdim` parameter to `0` further down.</span></span><br><span class="line">img = np.zeros((H,W,NCHAN), np.uint8)</span><br><span class="line">img[H//<span class="number">3</span>:<span class="number">2</span>*H//<span class="number">3</span>,W//<span class="number">4</span>:<span class="number">3</span>*W//<span class="number">4</span>,:] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">plt.imshow(img[:,:,<span class="number">0</span>]); plt.title(<span class="string">'Bilateral image'</span>); plt.axis(<span class="string">'off'</span>); plt.colorbar();</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the pairwise bilateral term from the above image.</span></span><br><span class="line"><span class="comment"># The two `s&#123;dims,chan&#125;` parameters are model hyper-parameters defining</span></span><br><span class="line"><span class="comment"># the strength of the location and image content bilaterals, respectively.</span></span><br><span class="line">pairwise_energy = create_pairwise_bilateral(sdims=(<span class="number">10</span>,<span class="number">10</span>), schan=(<span class="number">0.01</span>,), img=img, chdim=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pairwise_energy now contains as many dimensions as the DenseCRF has features,</span></span><br><span class="line"><span class="comment"># which in this case is 3: (x,y,channel1)</span></span><br><span class="line">img_en = pairwise_energy.reshape((<span class="number">-1</span>, H, W))  <span class="comment"># Reshape just for plotting</span></span><br><span class="line">plt.figure(figsize=(<span class="number">15</span>,<span class="number">5</span>))</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">1</span>); plt.imshow(img_en[<span class="number">0</span>]); plt.title(<span class="string">'Pairwise bilateral [x]'</span>); plt.axis(<span class="string">'off'</span>); plt.colorbar();</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>); plt.imshow(img_en[<span class="number">1</span>]); plt.title(<span class="string">'Pairwise bilateral [y]'</span>); plt.axis(<span class="string">'off'</span>); plt.colorbar();</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>); plt.imshow(img_en[<span class="number">2</span>]); plt.title(<span class="string">'Pairwise bilateral [c]'</span>); plt.axis(<span class="string">'off'</span>); plt.colorbar();</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/CRF%E8%BF%9B%E8%A1%8C%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/output_17_0.png" alt="output_17_0.png"><br><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/CRF%E8%BF%9B%E8%A1%8C%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/output_18_0.png" alt="output_17_0.png"></p>
<h3 id="使用完整的条件随机场进行推断"><a href="#使用完整的条件随机场进行推断" class="headerlink" title="使用完整的条件随机场进行推断"></a>使用完整的条件随机场进行推断</h3><p>下面我们将一元势与二元势结合起来进行推断，执行不同的迭代次数，有下面的结果。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">d = dcrf.DenseCRF2D(W, H, NLABELS)</span><br><span class="line">d.setUnaryEnergy(U)</span><br><span class="line">d.addPairwiseEnergy(pairwise_energy, compat=<span class="number">10</span>)  <span class="comment"># `compat` is the "strength" of this potential.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This time, let's do inference in steps ourselves</span></span><br><span class="line"><span class="comment"># so that we can look at intermediate solutions</span></span><br><span class="line"><span class="comment"># as well as monitor KL-divergence, which indicates</span></span><br><span class="line"><span class="comment"># how well we have converged.</span></span><br><span class="line"><span class="comment"># PyDenseCRF also requires us to keep track of two</span></span><br><span class="line"><span class="comment"># temporary buffers it needs for computations.</span></span><br><span class="line">Q, tmp1, tmp2 = d.startInference()</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    d.stepInference(Q, tmp1, tmp2)</span><br><span class="line">kl1 = d.klDivergence(Q) / (H*W)</span><br><span class="line">map_soln1 = np.argmax(Q, axis=<span class="number">0</span>).reshape((H,W))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">    d.stepInference(Q, tmp1, tmp2)</span><br><span class="line">kl2 = d.klDivergence(Q) / (H*W)</span><br><span class="line">map_soln2 = np.argmax(Q, axis=<span class="number">0</span>).reshape((H,W))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    d.stepInference(Q, tmp1, tmp2)</span><br><span class="line">kl3 = d.klDivergence(Q) / (H*W)</span><br><span class="line">map_soln3 = np.argmax(Q, axis=<span class="number">0</span>).reshape((H,W))</span><br><span class="line"></span><br><span class="line">img_en = pairwise_energy.reshape((<span class="number">-1</span>, H, W))  <span class="comment"># Reshape just for plotting</span></span><br><span class="line">plt.figure(figsize=(<span class="number">15</span>,<span class="number">5</span>))</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">1</span>); plt.imshow(map_soln1);</span><br><span class="line">plt.title(<span class="string">'MAP Solution with DenseCRF\n(5 steps, KL=&#123;:.2f&#125;)'</span>.format(kl1)); plt.axis(<span class="string">'off'</span>);</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>); plt.imshow(map_soln2);</span><br><span class="line">plt.title(<span class="string">'MAP Solution with DenseCRF\n(20 steps, KL=&#123;:.2f&#125;)'</span>.format(kl2)); plt.axis(<span class="string">'off'</span>);</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>); plt.imshow(map_soln3);</span><br><span class="line">plt.title(<span class="string">'MAP Solution with DenseCRF\n(75 steps, KL=&#123;:.2f&#125;)'</span>.format(kl3)); plt.axis(<span class="string">'off'</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/CRF%E8%BF%9B%E8%A1%8C%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/output_21_0.png" alt="output_21_0.png"></p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p>[1] Krähenbühl P, Koltun V. Efficient inference in fully connected crfs with gaussian edge potentials[C]//Advances in neural information processing systems. 2011: 109-117.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/27/KL散度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/27/KL散度/" itemprop="url">KL散度</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-27T15:59:48+08:00">
                2018-11-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>很久没有推导过公式了，感觉水平退步显著，今日看变分推断内容，看到了计算两个高斯分布间的KL散度，下面我自己推导了一下。</p>
<h1 id="高斯分布间的KL散度"><a href="#高斯分布间的KL散度" class="headerlink" title="高斯分布间的KL散度"></a>高斯分布间的KL散度</h1><p>现有先验分布$p_{\theta}(z) = \boldsymbol{N}(0, \boldsymbol{I})$，后验分布$q_{\phi}(\boldsymbol{z}\mid \boldsymbol{x}^{(i)})$同样是高斯分布。变量$z$的维数是$J$。其中，$\boldsymbol{u}$和$\boldsymbol{\sigma}$记作点$i$的均值和标准差。另外，$\mu_j$和$\sigma_j$是均值和方差向量的第$j$个因子。<br>KL散度的公式如下：<br>\begin{equation}\begin{split}<br>D_{KL}(q_{\phi}(\boldsymbol{z})|| p_{\theta}(\boldsymbol{z})) &amp;= \int q_{\phi}(\boldsymbol{z}) log \frac{q_{\phi}(\boldsymbol{z})} {p_{\theta}(\boldsymbol{z})} d\boldsymbol{z}\\<br>&amp;= \int q_{\phi}(\boldsymbol{z}) log q_{\phi}(\boldsymbol{z}) d\boldsymbol{z} - \int q_{\phi}(\boldsymbol{z}) log p_{\theta}(\boldsymbol{z}) d\boldsymbol{z} \\<br>\end{split}\end{equation}<br>第二项如下所示(因为先写的第二项，小声bb.jpg)：<br>\begin{equation}\begin{split}<br>\int q_{\phi}(\boldsymbol{z}) log p_{\theta}(\boldsymbol{z}) d\boldsymbol{z} &amp;= \int \mathcal{N}(\boldsymbol{z;\mu, \sigma^2}) log \mathcal{N}(\boldsymbol{z; 0, I})d \boldsymbol{z} \\<br>&amp;= \int -\frac{1}{2} log{2\pi}\ q_{\phi}(\boldsymbol{z}) -\frac{z^2}{2} q_{\phi}(\boldsymbol{z}) d\boldsymbol{z} \\<br>&amp;= -\frac{J}{2}log(2\pi) -\frac{1}{2} \int q_{\phi}(\boldsymbol{z}) \boldsymbol{z}^2 d\boldsymbol{z} \\<br>&amp;= -\frac{J}{2}log(2\pi) -\frac{1}{2} \int q_{\phi}(\boldsymbol{z}) (\boldsymbol{z- \mu + \mu})^2 d\boldsymbol{z} \\<br>&amp;= -\frac{J}{2}log(2\pi) -\frac{1}{2} \int q_{\phi}(\boldsymbol{z}) [(\boldsymbol{z- \mu})^2 + \boldsymbol{\mu}^2 +2(\boldsymbol{z - \mu})\boldsymbol{\mu}] d\boldsymbol{z} \\<br>&amp;= -\frac{J}{2}log(2\pi) -\frac{1}{2} \int q_{\phi}(\boldsymbol{z}) [(\boldsymbol{z- \mu})^2 + \boldsymbol{\mu}^2)] d\boldsymbol{z} \\<br>&amp;= -\frac{J}{2}log(2\pi) -\frac{1}{2} \int q_{\phi}(\boldsymbol{z}) (\boldsymbol{\sigma}^2 + \boldsymbol{\mu}^2) d\boldsymbol{z} \\<br>&amp;= -\frac{J}{2}log(2\pi) -\frac{1}{2} \sum_{j=1}^{J} (\mu_j^2 + \sigma_j^2)<br>\end{split}\end{equation}</p>
<p>同样，第一项可以写成如下的形式：<br>\begin{equation}\begin{split}<br>\int q_{\phi}(\boldsymbol{z}) log q_{\phi}(\boldsymbol{z}) d\boldsymbol{z} &amp;= -\frac{J}{2}log(2\pi) -\frac{1}{2} \sum_{j=1}^{J} (1 + log\ \sigma_j^2)<br>\end{split}\end{equation}<br>将上面两项合并一起：<br>\begin{equation}\begin{split}<br>D_{KL}(q_{\phi}(\boldsymbol{z}) || p_{\theta}(\boldsymbol{z})) &amp;= \int q_{\phi}(\boldsymbol{z}) log (q_{\phi}(\boldsymbol{z}) - p_{\theta}(\boldsymbol{z})) d\boldsymbol{z}\\<br>&amp;= -\frac{1}{2} \sum_{j=1}^{J} (1 + log\ \sigma_j^2) + \frac{1}{2} \sum_{j=1}^{J} (\mu_j^2 + \sigma_j^2) \\<br>&amp;= \frac{1}{2} \sum_{j=1}^{J} (-1 - log\ \sigma_j^2 + \mu_j^2 + \sigma_j^2)<br>\end{split}\end{equation}</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p>Kingma D P. Variational inference &amp; deep learning: A new synthesis[D]. 2017.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/18/MRI读取与可视化I/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/18/MRI读取与可视化I/" itemprop="url">MRI读取与可视化I</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-18T19:00:40+08:00">
                2018-10-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天在网上看了一些读取MRI文件的方法，中文的博客并不是很多，另外很多并不适合我的文件格式，本文主要是针对MRI中采用NIFTI(.nii.g其中gz是压缩文件)格式的文件，并进行可视化分析。</p>
<h1 id="NIBabel"><a href="#NIBabel" class="headerlink" title="NIBabel"></a>NIBabel</h1><p>NIBabel是一个常见的读写神经医学文件的python库，包括ANALYZE, GIFTI, NIfTI2, MINC1, MINC2, MGH和ECAT，还有Philips PAR/REC。<br>下面我们用一张大脑的<a href="http://nipy.org/nibabel/_downloads/someones_epi.nii.gz" target="_blank" rel="noopener">MRI图片</a>，来说这个库的使用，以及MRI文件的格式。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nibabel <span class="keyword">as</span> nib</span><br><span class="line">img = nib.load(<span class="string">'downloads/someones_epi.nii.gz'</span>)</span><br><span class="line">img_header = img.get_header()</span><br><span class="line">print(<span class="string">'Header: '</span>, img_header)</span><br><span class="line">img_data = img.get_fdata()</span><br><span class="line">print(<span class="string">'img_data shape: '</span>, img_data.shape)</span><br></pre></td></tr></table></figure></p>
<p>一个格式为NIFTI的格式文件，通常包括头文件和相应的图像文件。图像文件时三维的，上面的MRI图片的shape为(53, 61, 33)。下面我们将三个维度的中间slice进行可视化(因为不会直接将三维的图像可视化)。</p>
<h1 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h1><p>下面我们显示中间的slice：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">plt.imshow(img_data[<span class="number">26</span>, :, :])</span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line">plt.imshow(img_data[:, <span class="number">30</span>, :])</span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line">plt.imshow(img_data[:, :, <span class="number">15</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<h1 id="下面的工作"><a href="#下面的工作" class="headerlink" title="下面的工作"></a>下面的工作</h1><p>利用pytorch读取文件，训练神机网络。(可能不会上传到本博客中)</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a href="http://nipy.org/nibabel/coordinate_systems.html#voxel-coordinates-are-coordinates-in-the-image-data-array" target="_blank" rel="noopener">http://nipy.org/nibabel/coordinate_systems.html#voxel-coordinates-are-coordinates-in-the-image-data-array</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/13/Pytorch_Tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/13/Pytorch_Tutorial/" itemprop="url">Pytorch Tutorial</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-13T00:00:00+08:00">
                2018-10-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h1><p>本文主要是基于Pytorch给出的官方<a href="https://pytorch.org/tutorials/beginner/deep_learning_60min_blitz.html" target="_blank" rel="noopener">Tutorial</a>，然后我按照自己的喜好编辑成Jupyter文档，后转成本博客，用来作为自己的日常参照材料。</p>
<h1 id="Pytorch"><a href="#Pytorch" class="headerlink" title="Pytorch"></a>Pytorch</h1><p>Pytorch给我的感觉是：它是基于更高级的封装，实现深度学习更加简单，比较适合科研型的或者是实现一些想法的入门级选手。Tensorflow更适合工程项目，能够比较高效的运行。但是对于一般选手来说，Pytorch更适合，因为它是动态图，在个人代码水平不是很高的情况下，Pytorch的效率是高于Tensorflow的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">device = torch.device( <span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="Tensors"><a href="#Tensors" class="headerlink" title="Tensors"></a>Tensors</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Contruct a 2x1 matric, uninitialized:</span></span><br><span class="line">x = torch.empty(<span class="number">2</span>, <span class="number">1</span>, device=device)</span><br><span class="line">print(x)</span><br></pre></td></tr></table></figure>
<pre><code>tensor([[0.0000],
        [0.0000]])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Construct a randomly initialized matrix:</span></span><br><span class="line">x = torch.rand(<span class="number">5</span>, <span class="number">3</span>, device=device)</span><br><span class="line">print(x)</span><br></pre></td></tr></table></figure>
<pre><code>tensor([[0.2854, 0.5359, 0.7811],
        [0.1065, 0.0246, 0.3945],
        [0.8341, 0.6808, 0.4578],
        [0.4257, 0.7255, 0.3597],
        [0.3510, 0.3170, 0.1526]])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Construct a matrix filled zeros and dtype long</span></span><br><span class="line">x = torch.zeros(<span class="number">2</span>, <span class="number">1</span>, dtype=torch.long, device=device)</span><br><span class="line">print(x)</span><br></pre></td></tr></table></figure>
<pre><code>tensor([[0],
        [0]])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Construct a tensor directly from data;</span></span><br><span class="line">x = torch.tensor([<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">print(x)</span><br></pre></td></tr></table></figure>
<pre><code>tensor([3, 3])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = x.new_ones(<span class="number">2</span>, <span class="number">1</span>, dtype=torch.double) <span class="comment"># new_* methods take in size</span></span><br><span class="line">print(x)</span><br><span class="line"></span><br><span class="line">x = torch.randn_like(x, dtype=torch.float) <span class="comment"># override dype and result has same size</span></span><br><span class="line">print(x)</span><br></pre></td></tr></table></figure>
<pre><code>tensor([[1.],
        [1.]], dtype=torch.float64)
tensor([[1.4535],
        [0.0968]])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get its size</span></span><br><span class="line">print(x.size())</span><br><span class="line"></span><br><span class="line">print(x.shape)</span><br></pre></td></tr></table></figure>
<pre><code>torch.Size([2, 1])
torch.Size([2, 1])
</code></pre><h1 id="Opertions"><a href="#Opertions" class="headerlink" title="Opertions"></a>Opertions</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Addition</span></span><br><span class="line">x = x.new_ones(<span class="number">3</span>, <span class="number">2</span>, dtype=torch.float)</span><br><span class="line">y = torch.rand(<span class="number">3</span>, <span class="number">2</span>, dtype=torch.float)</span><br><span class="line">print(x + y) <span class="comment"># syntax 1</span></span><br><span class="line">print(torch.add(x, y)) <span class="comment"># syntax 2</span></span><br><span class="line">result = torch.empty(<span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">torch.add(x, y, out=result) <span class="comment"># add x and y to result</span></span><br><span class="line">print(result)</span><br><span class="line">y.add_(x)</span><br><span class="line">print(y) <span class="comment"># add x to y</span></span><br></pre></td></tr></table></figure>
<pre><code>tensor([[1.9447, 1.9085],
        [1.3177, 1.8074],
        [1.1208, 1.8663]])
tensor([[1.9447, 1.9085],
        [1.3177, 1.8074],
        [1.1208, 1.8663]])
tensor([[1.9447, 1.9085],
        [1.3177, 1.8074],
        [1.1208, 1.8663]])
tensor([[1.9447, 1.9085],
        [1.3177, 1.8074],
        [1.1208, 1.8663]])
</code></pre><p>注：任何tensor后面带有下划线都会改变tensor的值，比如x.copy_(y), x.t_(x)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = torch.rand(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line">print(x)</span><br><span class="line">print(x[:, <span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<pre><code>tensor([[0.8368, 0.9204],
        [0.3797, 0.0908],
        [0.4454, 0.7684]])
tensor([0.9204, 0.0908, 0.7684])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># resizing</span></span><br><span class="line">x = torch.randn(<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line">y = x.view(<span class="number">16</span>)</span><br><span class="line">z = x.view(<span class="number">-1</span>, <span class="number">8</span>) <span class="comment"># the size -1 is inferred from other dimensions</span></span><br><span class="line">print(x.size(), y.size(), z.size())</span><br></pre></td></tr></table></figure>
<pre><code>torch.Size([4, 4]) torch.Size([16]) torch.Size([2, 8])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Converting Numpy Array to Torch Tensor</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">a = np.ones(<span class="number">5</span>)</span><br><span class="line">b = torch.from_numpy(a)</span><br><span class="line">np.add(a, <span class="number">1</span>, out=a)</span><br><span class="line">print(a)</span><br><span class="line">print(b)</span><br></pre></td></tr></table></figure>
<pre><code>[2. 2. 2. 2. 2.]
tensor([2., 2., 2., 2., 2.], dtype=torch.float64)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CUDA Tensor</span></span><br><span class="line"><span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">    device = torch.device(<span class="string">"cuda"</span>)</span><br><span class="line">    y = torch.ones_like(x, device=device)</span><br><span class="line">    x = x.to(device)</span><br><span class="line">    z = x + y</span><br><span class="line">    print(z)</span><br><span class="line">    print(z.to(<span class="string">"cpu"</span>, torch.double))</span><br></pre></td></tr></table></figure>
<h1 id="Define-the-Network"><a href="#Define-the-Network" class="headerlink" title="Define the Network"></a>Define the Network</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br></pre></td></tr></table></figure>
<p>本来这个网络应该是LeNet的，输入要求是32x32，我改变了第一个全连接层，将输入变为了20x20。<br>所以网络结构可以通过自己的想法进行改变，最重要的是改变全连接层就可以了。<br>网络经过卷积之后输入的结果公式为：$$ outputsize = （inputsize - kernelsize + 2 * pad）/stride + 1 $$</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Net</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Net, self).__init__()</span><br><span class="line">        <span class="comment"># 1 input image channel, 6 output channels, 5x5 square convolution</span></span><br><span class="line">        <span class="comment"># kernel</span></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(<span class="number">6</span>, <span class="number">16</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="comment"># an affine operation: y = Wx + b</span></span><br><span class="line">        self.fc1 = nn.Linear(<span class="number">16</span> * <span class="number">2</span> * <span class="number">2</span>, <span class="number">120</span>)</span><br><span class="line">        self.fc2 = nn.Linear(<span class="number">120</span>, <span class="number">84</span>)</span><br><span class="line">        self.fc3 = nn.Linear(<span class="number">84</span>, <span class="number">10</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment"># Max pooling over a (2, 2) window</span></span><br><span class="line">        x = F.max_pool2d(F.relu(self.conv1(x)), (<span class="number">2</span>, <span class="number">2</span>))</span><br><span class="line">        <span class="comment"># if the size is a square you can only specify a single number </span></span><br><span class="line">        x = F.max_pool2d(F.relu(self.conv2(x)), <span class="number">2</span>)</span><br><span class="line">        x = x.view(<span class="number">-1</span>, self.num_flat_feature(x))</span><br><span class="line">        x = F.relu(self.fc1(x))</span><br><span class="line">        x = F.relu(self.fc2(x))</span><br><span class="line">        x = F.relu(self.fc3(x))</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">num_flat_feature</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        size = x.size()[<span class="number">1</span>:] <span class="comment"># all dimensions except the batch dimension</span></span><br><span class="line">        num_features = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> size:</span><br><span class="line">            num_features *= s </span><br><span class="line">        <span class="keyword">return</span> num_features</span><br><span class="line">net = Net()</span><br><span class="line">print(net)</span><br></pre></td></tr></table></figure>
<pre><code>Net(
  (conv1): Conv2d(1, 6, kernel_size=(5, 5), stride=(1, 1))
  (conv2): Conv2d(6, 16, kernel_size=(5, 5), stride=(1, 1))
  (fc1): Linear(in_features=64, out_features=120, bias=True)
  (fc2): Linear(in_features=120, out_features=84, bias=True)
  (fc3): Linear(in_features=84, out_features=10, bias=True)
)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The learnable parameter of a model are returned by net.parameters()</span></span><br><span class="line">params = list(net.parameters())</span><br><span class="line">print(len(params))</span><br><span class="line">print(params[<span class="number">0</span>].size()) <span class="comment"># conv1's .weights</span></span><br></pre></td></tr></table></figure>
<pre><code>10
torch.Size([6, 1, 5, 5])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input = torch.randn(<span class="number">1</span>, <span class="number">1</span>, <span class="number">20</span>, <span class="number">20</span>)</span><br><span class="line">out = net(input)</span><br><span class="line">print(out)</span><br></pre></td></tr></table></figure>
<pre><code>tensor([[0.0432, 0.1072, 0.0000, 0.1096, 0.0378, 0.0000, 0.0000, 0.0000, 0.0202,
         0.0000]], grad_fn=&lt;ReluBackward&gt;)
</code></pre><h2 id="zero-the-gradients"><a href="#zero-the-gradients" class="headerlink" title="zero the gradients"></a>zero the gradients</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.zero_grad()</span><br><span class="line">out.backward(torch.randn(<span class="number">1</span>, <span class="number">10</span>))</span><br></pre></td></tr></table></figure>
<p>torch.nn only supports mini-batches. The entire torch.nn package only supports inputs that are a mini-batch of samples, and not a single sample.<br>For example, nn.Conv2d will take in a 4D Tensor of nSamples x nChannels x Height x Width.<br>If you have a single sample, just use input.unsqueeze(0) to add a fake batch dimension.</p>
<h2 id="Loss-Function"><a href="#Loss-Function" class="headerlink" title="Loss Function"></a>Loss Function</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">out = net(input)</span><br><span class="line">target = torch.randn(<span class="number">10</span>) <span class="comment"># a dummy target, for example </span></span><br><span class="line">target = target.view(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line">criterion = nn.MSELoss()</span><br><span class="line"></span><br><span class="line">loss = criterion(out, target)</span><br><span class="line">print(loss)</span><br></pre></td></tr></table></figure>
<pre><code>tensor(1.7536, grad_fn=&lt;MseLossBackward&gt;)
</code></pre><p>forward:<br>input -&gt; conv2d -&gt; relu -&gt; maxpool2d -&gt; conv2d -&gt; relu -&gt; maxpool2d<br>      -&gt; view -&gt; linear -&gt; relu -&gt; linear -&gt; relu -&gt; linear<br>      -&gt; MSELoss<br>      -&gt; loss</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(loss.grad_fn) <span class="comment"># MSELoss</span></span><br><span class="line">print(loss.grad_fn.next_functions[<span class="number">0</span>][<span class="number">0</span>]) <span class="comment"># Linear</span></span><br><span class="line">print(loss.grad_fn.next_functions[<span class="number">0</span>][<span class="number">0</span>].next_functions[<span class="number">0</span>][<span class="number">0</span>]) <span class="comment"># relu</span></span><br></pre></td></tr></table></figure>
<pre><code>&lt;MseLossBackward object at 0x0000000008619780&gt;
&lt;ReluBackward object at 0x0000000008619A58&gt;
&lt;ThAddmmBackward object at 0x0000000008619780&gt;
</code></pre><h2 id="Backpropagate"><a href="#Backpropagate" class="headerlink" title="Backpropagate"></a>Backpropagate</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">net.zero_grad() <span class="comment"># zeros the gradient buffer of all parameters </span></span><br><span class="line">print(<span class="string">'conv1.bias.grad before backward'</span>)</span><br><span class="line">print(net.conv1.bias.grad)</span><br><span class="line"></span><br><span class="line"><span class="comment"># loss.backward() # 为了和下面的产生两次相同的backpropagate，所以将这里注释，下一个单元也是这样。</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'conv1.bias.grad before backward'</span>)</span><br><span class="line">print(net.conv1.bias.grad)</span><br></pre></td></tr></table></figure>
<pre><code>conv1.bias.grad before backward
tensor([0., 0., 0., 0., 0., 0.])
conv1.bias.grad before backward
tensor([0., 0., 0., 0., 0., 0.])
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Weights</span></span><br><span class="line"><span class="comment"># learning_rate = 0.01</span></span><br><span class="line"><span class="comment"># for f in net.parameters():</span></span><br><span class="line"><span class="comment">#     f.data.sub_(f.grad.data * learning_rate)  # f = f - learning_rate * gradient</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line"><span class="comment"># creater your optimizer</span></span><br><span class="line">optimizer = optim.SGD(net.parameters(), lr=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># in your training loop </span></span><br><span class="line">optimizer.zero_grad() <span class="comment"># zero the gradient buffers</span></span><br><span class="line">output = net(input)</span><br><span class="line">loss = criterion(out, target)</span><br><span class="line">loss.backward()</span><br><span class="line">optimizer.step() <span class="comment"># Does the update</span></span><br></pre></td></tr></table></figure>
<h1 id="Training-A-Classifier"><a href="#Training-A-Classifier" class="headerlink" title="Training A Classifier"></a>Training A Classifier</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The output of torchvision datasets are PILImage iamges of range [0, 1]. We transform them to Tensor of normalized range [-1, 1]</span></span><br><span class="line">transform = transforms.Compose(</span><br><span class="line">[transforms.ToTensor(), transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))])</span><br><span class="line"></span><br><span class="line">trainset = torchvision.datasets.CIFAR10(root=<span class="string">'./data'</span>, train=<span class="keyword">True</span>, </span><br><span class="line">                                       download=<span class="keyword">True</span>, transform=transform)</span><br><span class="line">trainloader = torch.utils.data.DataLoader(trainset, batch_size=<span class="number">4</span>, </span><br><span class="line">                                          shuffle=<span class="keyword">True</span>, num_workers=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">testset = torchvision.datasets.CIFAR10(root=<span class="string">'./data'</span>, train=<span class="keyword">False</span>, </span><br><span class="line">                                      download=<span class="keyword">True</span>, transform=transform)</span><br><span class="line">testloader = torch.utils.data.DataLoader(testset, batch_size=<span class="number">4</span>, </span><br><span class="line">                                              shuffle=<span class="keyword">False</span>, num_workers=<span class="number">2</span>)</span><br><span class="line">classes = (<span class="string">'plane'</span>, <span class="string">'car'</span>, <span class="string">'bird'</span>, <span class="string">'cat'</span>, </span><br><span class="line">          <span class="string">'deer'</span>, <span class="string">'dog'</span>, <span class="string">'frog'</span>, <span class="string">'horse'</span>, <span class="string">'ship'</span>, <span class="string">'truck'</span>)</span><br></pre></td></tr></table></figure>
<pre><code>Files already downloaded and verified
Files already downloaded and verified
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">imshow</span><span class="params">(img)</span>:</span></span><br><span class="line">    img = img/<span class="number">2</span> + <span class="number">0.5</span> <span class="comment"># unnormalize</span></span><br><span class="line">    npimg = img.numpy()</span><br><span class="line"><span class="comment">#     print(npimg.shape)</span></span><br><span class="line">    plt.imshow(np.transpose(npimg, (<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>)))</span><br><span class="line"><span class="comment">#     print(np.transpose(npimg, (1, 2, 0)).shape)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># get some random training images</span></span><br><span class="line">dataiter = iter(trainloader)</span><br><span class="line">images, labels = dataiter.next()</span><br><span class="line"><span class="comment"># print(labels)</span></span><br><span class="line"><span class="comment"># show images</span></span><br><span class="line">imshow(torchvision.utils.make_grid(images)) <span class="comment"># 制作图像网格</span></span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># print labels</span></span><br><span class="line">print(<span class="string">' '</span>.join(<span class="string">'%5s'</span> % classes[labels[j]] <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>)))</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/Pytorch_Tutorial_output_35_0%20.png" alt=""></p>
<pre><code>deer truck plane horse
</code></pre><h2 id="Define-a-Convolution-Neural-Network"><a href="#Define-a-Convolution-Neural-Network" class="headerlink" title="Define a Convolution Neural Network"></a>Define a Convolution Neural Network</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Net</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Net, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">3</span>, <span class="number">6</span>, <span class="number">5</span>)</span><br><span class="line">        self.pool = nn.MaxPool2d(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(<span class="number">6</span>, <span class="number">16</span>, <span class="number">5</span>)</span><br><span class="line">        self.fc1 = nn.Linear(<span class="number">16</span> * <span class="number">5</span> * <span class="number">5</span>, <span class="number">120</span>)</span><br><span class="line">        self.fc2 = nn.Linear(<span class="number">120</span>, <span class="number">84</span>)</span><br><span class="line">        self.fc3 = nn.Linear(<span class="number">84</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.pool(F.relu(self.conv1(x)))</span><br><span class="line">        x = self.pool(F.relu(self.conv2(x)))</span><br><span class="line">        x = x.view(<span class="number">-1</span>, <span class="number">16</span> * <span class="number">5</span> * <span class="number">5</span>)</span><br><span class="line">        x = F.relu(self.fc1(x))</span><br><span class="line">        x = F.relu(self.fc2(x))</span><br><span class="line">        x = self.fc3(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">net = Net()</span><br><span class="line">net.to(device)</span><br><span class="line">print(net)</span><br></pre></td></tr></table></figure>
<pre><code>Net(
  (conv1): Conv2d(3, 6, kernel_size=(5, 5), stride=(1, 1))
  (pool): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  (conv2): Conv2d(6, 16, kernel_size=(5, 5), stride=(1, 1))
  (fc1): Linear(in_features=400, out_features=120, bias=True)
  (fc2): Linear(in_features=120, out_features=84, bias=True)
  (fc3): Linear(in_features=84, out_features=10, bias=True)
)
</code></pre><h2 id="Define-a-Loss-function-and-opotimizer"><a href="#Define-a-Loss-function-and-opotimizer" class="headerlink" title="Define a Loss function and opotimizer"></a>Define a Loss function and opotimizer</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.SGD(net.parameters(), lr=<span class="number">0.001</span>, momentum=<span class="number">0.9</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Train-the-network"><a href="#Train-the-network" class="headerlink" title="Train the network"></a>Train the network</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">    running_loss = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> enumerate(trainloader, <span class="number">0</span>):</span><br><span class="line">        <span class="comment"># get the inputs </span></span><br><span class="line">        inputs, labels = data </span><br><span class="line">        inputs, labels = inputs.to(device), labels.to(device)</span><br><span class="line">        <span class="comment"># zero the parameter gradients</span></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># forward  + backward + optimize</span></span><br><span class="line">        outputs = net(inputs)</span><br><span class="line">        loss = criterion(outputs, labels)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># print statistics</span></span><br><span class="line">        running_loss += loss.item()</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">2000</span> == <span class="number">1999</span>: <span class="comment"># print every 2000 mini-batches </span></span><br><span class="line">            print(<span class="string">'[%d, %5d] loss: %.3f'</span> % </span><br><span class="line">                 (epoch + <span class="number">1</span>, i + <span class="number">1</span>, running_loss / <span class="number">2000</span>))</span><br><span class="line">            running_loss = <span class="number">0.0</span></span><br><span class="line">print(<span class="string">'Finished Training'</span>)</span><br></pre></td></tr></table></figure>
<pre><code>[1,  2000] loss: 2.217
[1,  4000] loss: 1.855
[1,  6000] loss: 1.672
[1,  8000] loss: 1.570
[1, 10000] loss: 1.506
[1, 12000] loss: 1.461
[2,  2000] loss: 1.370
[2,  4000] loss: 1.369
[2,  6000] loss: 1.340
[2,  8000] loss: 1.323
[2, 10000] loss: 1.276
[2, 12000] loss: 1.279
Finished Training
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dataiter = iter(testloader)</span><br><span class="line">images, labels = dataiter.next()</span><br><span class="line"></span><br><span class="line"><span class="comment"># print images </span></span><br><span class="line">imshow(torchvision.utils.make_grid(images))</span><br><span class="line">plt.show()</span><br><span class="line">print(<span class="string">'GroundTruth: '</span>, <span class="string">' '</span>.join(<span class="string">'%5s'</span> % classes[labels[j]] <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>)))</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/Pytorch_Tutorial_output_42_0.png" alt=""></p>
<pre><code>GroundTruth:    cat  ship  ship plane
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">outputs = net(images)</span><br><span class="line">print(outputs)</span><br></pre></td></tr></table></figure>
<pre><code>tensor([[-0.7807, -1.7329,  0.9516,  1.8043, -1.2077,  0.7349,  1.3615, -1.5412,
          1.0311, -1.7234],
        [ 5.2413,  6.1315, -1.7400, -3.2287, -5.0497, -5.8038, -4.2375, -4.4465,
          7.7529,  4.1842],
        [ 2.7686,  3.8909, -0.7050, -1.7185, -3.2625, -3.2960, -2.2888, -2.6324,
          3.8761,  2.4697],
        [ 4.0929,  1.8480,  0.1962, -1.7907, -1.6931, -3.4538, -2.2210, -3.0694,
          4.5059,  0.7960]], grad_fn=&lt;ThAddmmBackward&gt;)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_, predicted = torch.max(outputs, <span class="number">1</span>)</span><br><span class="line">print(predicted)</span><br><span class="line">print(<span class="string">'Predicted: '</span>, <span class="string">' '</span>.join(<span class="string">'%5s'</span> % classes[predicted[j]] <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">4</span>)))</span><br></pre></td></tr></table></figure>
<pre><code>tensor([3, 8, 1, 8])
Predicted:    cat  ship   car  ship
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">correct = <span class="number">0</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> testloader:</span><br><span class="line">        images, labels = data</span><br><span class="line"><span class="comment">#         print(labels)</span></span><br><span class="line">        outputs = net(images)</span><br><span class="line">        _, predicted = torch.max(outputs.data, <span class="number">1</span>)</span><br><span class="line">        total += labels.size(<span class="number">0</span>)</span><br><span class="line">        correct += (predicted == labels).sum().item()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Accuracy of the network on the 10000 test images: %d %%'</span> % (</span><br><span class="line">    <span class="number">100</span> * correct / total))</span><br></pre></td></tr></table></figure>
<pre><code>Accuracy of the network on the 10000 test images: 54 %
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class_correct = list(<span class="number">0.</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>))</span><br><span class="line">class_total = list(<span class="number">0.</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> testloader:</span><br><span class="line">        images, labels = data</span><br><span class="line">        outputs = net(images)</span><br><span class="line">        _, predicted = torch.max(outputs, <span class="number">1</span>) <span class="comment"># torch.max 可以返回最大值和对应的坐标，np.random.randn只能返回最大值</span></span><br><span class="line">        c = (predicted == labels).squeeze()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            label = labels[i]</span><br><span class="line">            class_correct[label] += c[i].item()</span><br><span class="line">            class_total[label] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    print(<span class="string">'Accuracy of %5s : %2d %%'</span> % (</span><br><span class="line">        classes[i], <span class="number">100</span> * class_correct[i] / class_total[i]))</span><br></pre></td></tr></table></figure>
<pre><code>Accuracy of plane : 55 %
Accuracy of   car : 59 %
Accuracy of  bird : 65 %
Accuracy of   cat : 29 %
Accuracy of  deer : 22 %
Accuracy of   dog : 49 %
Accuracy of  frog : 71 %
Accuracy of horse : 55 %
Accuracy of  ship : 75 %
Accuracy of truck : 62 %
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/Multimodal-Machine-Learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/Multimodal-Machine-Learning/" itemprop="url">多模态机器学习总结与多模态医学图像处理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-03T17:25:45+08:00">
                2018-10-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="多模态机器学习"><a href="#多模态机器学习" class="headerlink" title="多模态机器学习"></a>多模态机器学习</h1><p>下面是我参考文章[1]总结出来多模态机器学习中存在的挑战，以及目前所使用的方法的思维导图。<br><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/Multimodal%20Machine%20Learning.gif" alt=""></p>
<h1 id="多模态医学图像数据集"><a href="#多模态医学图像数据集" class="headerlink" title="多模态医学图像数据集"></a>多模态医学图像数据集</h1><ol>
<li><p>脑肿瘤分割数据集<br>[1] Menze B H, Jakab A, Bauer S, et al. The multimodal brain tumor image segmentation benchmark (BRATS)[J]. IEEE transactions on medical imaging, 2015, 34(10): 1993.<br><a href="https://www.med.upenn.edu/sbia/brats2018.html" target="_blank" rel="noopener">https://www.med.upenn.edu/sbia/brats2018.html</a><br>这个数据集是多模态核磁成像数据集，对肿瘤进行不同尺度的扫描，然后进行多模态分割。</p>
</li>
<li><p>融合数据库<br><a href="http://www.med.harvard.edu/AANLIB/" target="_blank" rel="noopener">http://www.med.harvard.edu/AANLIB/</a><br><a href="http://www.metapix.de/" target="_blank" rel="noopener">http://www.metapix.de/</a></p>
</li>
<li><p>IXI数据库<br><a href="http://brain-development.org/ixi-dataset/" target="_blank" rel="noopener">http://brain-development.org/ixi-dataset/</a><br>这个数据库包含600张MRI图像，可以用于预训练，下面的文章使用了在这个方法。<br>Simonovsky M, Gutiérrez-Becker B, Mateus D, et al. A deep metric for multimodal registration[C]//International Conference on Medical Image Computing and Computer-Assisted Intervention. Springer, Cham, 2016: 10-18.</p>
</li>
<li><p>Radiology Objects in COntext<br><a href="https://github.com/razorx89/roco-dataset" target="_blank" rel="noopener">https://github.com/razorx89/roco-dataset</a><br>可以用于训练生成模型生成图片标题，用于分类图片的分类模型，还有基于内容的图像检索。</p>
</li>
<li><p>Grand Challenges in Biomedical Image Analysis<br><a href="https://grand-challenge.org/" target="_blank" rel="noopener">https://grand-challenge.org/</a><br>这个网站是对已经发表的论文或者是目前使用的算法提供一个竞赛的平台，里面有很多公开的医学图像数据集，其中包括1， 6， 7中的数据集。</p>
</li>
<li><p>Motion Tracking Challenge<br><a href="http://stacom.cardiacatlas.org/motion-tracking-challenge/" target="_blank" rel="noopener">http://stacom.cardiacatlas.org/motion-tracking-challenge/</a><br>这个数据库中包含有MRI和3D ultrasound 两个模态的图像。</p>
</li>
<li><p>​Automatic Intervertebral Disc Localization and Segmentation from 3D Multi-modality MR (M3) Images<br><a href="https://ivdm3seg.weebly.com/data.html" target="_blank" rel="noopener">https://ivdm3seg.weebly.com/data.html</a><br>这个数据集是MRI图像，用于定位和分割。</p>
</li>
<li><p>一些数据集<br><a href="https://sites.google.com/site/aacruzr/image-datasets" target="_blank" rel="noopener">https://sites.google.com/site/aacruzr/image-datasets</a></p>
</li>
<li><p>Image Registration Evaluation Project<br><a href="http://www.insight-journal.org/rire/" target="_blank" rel="noopener">http://www.insight-journal.org/rire/</a><br>用作image registratration效果评价的数据集</p>
</li>
<li><p>DICOM image sample sets<br>有一些数据供下载，部分是多模态的，数量比较少，只是一些例子，另外，看起来是注册是要收费的样子。</p>
</li>
<li><p><a href="https://ida.loni.usc.edu/login.jsp" target="_blank" rel="noopener">https://ida.loni.usc.edu/login.jsp</a><br>一些脑神经科学的医学图像数据库</p>
</li>
<li><p>ANDI(阿尔兹海默症)<br><a href="http://adni.loni.usc.edu/data-samples/access-data/" target="_blank" rel="noopener">http://adni.loni.usc.edu/data-samples/access-data/</a></p>
</li>
<li><p>Cancer Imaging Archive<br><a href="http://www.cancerimagingarchive.net/" target="_blank" rel="noopener">http://www.cancerimagingarchive.net/</a></p>
</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] Baltrušaitis T, Ahuja C, Morency L P. Multimodal machine learning: A survey and taxonomy[J]. IEEE Transactions on Pattern Analysis and Machine Intelligence, 2018.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/26/汇报list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/26/汇报list/" itemprop="url">汇报list</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-26T16:43:47+08:00">
                2018-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工作/" itemprop="url" rel="index">
                    <span itemprop="name">工作</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="2018-9-10"><a href="#2018-9-10" class="headerlink" title="2018.9.10"></a>2018.9.10</h1><p>暑假期间学习和看的论文：<br>学习内容：</p>
<ol>
<li>计算视觉CS131，完成了所有的homework的代码，然后传到了我的github上了。<a href="https://github.com/hjyai94/CS131_homework" target="_blank" rel="noopener">https://github.com/hjyai94/CS131_homework</a></li>
<li>计算机视觉CS231看了一点，还没有看完。</li>
<li>最近在看的深度学习和贝叶斯方法结合的一门课(<a href="http://deepbayes.ru/)，实现了一个EM算法去除噪声的代码。" target="_blank" rel="noopener">http://deepbayes.ru/)，实现了一个EM算法去除噪声的代码。</a></li>
</ol>
<p>看的论文：<br>[1] Deep Learning Markov Random Field for Semantic Segmentation<br>[2] Single Image Haze Removal Method Using Conditional Random Fields<br>[3] DehazeNet: An End-to-End System for Single Image Haze Removal</p>
<h1 id="2018-9-27"><a href="#2018-9-27" class="headerlink" title="2018.9.27"></a>2018.9.27</h1><p>最近看多模态的课，然后那个课上有一些论文作为阅读材料，最近主要看这些论文。</p>
<p>[1] Zeiler M D, Fergus R. Visualizing and understanding convolutional networks[C]//European conference on computer vision. Springer, Cham, 2014: 818-833.</p>
<ol>
<li>卷积神经网络确实可以学到层级的特征。</li>
<li>卷积核和步长越大，网络中保存的信息就越少。</li>
</ol>
<p>[2] Frome A, Corrado G S, Shlens J, et al. Devise: A deep visual-semantic embedding model[C]//Advances in neural information processing systems. 2013: 2121-2129.<br>这篇文章就是用图像和文本来做分类的问题，就是利用一个视觉模型加上一个文本模型，对于超出训练集的样本也能给出比较好的分类。</p>
<p>[3] Kulkarni T D, Whitney W F, Kohli P, et al. Deep convolutional inverse graphics network[C]//Advances in neural information processing systems. 2015: 2539-2547.<br>有两个层Encoder和Decoder,在两层之间增加了一个Graphics code，用来表示图片的变化，比如姿态、角度。</p>
<p>[4] Andrew G, Arora R, Bilmes J, et al. Deep canonical correlation analysis[C]//International Conference on Machine Learning. 2013: 1247-1255.<br>将两个神经网络看成两个非线性函数，分别来处理两个模态的数据，最大化网络输出的典型相关性。</p>
<h1 id="2018-10-11"><a href="#2018-10-11" class="headerlink" title="2018.10.11"></a>2018.10.11</h1><p>多模态医学图像分析<br>论文：<br>[1] Baltruaitis T, Ahuja C, Morency L P. Multimodal machine learning: A survey and taxonomy[J]. IEEE Transactions on Pattern Analysis and Machine Intelligence, 2018.<br>这是一篇综述多模态机器学习的综述文章，我画了这篇文章的思维导图。<br> <img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/Multimodal%20Machine%20Learning.gif" alt=""></p>
<p>[2] Cheng X, Zhang L, Zheng Y. Deep similarity learning for multimodal medical images[J]. Computer Methods in Biomechanics and Biomedical Engineering: Imaging &amp; Visualization, 2018, 6(3): 248-252.<br>用了一个所谓的Stacked Denosing Autoencoder 来预训练DNN，用了一个5层的全连接神经网络，将不同模态在第四层输出的差作为相似性矩阵。</p>
<p>[3] Zhang Z, Yang L, Zheng Y. Translating and segmenting multimodal medical volumes with cycle-and shape-consistency generative adversarial network[C]//Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition. 2018: 9242-9251.<br>利用GAN合成数据来提高分割性能，不过GAN合成的数据的分布与实际数据分布是接近的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/典型相关性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/典型相关性/" itemprop="url">典型相关性(Canonical Correlation Analysis)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-25T16:50:32+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>给定带有有限距的随机变量的列向量$X = (x_1, …, x_n)^T$和$Y = (y_1, …, y_m)^T$，我们可以定义互协方差矩阵$\Sigma_{XY} = cov(X, Y)$，为$n\times m$的矩阵，其中$(i, j)$是协方差矩阵$cov(x_i, y_j)$。实际上，我们可以基于$X$和$Y$的采样数据来估计协方差矩阵。<br>典型相关性(Canonical Correlation Analysis)是求出向量$a$和$b$使得随机变量$a^T X$和$b^T Y$的相关性$\rho = corr(a^T X, b^T Y)$最大。随机变量$U = a^T X$和$V = b^T Y$是第一对典型变量。然后寻求一个依然最大化相关但与第一对典型不相关的向量；这样就得到了第二对典型变量。这个步骤会进行$min\lbrace m, n\rbrace$。</p>
<h1 id="典型相关性"><a href="#典型相关性" class="headerlink" title="典型相关性"></a>典型相关性</h1><ol>
<li><p>学习两个线性映射，每个线性映射对应于一组数据，使得两组数据最大相关性。<br>\begin{equation}\begin{split} (u^{\star}, v^{\star}) &amp;= argmax_{u, v} corr(u^T X, v^T Y) \\<br>&amp;= argmax_{u, v} \frac{cov(u^T X, v^T Y)}{\sqrt{var(u^T X) var(v^T Y)}} \\<br>&amp;= argmax_{u, v} \frac{u^T E(X Y^T)v}{\sqrt{u^T E(X X^T) u v^T E(Y Y^T) v}} \\<br>&amp;= argmax_{u, v} \frac{u^T \Sigma_{XY} v}{\sqrt{u^T \Sigma_{XX} u v^T \Sigma_{YY} v}} \\<br>\end{split}\end{equation}</p>
</li>
<li><p>我们希望获得多个映射矩阵，同时多个线性映射对是相互正交的。<br>$$ u_{(i)}^T \Sigma_{XY} v_{(j)} = u_{(j)}^T \Sigma_{XY} v_{(i)} = 0\  \text {for}\ i\neq j$$<br>$$ U\Sigma_{XY}V = tr(U\Sigma_{XY} V) $$<br>其中$U = [u_1, u_2, …, u_k]$和$V = [v_1, v_2, …, v_k] $。<br>$$(U^{\star}, V^{\star}) = argmax_{U, V}\frac{tr(U^T\Sigma_{XY} V)}{\sqrt{U^T\Sigma_{XX} U} \sqrt{V^T \Sigma_{YY} V}}$$</p>
</li>
<li><p>因为上式中分子分布增大相同的倍数，优化目标的结果不变，所以我们采用类似$SVM$中类似的优化方法，固定分母，优化分子，具体转化为[2]：<br>\begin{cases}<br>argmax_{U, V} = U^T\Sigma_{XY} V \\<br>\text{s.t.}\ U^T \Sigma_{XX} U = I, V^T \Sigma_{YY} V= I \\<br>\end{cases}<br>这样就变成了有约束的最优化问题，可以使用拉格朗日乘子法，也可以采用$SVD$分解的方法。</p>
</li>
</ol>
<ul>
<li>拉格朗日乘子法<br>$$ L = tr(U^T \Sigma_{XY} V) - \alpha  (U^T \Sigma_{XX} U - I)  - \beta (V^T \Sigma_{YY} V - I) $$<br>对$U$和$V$分别求偏导并令其为0：<br>\begin{cases}<br>\Sigma_{XY} V = 2\alpha \Sigma_{XX} U \\<br>\Sigma_{XY}^T U = 2 \beta \Sigma_{YY} V \\<br>\end{cases}</li>
</ul>
<p>对上式分别左乘$U^T$和$V^T$，可以得出$2\alpha = 2\beta = U^T \Sigma_{XY} V $<br>将前面的式子再分别左乘$\Sigma_{XX}^{-1}$和$\Sigma_{YY}^{-1}$，然后通过分别消除变量可以得出下面的结果：<br>$$ \Sigma_{XX}\Sigma_{XY}\Sigma_{YY}^{-1}\Sigma^T_{XY}U = \lambda U $$<br>$$ \Sigma_{YY}\Sigma_{XY}\Sigma_{XX}^{-1}\Sigma^T_{XY}V = \lambda V $$<br>其中$$\lambda = 4\alpha \beta $$<br>只要求出对应特征值最大的特征向量，这样就解出$U$和$V$。</p>
<ul>
<li>SVD<br>令$ U = \Sigma_{XX}^{-\frac{1}{2}} u$，$V = \Sigma_{YY}^{-\frac{1}{2}} v $。<br>由$U^T \Sigma_{XX} U = I$和$ V^T \Sigma_{YY} V= I$，可以得出：$ u^T u = I $ $v^T v = I $<br>将原本的最优化问题转化为这样的形式：<br>\begin{cases}<br>argmax_{u, v} = u^T\Sigma_{XX}^{-\frac{1}{2}} \Sigma_{XY} \Sigma_{YY}^{-\frac{1}{2}} v \\<br>\text{s.t.}\ u^T u = I, v^T v = I  \\<br>\end{cases}<br>使用$SVD$就是通过最大化对应的奇异值的特征向量，就是对应的$u$和$v$的结果。<br>$$ T = \Sigma_{XX}^{-\frac{1}{2}}\Sigma_{XY} \Sigma_{YY}^{-\frac{1}{2}}  $$<br>$$ (U^{\star}, V^{\star}) = (\Sigma_{XX}^{-\frac{1}{2}}U_{SVD}, \Sigma_{YY}^{-\frac{1}{2}} V_{SVD}) $$</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a href="https://zh.wikipedia.org/wiki/典型相关" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/典型相关</a><br>[2] <a href="https://blog.csdn.net/Mbx8X9u/article/details/78824216" target="_blank" rel="noopener">https://blog.csdn.net/Mbx8X9u/article/details/78824216</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/05/EM算法程序实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/05/EM算法程序实现/" itemprop="url">EM算法实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-05T10:42:01+08:00">
                2018-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="EM算法"><a href="#EM算法" class="headerlink" title="EM算法"></a>EM算法</h1><p>之前在看概率图模型的时候，写过关于EM算法的内容，不过已经忘记差不多了，最近在看[1]中的材料，感觉有了新的理解，特将这些内容整理成这篇博客。<br>EM算法适用于存在隐变量的情况，或者说是假设存在因变量对系统进行推导。<br>\begin{equation}\begin{split} log\ p(X\mid \theta) &amp;= \int q(Z)log\ p(X\mid \theta)dZ \\<br>&amp;= \int q(Z)log \frac{p(X, Z\mid \theta)}{p(Z\mid X, \theta)}dZ \\<br>&amp;= \int q(Z)log \frac{p(X, Z\mid \theta)}{q(Z)}dZ + \int q(Z) log \frac{q(Z)}{p(Z\mid X, \theta)}dZ\\<br>&amp;= L(q, \theta) + KL(q\mid\mid p) \geqslant L(q, \theta)\\<br>\end{split}\end{equation}<br><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/EM%E7%AE%97%E6%B3%95.png" alt=""><br>E步是为了获得隐变量的最优值，M步是对参数求最大似然。</p>
<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a><a href="https://cw.fel.cvut.cz/old/courses/ae4b33rpz/labs/12_em/start" target="_blank" rel="noopener">问题描述</a></h1><p>有$K$张受噪声污染的图片，每张图片大小为$H\times W$，每张图片上都有$H\times w$大小的人脸，每张人脸的位置不固定，但是高度相同，都与图片的高度一样。如下图所示，每张图片都是受严重受噪声污染的，可以看成是高斯噪声。可以从这里得到<a href="https://drive.google.com/open?id=1NLOHNhqdDBG6rWk8lOjzm3u3vDyS_9WZ" target="_blank" rel="noopener">数据集</a>，该数据集为.mat格式，其中包含有500张$45\times 60$的图片，其中人脸大小为$45\times 36$<br><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/EM%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/%E5%99%AA%E5%A3%B0%E5%9B%BE%E7%89%87.png" alt=""><br>下图是图片的结构，其中$d_k$的位置是不固定的，$F$是不含噪声的人脸图片，$B$是不含噪声的背景图片。<br><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/EM%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/%E5%9B%BE%E7%89%87%E7%BB%93%E6%9E%84.png" alt=""><br>下面基于EM算法来思考该问题：<br>可观数据：$K$张受污染的图片，$X = \lbrace X_1, …, X_K \rbrace$<br>隐变量：$F$的位置，$d = \lbrace d_1, …, d_K \rbrace$<br>参数：$\theta = \lbrace B, F, s^2\rbrace$<br>似然函数：<br>$$ p(X_k\mid d_k, \theta) = \prod_{ij}\begin{cases} N(X_k[i, j]\mid F[i,j-d_k], s^2), &amp; \text {if $[i, j]\in faceArea(d_k)$} \\ N(X_k[i, j]\mid B[i, j], s^2), &amp; \text{otherwise} \end{cases} $$<br>因为每张图片中$F$和$B$部分减去对应的$F$和$B$，这样就是纯粹的噪声，我们将噪声看做是高斯分布，所以上式就是上面的形式。<br>以及先验：<br>$p(d_k\mid a) = a[d_k] $， $\sum_j a[j] = 1$,，$a\in R^{W-w+1}$<br>概率模型可以写成：<br>$$ p(X, d\mid \theta, a) = \prod_k p(X_k\mid d_k, \theta)p(d_k\mid a) $$<br>按照第一张图中的EM算法步骤，进行EM算法的推导：<br>E步：确定隐变量的最优值<br>\begin{equation}\begin{split} q(d) = p(d\mid X, \theta, a) &amp;= \prod_k p(d_k\mid x_k, \theta, a)\\<br>&amp;= \prod_k\frac{p(X_k, d_k\mid \theta, a)}{\sum_{d_k’} p(X_k, d_k’\mid \theta, a)} \\<br>&amp;= \prod_k\frac{p(X_k\mid d_k, theta)p(d_k\mid a)}{\sum_{d_k’} p(X_k\mid d_k’, theta)p(d_k’\mid a)} \\<br>\end{split}\end{equation}<br>M步：对参数求最大似然。<br>$$ Q(\theta, a) = E_{q(d)}log\ p(X, d\mid \theta, a) \rightarrow max_{\theta, a} $$<br>具体推导这里就不再详细的描述了，可以参照参考文献[1]中的推导过程，最后的推导结果如下：<br>$$a[j] = \frac{\sum_k q( d_k = j )}{\sum_{j’}  \sum_{k’} q( d_{k’} = j’)}$$<br>$$F[i, m] = \frac 1 K  \sum_k \sum_{d_k} q(d_k)\, X^k[i,\, m+d_k]$$<br>$$B[i, j] = \frac {\sum_k \sum_{ d_k:\, (i, \,j) \,\not\in faceArea(d_k)} q(d_k)\, X^k[i, j]}<br>          {\sum_k \sum_{d_k: \,(i, \,j)\, \not\in faceArea(d_k)} q(d_k)}$$<br>$$s^2 = \frac 1 {HWK}   \sum_k \sum_{d_k} q(d_k)<br>          \sum_{i,\, j}  (X^k[i, \,j] - Model^{d_k}[i, \,j])^2$$<br> 其中$Model^{d_k}[i, j]$表示由$F$和$B$组成的图片，其中$F$处于$d_k$位置。</p>
<h1 id="程序实现"><a href="#程序实现" class="headerlink" title="程序实现"></a>程序实现</h1><p>下面用EM算法来是处理对受噪声污染影响的图片，从而恢复其中的人脸图像。<br>程序思路为</p>
<ol>
<li>实现对数似然；</li>
<li>实现variational lower bound；</li>
<li>实现E步；</li>
<li>实现M步；</li>
<li>将循环执行EM步，知道满足结束条件。<h2 id="具体程序"><a href="#具体程序" class="headerlink" title="具体程序"></a>具体程序</h2></li>
</ol>
<ul>
<li><p>实现对数似然，似然函数为：$$ p(X_k\mid d_k, \theta) = \prod_{ij}\begin{cases} N(X_k[i, j]\mid F[i,j-d_k], s^2), &amp; \text {if $[i, j]\in faceArea(d_k)$} \\ N(X_k[i, j]\mid B[i, j], s^2), &amp; \text{otherwise} \end{cases} $$</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">def calculate_log_probability(X, F, B, s):</span><br><span class="line">    <span class="string">""</span>"</span><br><span class="line">    Calculates <span class="keyword">log</span> p(X_k|d_k, F, B, s) <span class="keyword">for</span> all images X_k <span class="keyword">in</span> X and</span><br><span class="line">    all possible face position d_k.</span><br><span class="line"></span><br><span class="line">    Parameters</span><br><span class="line">    ----------</span><br><span class="line">    X : array, shape (<span class="keyword">H</span>, W, K)</span><br><span class="line">        K images of size <span class="keyword">H</span> x W.</span><br><span class="line">    F : array, shape (<span class="keyword">H</span>, w)</span><br><span class="line">        Estimate of prankster's face.</span><br><span class="line">    B : array, shape (<span class="keyword">H</span>, W)</span><br><span class="line">        Estimate of background.</span><br><span class="line">    s : float</span><br><span class="line">        Estimate of standard deviation of Gaussian noise.</span><br><span class="line"></span><br><span class="line">    Returns</span><br><span class="line">    -------</span><br><span class="line">    ll : array, shape(W-w+1, K)</span><br><span class="line">        ll[dw, k] - <span class="keyword">log</span>-likelihood of observing image X_k given</span><br><span class="line">        that the prankster's face F is located at position dw</span><br><span class="line">    <span class="string">""</span>"</span><br><span class="line">    # your code here</span><br><span class="line">    <span class="keyword">H</span>, W, K = np.shape(X)</span><br><span class="line">    _, w = np.shape(F)</span><br><span class="line">    ll = np.zeros((W-w+1, K), dtype=float)</span><br><span class="line">    <span class="keyword">for</span> dw <span class="keyword">in</span> <span class="keyword">range</span>(W-w+1):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="keyword">range</span>(K):</span><br><span class="line">            ll[dw, k] = <span class="keyword">H</span>*w*np.<span class="built_in">log</span>(1/(s*np.<span class="built_in">sqrt</span>(2*np.pi))) - np.<span class="built_in">sum</span>((X[:, dw:dw+w, k] - F)**2/(2 * s**2)) + \</span><br><span class="line">            <span class="keyword">H</span>*dw*np.<span class="built_in">log</span>(1/(s*np.<span class="built_in">sqrt</span>(2*np.pi))) - np.<span class="built_in">sum</span>((X[:, 0:dw, k] - B[:, 0:dw])**2/(2 * s**2)) + \</span><br><span class="line">            <span class="keyword">H</span>*(W-w-dw)*np.<span class="built_in">log</span>(1/(s*np.<span class="built_in">sqrt</span>(2*np.pi))) - np.<span class="built_in">sum</span>((X[:, dw+w:, k] - B[:, dw+w:])**2/(2 * s**2))</span><br><span class="line">    <span class="keyword">return</span> ll</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现Variational lower bound</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_lower_bound</span><span class="params">(X, F, B, s, a, q)</span>:</span></span><br><span class="line">   <span class="string">"""</span></span><br><span class="line"><span class="string">   Calculates the lower bound L(q, F, B, s, a) for</span></span><br><span class="line"><span class="string">   the marginal log likelihood.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   Parameters</span></span><br><span class="line"><span class="string">   ----------</span></span><br><span class="line"><span class="string">   X : array, shape (H, W, K)</span></span><br><span class="line"><span class="string">       K images of size H x W.</span></span><br><span class="line"><span class="string">   F : array, shape (H, w)</span></span><br><span class="line"><span class="string">       Estimate of prankster's face.</span></span><br><span class="line"><span class="string">   B : array, shape (H, W)</span></span><br><span class="line"><span class="string">       Estimate of background.</span></span><br><span class="line"><span class="string">   s : float</span></span><br><span class="line"><span class="string">       Estimate of standard deviation of Gaussian noise.</span></span><br><span class="line"><span class="string">   a : array, shape (W-w+1)</span></span><br><span class="line"><span class="string">       Estimate of prior on position of face in any image.</span></span><br><span class="line"><span class="string">   q : array</span></span><br><span class="line"><span class="string">       q[dw, k] - estimate of posterior</span></span><br><span class="line"><span class="string">                  of position dw</span></span><br><span class="line"><span class="string">                  of prankster's face given image Xk</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   Returns</span></span><br><span class="line"><span class="string">   -------</span></span><br><span class="line"><span class="string">   L : float</span></span><br><span class="line"><span class="string">       The lower bound L(q, F, B, s, a)</span></span><br><span class="line"><span class="string">       for the marginal log likelihood.</span></span><br><span class="line"><span class="string">   """</span></span><br><span class="line">   <span class="comment"># your code here</span></span><br><span class="line">   ll = calculate_log_probability(X, F, B, s)</span><br><span class="line">   L = np.sum(q*ll) + np.sum(q.T*np.log(a)) - np.sum(q*np.log(q))</span><br><span class="line">   <span class="keyword">return</span> L</span><br></pre></td></tr></table></figure>
</li>
<li><p>E步</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_e_step</span><span class="params">(X, F, B, s, a)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Given the current esitmate of the parameters, for each image Xk</span></span><br><span class="line"><span class="string">    esitmates the probability p(d_k|X_k, F, B, s, a).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    X : array, shape(H, W, K)</span></span><br><span class="line"><span class="string">        K images of size H x W.</span></span><br><span class="line"><span class="string">    F  : array_like, shape(H, w)</span></span><br><span class="line"><span class="string">        Estimate of prankster's face.</span></span><br><span class="line"><span class="string">    B : array shape(H, W)</span></span><br><span class="line"><span class="string">        Estimate of background.</span></span><br><span class="line"><span class="string">    s : float</span></span><br><span class="line"><span class="string">        Eestimate of standard deviation of Gaussian noise.</span></span><br><span class="line"><span class="string">    a : array, shape(W-w+1)</span></span><br><span class="line"><span class="string">        Estimate of prior on face position in any image.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    q : array</span></span><br><span class="line"><span class="string">        shape (W-w+1, K)</span></span><br><span class="line"><span class="string">        q[dw, k] - estimate of posterior of position dw</span></span><br><span class="line"><span class="string">        of prankster's face given image Xk</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    <span class="comment"># 使用logsumexp的方法</span></span><br><span class="line">    <span class="comment"># ad = log p(x_k| d_k, F, B, s) + log p(d_k,|a)</span></span><br><span class="line">    <span class="comment"># d* = argmax_d&#123;ad&#125;</span></span><br><span class="line">    <span class="comment"># log \sum exp(ad)= ad* + log\sum_d exp(ad-ad*)</span></span><br><span class="line">    ll = calculate_log_probability(X, F, B, s)</span><br><span class="line">    ad = ll + np.log(a).T.reshape(a.shape[<span class="number">0</span>], <span class="number">1</span>)</span><br><span class="line">    ad_max = np.max(ad, axis=<span class="number">0</span>)</span><br><span class="line">    q = ad - ad_max - np.log(np.sum(np.exp(ad - ad_max), axis=<span class="number">0</span>))</span><br><span class="line">    q = np.exp(q)</span><br><span class="line">    <span class="keyword">return</span> q</span><br></pre></td></tr></table></figure>
</li>
<li><p>M步</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">def run_m_step(X, <span class="keyword">q</span>, w):</span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    Estimates F, B, s, a given esitmate of posteriors defined by q.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    X : array, shape (H, W, K)</span></span><br><span class="line"><span class="string">        K images of size H x W.</span></span><br><span class="line"><span class="string">    q  :</span></span><br><span class="line"><span class="string">        q[dw, k] - estimate of posterior of position dw</span></span><br><span class="line"><span class="string">                   of prankster's face given image Xk</span></span><br><span class="line"><span class="string">    w : int</span></span><br><span class="line"><span class="string">        Face mask width.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    F : array, shape (H, w)</span></span><br><span class="line"><span class="string">        Estimate of prankster's face.</span></span><br><span class="line"><span class="string">    B : array, shape (H, W)</span></span><br><span class="line"><span class="string">        Estimate of background.</span></span><br><span class="line"><span class="string">    s : float</span></span><br><span class="line"><span class="string">        Estimate of standard deviation of Gaussian noise.</span></span><br><span class="line"><span class="string">    a : array, shape (W-w+1)</span></span><br><span class="line"><span class="string">        Estimate of prior on position of face in any image.</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    H, W, K = X.shape</span><br><span class="line">    F = np.zeros((H, w))</span><br><span class="line">    B = np.zeros((H, W))</span><br><span class="line">    <span class="keyword">s</span> = <span class="number">0</span>.<span class="number">0</span></span><br><span class="line">    <span class="comment"># a</span></span><br><span class="line">    a = np.sum(<span class="keyword">q</span>, axis=<span class="number">1</span>)/np.sum(<span class="keyword">q</span>)</span><br><span class="line">    <span class="comment"># F</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">m</span> in range(w):</span><br><span class="line">        <span class="keyword">for</span> k in range(K):</span><br><span class="line">            F[:, <span class="keyword">m</span>] = (<span class="number">1</span>/K*np.sum(<span class="string">q[:, k]</span>*X[:, <span class="keyword">m</span>:W-w+<span class="number">1</span>+<span class="keyword">m</span>, k], axis=<span class="number">1</span>)) + F[:, <span class="keyword">m</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># B</span></span><br><span class="line">    B1 = np.zeros((H, W))</span><br><span class="line">    B2 = np.zeros((H, W))</span><br><span class="line">    <span class="keyword">for</span> dw in range(W-w+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> k in range(K):</span><br><span class="line">            B1[:, :dw] = <span class="string">q[dw, k]</span> * X[:, :dw, k] + B1[:, :dw]</span><br><span class="line">            B1[:, dw+w:] = <span class="string">q[dw, k]</span> * X[:, dw+w:, k] + B1[:, dw+w:]</span><br><span class="line">            B2[:, :dw] = <span class="string">q[dw, k]</span> + B2[:, :dw]</span><br><span class="line">            B2[:, dw+w:] = <span class="string">q[dw, k]</span> + B2[:, dw+w:]</span><br><span class="line"></span><br><span class="line">    B = B1/B2</span><br><span class="line"></span><br><span class="line">    <span class="comment"># s</span></span><br><span class="line">    s_square = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> dw in range(W-w+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> k in range(K):</span><br><span class="line">            s_square = <span class="string">q[dw, k]</span> * (np.sum((X[:, :dw, k] - B[:, :dw])**<span class="number">2</span>) + np.sum((X[:, dw:dw+w, k] - F)**<span class="number">2</span>)+ \</span><br><span class="line">            np.sum((X[:, dw+w:, k] - B[:, dw+w:])**<span class="number">2</span>)) + s_square</span><br><span class="line">    <span class="keyword">s</span> = np.sqrt(<span class="number">1</span>/(K*W*H) *  s_square)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> F, B, <span class="keyword">s</span>, a</span><br></pre></td></tr></table></figure>
</li>
<li><p>对&amp;E&amp;步与&amp;M&amp;步交替运行，当$L(q, \,F, \,B, \,s, \,a)$增加值小于提前设定好的阈值时，程序结束。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">def run_m_step(X, <span class="keyword">q</span>, w):</span><br><span class="line">    <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    Estimates F, B, s, a given esitmate of posteriors defined by q.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters</span></span><br><span class="line"><span class="string">    ----------</span></span><br><span class="line"><span class="string">    X : array, shape (H, W, K)</span></span><br><span class="line"><span class="string">        K images of size H x W.</span></span><br><span class="line"><span class="string">    q  :</span></span><br><span class="line"><span class="string">        q[dw, k] - estimate of posterior of position dw</span></span><br><span class="line"><span class="string">                   of prankster's face given image Xk</span></span><br><span class="line"><span class="string">    w : int</span></span><br><span class="line"><span class="string">        Face mask width.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    -------</span></span><br><span class="line"><span class="string">    F : array, shape (H, w)</span></span><br><span class="line"><span class="string">        Estimate of prankster's face.</span></span><br><span class="line"><span class="string">    B : array, shape (H, W)</span></span><br><span class="line"><span class="string">        Estimate of background.</span></span><br><span class="line"><span class="string">    s : float</span></span><br><span class="line"><span class="string">        Estimate of standard deviation of Gaussian noise.</span></span><br><span class="line"><span class="string">    a : array, shape (W-w+1)</span></span><br><span class="line"><span class="string">        Estimate of prior on position of face in any image.</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    <span class="comment"># your code here</span></span><br><span class="line">    H, W, K = X.shape</span><br><span class="line">    F = np.zeros((H, w))</span><br><span class="line">    B = np.zeros((H, W))</span><br><span class="line">    <span class="keyword">s</span> = <span class="number">0</span>.<span class="number">0</span></span><br><span class="line">    <span class="comment"># a</span></span><br><span class="line">    a = np.sum(<span class="keyword">q</span>, axis=<span class="number">1</span>)/np.sum(<span class="keyword">q</span>)</span><br><span class="line">    <span class="comment"># F</span></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">m</span> in range(w):</span><br><span class="line">        <span class="keyword">for</span> k in range(K):</span><br><span class="line">            F[:, <span class="keyword">m</span>] = (<span class="number">1</span>/K*np.sum(<span class="string">q[:, k]</span>*X[:, <span class="keyword">m</span>:W-w+<span class="number">1</span>+<span class="keyword">m</span>, k], axis=<span class="number">1</span>)) + F[:, <span class="keyword">m</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># B</span></span><br><span class="line">    B1 = np.zeros((H, W))</span><br><span class="line">    B2 = np.zeros((H, W))</span><br><span class="line">    <span class="keyword">for</span> dw in range(W-w+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> k in range(K):</span><br><span class="line">            B1[:, :dw] = <span class="string">q[dw, k]</span> * X[:, :dw, k] + B1[:, :dw]</span><br><span class="line">            B1[:, dw+w:] = <span class="string">q[dw, k]</span> * X[:, dw+w:, k] + B1[:, dw+w:]</span><br><span class="line">            B2[:, :dw] = <span class="string">q[dw, k]</span> + B2[:, :dw]</span><br><span class="line">            B2[:, dw+w:] = <span class="string">q[dw, k]</span> + B2[:, dw+w:]</span><br><span class="line"></span><br><span class="line">    B = B1/B2</span><br><span class="line"></span><br><span class="line">    <span class="comment"># s</span></span><br><span class="line">    s_square = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> dw in range(W-w+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> k in range(K):</span><br><span class="line">            s_square = <span class="string">q[dw, k]</span> * (np.sum((X[:, :dw, k] - B[:, :dw])**<span class="number">2</span>) + np.sum((X[:, dw:dw+w, k] - F)**<span class="number">2</span>)+ \</span><br><span class="line">            np.sum((X[:, dw+w:, k] - B[:, dw+w:])**<span class="number">2</span>)) + s_square</span><br><span class="line">    <span class="keyword">s</span> = np.sqrt(<span class="number">1</span>/(K*W*H) *  s_square)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> F, B, <span class="keyword">s</span>, a</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>最终实验结果，人脸图片和背景图如下所示：<br><img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/EM%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/%E4%BA%BA%E8%84%B81.png" alt="">  <img src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/EM%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/%E8%83%8C%E6%99%AF1.png" alt=""></p>
<h1 id="问题与总结"><a href="#问题与总结" class="headerlink" title="问题与总结"></a>问题与总结</h1><p>变成中遇到了一个问题，就是求解q时会出现0的情况，这样就会导致$log\ 0$的情况出现，出现错误，不知道怎么结果，但是结果却可以跑出了，不过图片并不是特别清晰，我想如果用deep learning的方法训练估计可以达到一个比较好的结果。EM算法可以看成特殊的坐标下降发，对lower bound按照隐变量和参数进行坐标寻优。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] <a href="http://deepbayes.ru/" target="_blank" rel="noopener">http://deepbayes.ru/</a> 主要来自其中的slide<br>[2] <a href="https://cw.fel.cvut.cz/old/courses/ae4b33rpz/labs/12_em/start" target="_blank" rel="noopener">https://cw.fel.cvut.cz/old/courses/ae4b33rpz/labs/12_em/start</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="HJY" />
            
              <p class="site-author-name" itemprop="name">HJY</p>
              <p class="site-description motion-element" itemprop="description">HJY的装逼小站</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hjyai94" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HJY</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.3"></script>



  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
