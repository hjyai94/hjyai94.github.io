<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="This project is a segmentation model to diagnose brain tumor (Complete, Core) using BraTS 2016, 2017 dataset.BraTS has always been focusing on the evaluation of">
<meta property="og:type" content="article">
<meta property="og:title" content="HJY">
<meta property="og:url" content="http://yoursite.com/2018/12/14/Brats/index.html">
<meta property="og:site_name" content="HJY">
<meta property="og:description" content="This project is a segmentation model to diagnose brain tumor (Complete, Core) using BraTS 2016, 2017 dataset.BraTS has always been focusing on the evaluation of state-of-the-art methods for the segmen">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-12-14T06:44:24.347Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HJY">
<meta name="twitter:description" content="This project is a segmentation model to diagnose brain tumor (Complete, Core) using BraTS 2016, 2017 dataset.BraTS has always been focusing on the evaluation of state-of-the-art methods for the segmen">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'HR62QHMRVP',
      apiKey: '5003cc57039452aa0e152bdb9198ed17',
      indexName: 'dev_NAME',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/12/14/Brats/"/>





  <title> | HJY</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HJY</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">昨夜西风凋碧树，独上高楼望尽天涯路。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/14/Brats/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HJY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HJY">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline"></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-14T14:37:38+08:00">
                2018-12-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>This project is a segmentation model to diagnose brain tumor (Complete, Core) using BraTS 2016, 2017 dataset.<br>BraTS has always been focusing on the evaluation of state-of-the-art methods for the segmentation of brain tumors in multimodal magnetic resonance imaging (MRI) scans. BraTS 2018 utilizes multi-institutional pre- operative MRI scans and focuses on the segmentation of intrinsically heterogeneous (in appearance, shape, and histology) brain tumors, namely gliomas. Furthemore, to pinpoint the clinical relevance of this segmentation task, BraTS’18 also focuses on the prediction of patient overall survival, via integrative analyses of radiomic features and machine learning algorithms.You can check this project in this link：<a href="https://github.com/JooHyun-Lee/BraTs" target="_blank" rel="noopener">https://github.com/JooHyun-Lee/BraTs</a></p>
<h1 id="models"><a href="#models" class="headerlink" title="models"></a>models</h1><h2 id="init-py"><a href="#init-py" class="headerlink" title="__init__.py"></a>__init__.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.optim <span class="keyword">import</span> Adam, SGD</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .unet <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .pspnet <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> .deeplab <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sys.path.append(os.path.dirname(os.path.abspath(os.path.dirname(__file__))))</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_model</span><span class="params">(args, class_num, mode)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Device Init</span></span><br><span class="line">    device = config.device</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model Init</span></span><br><span class="line">    <span class="keyword">if</span> args.model == <span class="string">'unet'</span>:</span><br><span class="line">        net = UNet(args.in_channel, class_num, drop_rate=args.drop_rate)</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'pspnet_squeeze'</span>:</span><br><span class="line">        net = pspnet_squeeze()</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'pspnet_res18'</span>:</span><br><span class="line">        net = pspnet_res18()</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'pspnet_res34'</span>:</span><br><span class="line">        net = pspnet_res34()</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'pspnet_res50'</span>:</span><br><span class="line">        net = pspnet_res50()</span><br><span class="line">    <span class="keyword">elif</span> args.model == <span class="string">'deeplab'</span>:</span><br><span class="line">        net = Deeplab_V3_Plus()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'args.model ERROR'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Optimizer Init</span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">'train'</span>:</span><br><span class="line">        resume = args.resume</span><br><span class="line">        <span class="comment">#optimizer = Adam(net.parameters(), lr=args.lr)</span></span><br><span class="line">        optimizer = SGD(net.parameters(), lr=args.lr, momentum=<span class="number">0.9</span>, weight_decay=<span class="number">1e-4</span>)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">'test'</span>:</span><br><span class="line">        resume = <span class="keyword">True</span></span><br><span class="line">        optimizer = <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'load_model mode ERROR'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model Load</span></span><br><span class="line">    <span class="keyword">if</span> resume:</span><br><span class="line">        checkpoint = Checkpoint(net, optimizer)</span><br><span class="line">        checkpoint.load(os.path.join(args.ckpt_root, args.model+<span class="string">'.tar'</span>))</span><br><span class="line">        best_score = checkpoint.best_score</span><br><span class="line">        start_epoch = checkpoint.epoch+<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        best_score = <span class="number">0</span></span><br><span class="line">        start_epoch = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> device == <span class="string">'cuda'</span>:</span><br><span class="line">        net.cuda()</span><br><span class="line">        net = torch.nn.DataParallel(net)</span><br><span class="line">        torch.backends.cudnn.benchmark=<span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> net, optimizer, best_score, start_epoch</span><br></pre></td></tr></table></figure>
<h2 id="deeplab-py"><a href="#deeplab-py" class="headerlink" title="deeplab.py"></a>deeplab.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn.functional <span class="keyword">import</span> softmax, interpolate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"><span class="comment">#                                       #</span></span><br><span class="line"><span class="comment">#   ResNet for DeepLab v3+ Backbone     #</span></span><br><span class="line"><span class="comment">#                                       #</span></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv1x1</span><span class="params">(in_planes, out_planes, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>, bias=<span class="keyword">False</span>),</span><br><span class="line">        nn.BatchNorm2d(out_planes),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv3x3</span><span class="params">(in_planes, out_planes, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="keyword">False</span>),</span><br><span class="line">        nn.BatchNorm2d(out_planes),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv3x3_simple</span><span class="params">(in_planes, out_planes, stride=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">3</span>, stride=stride,</span><br><span class="line">                     padding=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv5x5</span><span class="params">(in_planes, out_planes, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">5</span>, stride=<span class="number">1</span>, padding=<span class="number">2</span>, bias=<span class="keyword">False</span>),</span><br><span class="line">        nn.BatchNorm2d(out_planes),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">atrous_conv</span><span class="params">(in_planes, out_planes, atrous_rate, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>,</span><br><span class="line">                  padding=atrous_rate, dilation=atrous_rate, bias=<span class="keyword">False</span>),</span><br><span class="line">        nn.BatchNorm2d(out_planes),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicBlock</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes, planes, stride=<span class="number">1</span>, downsample=None, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(BasicBlock, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        self.conv1 = conv3x3_simple(inplanes, planes, stride)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.conv2 = conv3x3_simple(planes, planes)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bottleneck</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes, planes, stride=<span class="number">1</span>, downsample=None, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(Bottleneck, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        self.conv1 = nn.Conv2d(inplanes, planes, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=stride,</span><br><span class="line">                               padding=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv3 = nn.Conv2d(planes, planes * <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(planes * <span class="number">4</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, block, layers, num_classes=<span class="number">1000</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(ResNet, self).__init__()</span><br><span class="line">        self.expansion = block.expansion</span><br><span class="line">        self.inplanes = <span class="number">64</span></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(<span class="number">64</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.maxpool = nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.layer1 = self._make_layer(block, <span class="number">64</span>, layers[<span class="number">0</span>], drop_rate=drop_rate)</span><br><span class="line">        self.layer2 = self._make_layer(block, <span class="number">128</span>, layers[<span class="number">1</span>], stride=<span class="number">2</span>, drop_rate=drop_rate)</span><br><span class="line">        self.layer3 = self._make_layer(block, <span class="number">256</span>, layers[<span class="number">2</span>], stride=<span class="number">2</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line">        self.low_conv = nn.Conv2d(<span class="number">64</span>*block.expansion, <span class="number">64</span>, kernel_size=<span class="number">3</span>,</span><br><span class="line">                                  stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.atr_conv1 = atrous_conv(<span class="number">256</span>*block.expansion,<span class="number">128</span>,<span class="number">1</span>)</span><br><span class="line">        self.atr_conv2 = atrous_conv(<span class="number">256</span>*block.expansion,<span class="number">128</span>,<span class="number">2</span>)</span><br><span class="line">        self.atr_conv3 = atrous_conv(<span class="number">256</span>*block.expansion,<span class="number">128</span>,<span class="number">4</span>)</span><br><span class="line">        self.atr_conv4 = atrous_conv(<span class="number">256</span>*block.expansion,<span class="number">128</span>,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">                n = m.kernel_size[<span class="number">0</span>] * m.kernel_size[<span class="number">1</span>] * m.out_channels</span><br><span class="line">                m.weight.data.normal_(<span class="number">0</span>, math.sqrt(<span class="number">2.</span> / n))</span><br><span class="line">            <span class="keyword">elif</span> isinstance(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_layer</span><span class="params">(self, block, planes, blocks, stride=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        downsample = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> self.inplanes != planes * block.expansion:</span><br><span class="line">            downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(self.inplanes, planes * block.expansion,</span><br><span class="line">                          kernel_size=<span class="number">1</span>, stride=stride, bias=<span class="keyword">False</span>),</span><br><span class="line">                nn.BatchNorm2d(planes * block.expansion),</span><br><span class="line">                nn.Dropout2d(p=drop_rate)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        layers = []</span><br><span class="line">        layers.append(block(self.inplanes, planes, stride, downsample, drop_rate=drop_rate))</span><br><span class="line">        self.inplanes = planes * block.expansion</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, blocks):</span><br><span class="line">            layers.append(block(self.inplanes, planes, drop_rate=drop_rate))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        x = self.bn1(x)</span><br><span class="line">        x = self.relu(x)</span><br><span class="line">        x = self.maxpool(x)</span><br><span class="line">        low_x = self.layer1(x)</span><br><span class="line">        x = self.layer2(low_x)</span><br><span class="line">        x = self.layer3(x)</span><br><span class="line">        x1 = self.atr_conv1(x)</span><br><span class="line">        x2 = self.atr_conv2(x)</span><br><span class="line">        x3 = self.atr_conv3(x)</span><br><span class="line">        x4 = self.atr_conv4(x)</span><br><span class="line">        <span class="keyword">if</span> self.expansion != <span class="number">1</span>:</span><br><span class="line">            low_x = self.low_conv(low_x)</span><br><span class="line">        <span class="keyword">return</span> torch.cat((x1,x2,x3,x4), <span class="number">1</span>), low_x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet18</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet34</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet50</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet101</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet152</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">8</span>, <span class="number">36</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet_test</span><span class="params">()</span>:</span></span><br><span class="line">    net = resnet152()</span><br><span class="line">    net = nn.DataParallel(net)</span><br><span class="line">    net.cuda()</span><br><span class="line"></span><br><span class="line">    x = torch.randn((<span class="number">1</span>,<span class="number">1</span>,<span class="number">1024</span>,<span class="number">1024</span>))</span><br><span class="line">    y1, y2 = net(x)</span><br><span class="line">    print(y1.size())</span><br><span class="line">    print(y2.size())</span><br><span class="line"></span><br><span class="line"><span class="comment">#resnet_test()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"><span class="comment">#                                       #</span></span><br><span class="line"><span class="comment">#           DeepLab V3 +                #</span></span><br><span class="line"><span class="comment">#                                       #</span></span><br><span class="line"><span class="comment">#########################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Encoder</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(Encoder, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        self.conv1 = conv1x1(<span class="number">512</span>, <span class="number">256</span>)</span><br><span class="line">        self.atr_conv1 = atrous_conv(<span class="number">512</span>, <span class="number">256</span>, <span class="number">6</span>, drop_rate)</span><br><span class="line">        self.atr_conv2 = atrous_conv(<span class="number">512</span>, <span class="number">256</span>, <span class="number">12</span>, drop_rate)</span><br><span class="line">        self.atr_conv3 = atrous_conv(<span class="number">512</span>, <span class="number">256</span>, <span class="number">18</span>, drop_rate)</span><br><span class="line">        self.avgpool = nn.AvgPool2d(<span class="number">2</span>) <span class="comment">#impossible due to 15/2 = 7.5</span></span><br><span class="line">        self.conv2 = conv1x1(<span class="number">512</span>, <span class="number">256</span>)</span><br><span class="line">        self.conv_cat = conv1x1(<span class="number">1280</span>, <span class="number">512</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        y1 = self.conv1(x)</span><br><span class="line">        y2 = self.atr_conv1(x)</span><br><span class="line">        y3 = self.atr_conv2(x)</span><br><span class="line">        y4 = self.atr_conv3(x)</span><br><span class="line">        y5 = self.avgpool(x)</span><br><span class="line">        y5 = self.conv2(y5)</span><br><span class="line">        y5 = interpolate(y5, scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">        y = torch.cat([y1, y2, y3, y4], dim=<span class="number">1</span>)</span><br><span class="line">        y = self.conv_cat(y)</span><br><span class="line">        <span class="keyword">return</span> interpolate(y, scale_factor=<span class="number">4</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Deeplab_V3_Plus</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, class_num=<span class="number">2</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(Deeplab_V3_Plus, self).__init__()</span><br><span class="line">        self.resnet = resnet50(drop_rate=drop_rate)</span><br><span class="line">        self.conv0 = conv1x1(<span class="number">64</span>, <span class="number">256</span>, drop_rate)</span><br><span class="line">        self.encoder = Encoder(drop_rate)</span><br><span class="line">        self.conv1 = conv3x3(<span class="number">768</span>, <span class="number">512</span>, drop_rate)</span><br><span class="line">        self.conv2 = conv3x3(<span class="number">512</span>, <span class="number">256</span>, drop_rate)</span><br><span class="line">        self.conv3 = conv3x3(<span class="number">256</span>, class_num)</span><br><span class="line">        self.conv4 = conv5x5(class_num, class_num)</span><br><span class="line">        self.conv5 = conv5x5(class_num, class_num)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        y, low_y = self.resnet(x)</span><br><span class="line">        low_y = self.conv0(low_y)</span><br><span class="line">        y = self.encoder(y)</span><br><span class="line">        y = torch.cat([low_y, y], dim=<span class="number">1</span>)</span><br><span class="line">        y = self.conv1(y)</span><br><span class="line">        y = self.conv2(y)</span><br><span class="line">        y = self.conv3(y)</span><br><span class="line">        y = interpolate(y, scale_factor=<span class="number">4</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>)</span><br><span class="line">        y = self.conv4(y)</span><br><span class="line">        y = self.conv5(y)</span><br><span class="line">        y = softmax(y, dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deeplab_test</span><span class="params">()</span>:</span></span><br><span class="line">    net = Deeplab_V3_Plus()</span><br><span class="line">    net = nn.DataParallel(net)</span><br><span class="line">    net.cuda()</span><br><span class="line"></span><br><span class="line">    x = torch.randn((<span class="number">1</span>,<span class="number">1</span>,<span class="number">1024</span>,<span class="number">1024</span>))</span><br><span class="line">    y = net(x)</span><br><span class="line">    print(y.size())</span><br><span class="line"></span><br><span class="line"><span class="comment">#deeplab_test()</span></span><br></pre></td></tr></table></figure>
<h2 id="pspnet-py"><a href="#pspnet-py" class="headerlink" title="pspnet.py"></a>pspnet.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.nn.functional <span class="keyword">import</span> softmax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"><span class="comment">#                                           #</span></span><br><span class="line"><span class="comment">#       PSPNet Backbone Networks            #</span></span><br><span class="line"><span class="comment">#                                           #</span></span><br><span class="line"><span class="comment">#############################################</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">    Implementation of dilated ResNet with deep supervision. Downsampling is changed to 8x</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicBlock</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes, planes, stride=<span class="number">1</span>, downsample=None, dilation=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(BasicBlock, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        self.conv1 = nn.Conv2d(inplanes, planes, kernel_size=<span class="number">3</span>, stride=stride,</span><br><span class="line">                               padding=dilation, dilation=dilation, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>,</span><br><span class="line">                               padding=dilation, dilation=dilation, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        <span class="comment">#out = self.dp(out) # Bottom or Here</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bottleneck</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    expansion = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inplanes, planes, stride=<span class="number">1</span>, downsample=None, dilation=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(Bottleneck, self).__init__()</span><br><span class="line">        self.dp = nn.Dropout2d(p=drop_rate)</span><br><span class="line">        elf.conv1 = nn.Conv2d(inplanes, planes, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=stride, dilation=dilation,</span><br><span class="line">                               padding=dilation, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv3 = nn.Conv2d(planes, planes * <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(planes * <span class="number">4</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.dp(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, block, layers=<span class="params">(<span class="number">3</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">3</span>)</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        self.inplanes = <span class="number">64</span></span><br><span class="line">        super(ResNet, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">1</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>,</span><br><span class="line">                               bias=<span class="keyword">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(<span class="number">64</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="keyword">True</span>)</span><br><span class="line">        self.maxpool = nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.layer1 = self._make_layer(block, <span class="number">64</span>, layers[<span class="number">0</span>], drop_rate=drop_rate)</span><br><span class="line">        self.layer2 = self._make_layer(block, <span class="number">128</span>, layers[<span class="number">1</span>], stride=<span class="number">2</span>,</span><br><span class="line">                                       drop_rate=drop_rate)</span><br><span class="line">        self.layer3 = self._make_layer(block, <span class="number">256</span>, layers[<span class="number">2</span>], stride=<span class="number">1</span>,</span><br><span class="line">                                       dilation=<span class="number">2</span>, drop_rate=drop_rate)</span><br><span class="line">        self.layer4 = self._make_layer(block, <span class="number">512</span>, layers[<span class="number">3</span>], stride=<span class="number">1</span>,</span><br><span class="line">                                       dilation=<span class="number">4</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">                n = m.kernel_size[<span class="number">0</span>] * m.kernel_size[<span class="number">1</span>] * m.out_channels</span><br><span class="line">                m.weight.data.normal_(<span class="number">0</span>, math.sqrt(<span class="number">2.</span> / n))</span><br><span class="line">            <span class="keyword">elif</span> isinstance(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_layer</span><span class="params">(self, block, planes, blocks, stride=<span class="number">1</span>, dilation=<span class="number">1</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        downsample = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> self.inplanes != planes * block.expansion:</span><br><span class="line">            downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(self.inplanes, planes * block.expansion,</span><br><span class="line">                          kernel_size=<span class="number">1</span>, stride=stride, bias=<span class="keyword">False</span>),</span><br><span class="line">                nn.BatchNorm2d(planes * block.expansion),</span><br><span class="line">                nn.Dropout2d(drop_rate)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        layers = [block(self.inplanes, planes, stride, downsample, drop_rate=drop_rate)]</span><br><span class="line">        self.inplanes = planes * block.expansion</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, blocks):</span><br><span class="line">            layers.append(block(self.inplanes, planes, dilation=dilation, drop_rate=drop_rate))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        x = self.bn1(x)</span><br><span class="line">        x = self.relu(x)</span><br><span class="line">        x = self.maxpool(x)</span><br><span class="line"></span><br><span class="line">        x = self.layer1(x)</span><br><span class="line">        x = self.layer2(x)</span><br><span class="line">        x_3 = self.layer3(x)</span><br><span class="line">        x = self.layer4(x_3)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x, x_3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet18</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = ResNet(BasicBlock, [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], drop_rate=drop_rate)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet34</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = ResNet(BasicBlock, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], drop_rate=drop_rate)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resnet50</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    model = ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], drop_rate=drop_rate)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="comment">#                                                   #</span></span><br><span class="line"><span class="comment">#                   PSPNet                          #</span></span><br><span class="line"><span class="comment">#                                                   #</span></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PSPModule</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, features, out_features=<span class="number">1024</span>, sizes=<span class="params">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>)</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.stages = []</span><br><span class="line">        self.stages = nn.ModuleList([self._make_stage(features, size) <span class="keyword">for</span> size <span class="keyword">in</span> sizes])</span><br><span class="line">        self.bottleneck = nn.Conv2d(features * (len(sizes) + <span class="number">1</span>), out_features, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.relu = nn.ReLU()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_make_stage</span><span class="params">(self, features, size)</span>:</span></span><br><span class="line">        prior = nn.AdaptiveAvgPool2d(output_size=(size, size))</span><br><span class="line">        conv = nn.Conv2d(features, features, kernel_size=<span class="number">1</span>, bias=<span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(prior, conv)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, feats)</span>:</span></span><br><span class="line">        h, w = feats.size(<span class="number">2</span>), feats.size(<span class="number">3</span>)</span><br><span class="line">        priors = [F.interpolate(input=stage(feats), size=(h, w),\</span><br><span class="line">                 mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>) <span class="keyword">for</span> stage <span class="keyword">in</span> self.stages] + [feats]</span><br><span class="line">        bottle = self.bottleneck(torch.cat(priors, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> self.relu(bottle)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PSPUpsample</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channels, out_channels, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.conv = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels, out_channels, <span class="number">3</span>, padding=<span class="number">1</span>),</span><br><span class="line">            nn.BatchNorm2d(out_channels),</span><br><span class="line">            nn.Dropout2d(p=drop_rate),</span><br><span class="line">            nn.PReLU()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        h, w = <span class="number">2</span> * x.size(<span class="number">2</span>), <span class="number">2</span> * x.size(<span class="number">3</span>)</span><br><span class="line">        p = F.interpolate(input=x, size=(h, w), mode=<span class="string">'bilinear'</span>, align_corners=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">return</span> self.conv(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PSPNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n_classes=<span class="number">2</span>, sizes=<span class="params">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>)</span>, psp_size=<span class="number">2048</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 deep_features_size=<span class="number">1024</span>, backend=<span class="string">'resnet34'</span>, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        <span class="keyword">if</span> backend ==<span class="string">'resnet18'</span>:</span><br><span class="line">            self.feats = resnet18(drop_rate)</span><br><span class="line">        <span class="keyword">elif</span> backend == <span class="string">'resnet34'</span>:</span><br><span class="line">            self.feats = resnet34(drop_rate)</span><br><span class="line">        <span class="keyword">elif</span> backend == <span class="string">'resnet50'</span>:</span><br><span class="line">            self.feats = resnet50(drop_rate)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'backend ERROR'</span>)</span><br><span class="line">        self.psp = PSPModule(psp_size, <span class="number">1024</span>, sizes)</span><br><span class="line">        self.up1 = PSPUpsample(<span class="number">1024</span>, <span class="number">256</span>, drop_rate)</span><br><span class="line">        self.up2 = PSPUpsample(<span class="number">256</span>, <span class="number">64</span>, drop_rate)</span><br><span class="line">        self.up3 = PSPUpsample(<span class="number">64</span>, <span class="number">64</span>, drop_rate)</span><br><span class="line"></span><br><span class="line">        self.final = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">64</span>, n_classes, kernel_size=<span class="number">1</span>),</span><br><span class="line">            nn.LogSoftmax())</span><br><span class="line"></span><br><span class="line">        <span class="comment">#self.classifier = nn.Sequential(</span></span><br><span class="line">        <span class="comment">#    nn.Linear(deep_features_size, 256),</span></span><br><span class="line">        <span class="comment">#    nn.ReLU(),</span></span><br><span class="line">        <span class="comment">#    nn.Linear(256, n_classes))</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="comment">#f, class_f = self.feats(x)</span></span><br><span class="line">        f, _ = self.feats(x)</span><br><span class="line">        p = self.psp(f)</span><br><span class="line">        p = self.up1(p)</span><br><span class="line">        p = self.up2(p)</span><br><span class="line">        p = self.up3(p)</span><br><span class="line">        <span class="comment">#auxiliary = F.adaptive_max_pool2d(input=class_f, output_size=(1, 1)).\</span></span><br><span class="line">        <span class="comment">#            view(-1, class_f.size(1))</span></span><br><span class="line">        p = self.final(p)</span><br><span class="line">        p = softmax(p, dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> p<span class="comment">#, self.classifier(auxiliary)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pspnet_res18</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PSPNet(sizes=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>), psp_size=<span class="number">512</span>, deep_features_size=<span class="number">256</span>,</span><br><span class="line">                  backend=<span class="string">'resnet18'</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pspnet_res34</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PSPNet(sizes=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>), psp_size=<span class="number">512</span>, deep_features_size=<span class="number">256</span>,</span><br><span class="line">                  backend=<span class="string">'resnet34'</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pspnet_res50</span><span class="params">(drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PSPNet(sizes=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>), psp_size=<span class="number">2048</span>, deep_features_size=<span class="number">1024</span>,</span><br><span class="line">                  backend=<span class="string">'resnet50'</span>, drop_rate=drop_rate)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Resnet18</span></span><br><span class="line">    <span class="comment">#net = pspnet_res18()</span></span><br><span class="line">    <span class="comment"># Resnet34</span></span><br><span class="line">    <span class="comment">#net = pspnet_res34()</span></span><br><span class="line">    <span class="comment"># Resnet50</span></span><br><span class="line">    net = pspnet_res50()</span><br><span class="line"></span><br><span class="line">    net = nn.DataParallel(net)</span><br><span class="line">    net.cuda()</span><br><span class="line"></span><br><span class="line">    x = torch.randn(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1024</span>,<span class="number">1024</span>)</span><br><span class="line">    y = net(x)</span><br><span class="line">    print(y.size())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#test()</span></span><br></pre></td></tr></table></figure>
<h2 id="unet-py"><a href="#unet-py" class="headerlink" title="unet.py"></a>unet.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> torch.nn.functional <span class="keyword">import</span> softmax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv3x3</span><span class="params">(in_c, out_c, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">            bias=True, useBN=False, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> useBN:</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">                nn.ReflectionPad2d(padding),</span><br><span class="line">                nn.Conv2d(in_c, out_c, kernel_size, stride, padding=<span class="number">0</span>, bias=bias),</span><br><span class="line">                nn.BatchNorm2d(out_c),</span><br><span class="line">                nn.Dropout2d(p=drop_rate),</span><br><span class="line">                nn.ReLU(inplace=<span class="keyword">True</span>),</span><br><span class="line">                nn.ReflectionPad2d(padding),</span><br><span class="line">                nn.Conv2d(out_c, out_c, kernel_size, stride, padding=<span class="number">0</span>, bias=bias),</span><br><span class="line">                nn.BatchNorm2d(out_c),</span><br><span class="line">                nn.Dropout2d(p=drop_rate),</span><br><span class="line">                nn.ReLU(inplace=<span class="keyword">True</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">                nn.ReflectionPad2d(padding),</span><br><span class="line">                nn.Conv2d(in_c, out_c, kernel_size, stride, padding=<span class="number">0</span>, bias=bias),</span><br><span class="line">                nn.Dropout2d(p=drop_rate),</span><br><span class="line">                nn.ReLU(),</span><br><span class="line">                nn.ReflectionPad2d(padding),</span><br><span class="line">                nn.Conv2d(out_c, out_c, kernel_size, stride, padding=<span class="number">0</span>, bias=bias),</span><br><span class="line">                nn.Dropout2d(p=drop_rate),</span><br><span class="line">                nn.ReLU())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upsample</span><span class="params">(in_c, out_c, bias=True, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> nn.Sequential(</span><br><span class="line">        <span class="comment">#nn.ReflectionPad2d(1),</span></span><br><span class="line">		nn.ConvTranspose2d(in_c, out_c, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, bias=bias),</span><br><span class="line">        nn.Dropout2d(p=drop_rate),</span><br><span class="line">        nn.ReLU())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UNet</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, in_channel=<span class="number">1</span>, class_num=<span class="number">2</span>, useBN=False, drop_rate=<span class="number">0</span>)</span>:</span></span><br><span class="line">        super(UNet, self).__init__()</span><br><span class="line">        self.output_dim = class_num</span><br><span class="line">        self.drop_rate = drop_rate</span><br><span class="line">        self.conv1 = conv3x3(in_channel, <span class="number">64</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv2 = conv3x3(<span class="number">64</span>, <span class="number">128</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv3 = conv3x3(<span class="number">128</span>, <span class="number">256</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv4 = conv3x3(<span class="number">256</span>, <span class="number">512</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv5 = conv3x3(<span class="number">512</span>, <span class="number">1024</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line"></span><br><span class="line">        self.conv4m = conv3x3(<span class="number">1024</span>, <span class="number">512</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv3m = conv3x3(<span class="number">512</span>, <span class="number">256</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv2m = conv3x3(<span class="number">256</span>, <span class="number">128</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line">        self.conv1m = conv3x3(<span class="number">128</span>, <span class="number">64</span>, useBN=useBN, drop_rate=self.drop_rate)</span><br><span class="line"></span><br><span class="line">        self.conv0  = nn.Sequential(nn.ReflectionPad2d(<span class="number">1</span>),</span><br><span class="line">                                    nn.Conv2d(<span class="number">64</span>, self.output_dim, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">                                    nn.Dropout2d(p=self.drop_rate),</span><br><span class="line">                                    nn.ReLU())</span><br><span class="line">        self.max_pool = nn.MaxPool2d(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        self.upsample54 = upsample(<span class="number">1024</span>, <span class="number">512</span>, drop_rate=self.drop_rate)</span><br><span class="line">        self.upsample43 = upsample(<span class="number">512</span>, <span class="number">256</span>, drop_rate=self.drop_rate)</span><br><span class="line">        self.upsample32 = upsample(<span class="number">256</span>, <span class="number">128</span>, drop_rate=self.drop_rate)</span><br><span class="line">        self.upsample21 = upsample(<span class="number">128</span>, <span class="number">64</span>, drop_rate=self.drop_rate)</span><br><span class="line"></span><br><span class="line">		<span class="comment">## weight initialization</span></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(m, nn.Conv2d) <span class="keyword">or</span> isinstance(m, nn.ConvTranspose2d):</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                    m.bias.data.zero_()</span><br><span class="line">                nn.init.normal_(m.weight.data, mean=<span class="number">0</span>, std=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        output1 = self.conv1(x)</span><br><span class="line">        output2 = self.conv2(self.max_pool(output1))</span><br><span class="line">        output3 = self.conv3(self.max_pool(output2))</span><br><span class="line">        output4 = self.conv4(self.max_pool(output3))</span><br><span class="line">        output5 = self.conv5(self.max_pool(output4))</span><br><span class="line"></span><br><span class="line">        conv5m_out = torch.cat((self.upsample54(output5), output4), <span class="number">1</span>)</span><br><span class="line">        conv4m_out = self.conv4m(conv5m_out)</span><br><span class="line">        conv4m_out = torch.cat((self.upsample43(output4), output3), <span class="number">1</span>)</span><br><span class="line">        conv3m_out = self.conv3m(conv4m_out)</span><br><span class="line"></span><br><span class="line">        conv3m_out = torch.cat((self.upsample32(output3), output2), <span class="number">1</span>)</span><br><span class="line">        conv2m_out = self.conv2m(conv3m_out)</span><br><span class="line"></span><br><span class="line">        conv2m_out = torch.cat((self.upsample21(output2), output1), <span class="number">1</span>)</span><br><span class="line">        conv1m_out = self.conv1m(conv2m_out)</span><br><span class="line"></span><br><span class="line">        final = self.conv0(conv1m_out)</span><br><span class="line">        final = softmax(final, dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> final</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    net = UNet(class_num=<span class="number">2</span>)</span><br><span class="line">    y = net(torch.randn(<span class="number">3</span>,<span class="number">1</span>,<span class="number">240</span>,<span class="number">240</span>))</span><br><span class="line">    print(y.size())</span><br><span class="line"></span><br><span class="line"><span class="comment">#test()</span></span><br></pre></td></tr></table></figure>
<h1 id="config"><a href="#config" class="headerlink" title="config"></a>config</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># Device Init</span></span><br><span class="line">device = <span class="string">'cuda'</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">'cpu'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Model output shape Init</span></span><br><span class="line">class_num = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Data Handling Parameters</span></span><br><span class="line">complete_threshold = <span class="number">0.05</span></span><br><span class="line">complete_rate = <span class="number">0.66</span></span><br><span class="line"></span><br><span class="line">core_threshold = <span class="number">0.05</span></span><br><span class="line">core_rate = <span class="number">0.66</span></span><br><span class="line"></span><br><span class="line">enhancing_threshold = <span class="number">0.02</span></span><br><span class="line">enhancing_rate = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Data Augmentation Parameters</span></span><br></pre></td></tr></table></figure>
<h1 id="dataset-py"><a href="#dataset-py" class="headerlink" title="dataset.py"></a>dataset.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> PIL</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> torch.utils.data</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> accimage</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    accimage = <span class="keyword">None</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader, Dataset</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, PILLOW_VERSION</span><br><span class="line"><span class="keyword">from</span> scipy.ndimage.filters <span class="keyword">import</span> gaussian_filter</span><br><span class="line"><span class="keyword">from</span> scipy.ndimage.interpolation <span class="keyword">import</span> map_coordinates</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data_loader</span><span class="params">(args, mode)</span>:</span></span><br><span class="line">    <span class="comment"># Data Flag Check</span></span><br><span class="line">    <span class="keyword">if</span> args.data == <span class="string">'complete'</span> <span class="keyword">or</span> args.data == <span class="string">'core'</span> <span class="keyword">or</span> args.data == <span class="string">'enhancing'</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'args.data ERROR'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mode Flag Check </span></span><br><span class="line">    <span class="keyword">if</span> mode == <span class="string">'train'</span>:</span><br><span class="line">        shuffle = <span class="keyword">True</span></span><br><span class="line">        dataset = TrainSet(args)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">'valid'</span>:</span><br><span class="line">        shuffle = <span class="keyword">False</span></span><br><span class="line">        dataset = ValidSet(args)</span><br><span class="line">    <span class="keyword">elif</span> mode == <span class="string">'test'</span>:</span><br><span class="line">        shuffle = <span class="keyword">False</span></span><br><span class="line">        dataset = TestSet(args)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'data_loader mode ERROR'</span>)</span><br><span class="line"></span><br><span class="line">    dataloader = DataLoader(dataset,</span><br><span class="line">                            batch_size=args.batch_size,</span><br><span class="line">                            num_workers=os.cpu_count(),</span><br><span class="line">                            shuffle=shuffle,</span><br><span class="line">                            drop_last=<span class="keyword">True</span>)</span><br><span class="line">    <span class="keyword">return</span> dataloader</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrainSet</span><span class="params">(torch.utils.data.Dataset)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.data = args.data</span><br><span class="line">        self.img_root = args.img_root</span><br><span class="line">        self.img_path1 = [] <span class="comment"># tumor ratio &gt; 5%</span></span><br><span class="line">        self.img_path2 = [] <span class="comment"># tumor ratio &lt; 5%</span></span><br><span class="line">        self.label_root = args.label_root</span><br><span class="line">        self.label_path1 = []</span><br><span class="line">        self.label_path2 = []</span><br><span class="line"></span><br><span class="line">        self.img_transform = transforms.ColorJitter(brightness=<span class="number">0.2</span>)</span><br><span class="line">        self.transform = Compose([</span><br><span class="line">                    RandomVerticalFlip(),</span><br><span class="line">                    RandomHorizontalFlip(),</span><br><span class="line">                    RandomAffine(degrees=(<span class="number">-20</span>,<span class="number">20</span>),translate=(<span class="number">0.1</span>,<span class="number">0.1</span>),</span><br><span class="line">                                 scale=(<span class="number">0.9</span>,<span class="number">1.1</span>), shear=(<span class="number">-0.2</span>,<span class="number">0.2</span>)),</span><br><span class="line">                    ElasticTransform(alpha=<span class="number">720</span>, sigma=<span class="number">24</span>)])</span><br><span class="line">        self.totensor = transforms.ToTensor()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.data == <span class="string">'complete'</span>:</span><br><span class="line">            self.patch_threshold = config.complete_threshold</span><br><span class="line">            self.data_rate = config.complete_rate</span><br><span class="line">        <span class="keyword">elif</span> self.data == <span class="string">'core'</span>:</span><br><span class="line">            self.patch_threshold = config.core_threshold</span><br><span class="line">            self.data_rate = config.core_rate</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.patch_threshold = config.enhancing_threshold</span><br><span class="line">            self.data_rate = config.core_rate</span><br><span class="line"></span><br><span class="line">        img_path = []</span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.img_root):</span><br><span class="line">            img_path += glob.glob(os.path.join(self.img_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line"></span><br><span class="line">        label_path = []</span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.label_root):</span><br><span class="line">            label_path += glob.glob(os.path.join(self.label_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(img_path)):</span><br><span class="line">            label = cv2.imread(label_path[i], cv2.IMREAD_GRAYSCALE)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.data == <span class="string">'complete'</span>:</span><br><span class="line">                tumor_ratio = (label&gt;<span class="number">25</span>).astype(np.uint8).sum()</span><br><span class="line">            <span class="keyword">elif</span> self.data == <span class="string">'core'</span>:</span><br><span class="line">                l1 = (label&gt;<span class="number">25</span>).astype(np.uint8)</span><br><span class="line">                l2 = (label&lt;<span class="number">75</span>).astype(np.uint8)</span><br><span class="line">                label1 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">                l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">                l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">                label2 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">                tumor_ratio = (np.logical_or(label1,label2).astype(np.uint8)).sum()</span><br><span class="line">                <span class="keyword">del</span> label1, label2</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">                l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">                tumor_ratio = (np.logical_and(l1,l2).astype(np.uint8)).sum()</span><br><span class="line">            tumor_ratio /= label.shape[<span class="number">0</span>]*label.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> tumor_ratio &gt; self.patch_threshold: <span class="comment"># CHANGE FOR ENHANCING</span></span><br><span class="line">                self.label_path2.append(label_path[i])</span><br><span class="line">                self.img_path2.append(img_path[i])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.label_path1.append(label_path[i])</span><br><span class="line">                self.img_path1.append(img_path[i])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Change len (ex. len(img_path2)*1.5)</span></span><br><span class="line">        <span class="keyword">return</span> len(self.img_path1) + len(self.img_path2)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> np.random.choice(<span class="number">2</span>, <span class="number">1</span>, p=[<span class="number">1</span>-self.data_rate, self.data_rate]) == <span class="number">0</span>:</span><br><span class="line">            idx = idx % len(self.img_path1)</span><br><span class="line">            <span class="comment">#idx = np.random.randint(len(self.img_path1))</span></span><br><span class="line">            img_path = self.img_path1[idx]</span><br><span class="line">            label_path = self.label_path1[idx]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            idx = np.random.randint(len(self.img_path2))</span><br><span class="line">            img_path = self.img_path2[idx]</span><br><span class="line">            label_path = self.label_path2[idx]</span><br><span class="line"></span><br><span class="line">        img = cv2.imread(img_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        img = Image.fromarray(img)</span><br><span class="line">        label = cv2.imread(label_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        <span class="keyword">if</span> self.data == <span class="string">'complete'</span>:</span><br><span class="line">            label[label &lt; <span class="number">25</span>] = <span class="number">0</span></span><br><span class="line">            label[label &gt;= <span class="number">25</span>] = <span class="number">1</span></span><br><span class="line">            label = label.astype(np.uint8)</span><br><span class="line">        <span class="keyword">elif</span> self.data == <span class="string">'core'</span>:</span><br><span class="line">            l1 = (label&gt;<span class="number">25</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">75</span>).astype(np.uint8)</span><br><span class="line">            label1 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">            l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">            label2 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">            label = np.logical_or(label1,label2).astype(np.uint8)</span><br><span class="line">            <span class="keyword">del</span> label1, label2</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">            label = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">        label = Image.fromarray(label)</span><br><span class="line">        img, label = self.transform(img,label)</span><br><span class="line">        img = self.img_transform(img)</span><br><span class="line">        label = np.expand_dims(np.array(label), <span class="number">0</span>)</span><br><span class="line">        label = label.astype(np.float32)</span><br><span class="line">        label = np.concatenate((np.absolute(label<span class="number">-1</span>) , label),axis=<span class="number">0</span>)</span><br><span class="line">        label = torch.from_numpy(label)</span><br><span class="line">        <span class="keyword">return</span> self.totensor(img), label, img_path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidSet</span><span class="params">(torch.utils.data.Dataset)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.data = args.data</span><br><span class="line">        self.img_root = args.img_root</span><br><span class="line">        self.img_path = []</span><br><span class="line">        self.label_root = args.label_root</span><br><span class="line">        self.label_path = []</span><br><span class="line">        self.totensor = transforms.ToTensor()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.img_root):</span><br><span class="line">            self.img_path += glob.glob(os.path.join(self.img_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.label_root):</span><br><span class="line">            self.label_path += glob.glob(os.path.join(self.label_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line">        self.img_path = sorted(self.img_path)</span><br><span class="line">        self.label_path = sorted(self.label_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.img_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">        img = cv2.imread(self.img_path[idx], cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        img = Image.fromarray(img)</span><br><span class="line">        label = cv2.imread(self.label_path[idx], cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        <span class="keyword">if</span> self.data == <span class="string">'complete'</span>:</span><br><span class="line">            label[label &lt; <span class="number">25</span>] = <span class="number">0</span></span><br><span class="line">            label[label &gt;= <span class="number">25</span>] = <span class="number">1</span></span><br><span class="line">            label = label.astype(np.uint8)</span><br><span class="line">        <span class="keyword">elif</span> self.data == <span class="string">'core'</span>:</span><br><span class="line">            l1 = (label&gt;<span class="number">25</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">75</span>).astype(np.uint8)</span><br><span class="line">            label1 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">            l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">            label2 = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line">            label = np.logical_or(label1,label2).astype(np.uint8)</span><br><span class="line">            <span class="keyword">del</span> label1, label2</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l1 = (label&gt;<span class="number">125</span>).astype(np.uint8)</span><br><span class="line">            l2 = (label&lt;<span class="number">175</span>).astype(np.uint8)</span><br><span class="line">            label = np.logical_and(l1,l2).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">        label = Image.fromarray(label)</span><br><span class="line">        label = np.expand_dims(np.array(label), <span class="number">0</span>)</span><br><span class="line">        label = label.astype(np.float32)</span><br><span class="line">        label = np.concatenate((np.absolute(label<span class="number">-1</span>) , label),axis=<span class="number">0</span>)</span><br><span class="line">        label = torch.from_numpy(label)</span><br><span class="line">        <span class="keyword">return</span> self.totensor(img), label, self.img_path[idx]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestSet</span><span class="params">(torch.utils.data.Dataset)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        self.data = args.data</span><br><span class="line">        self.img_root = args.img_root</span><br><span class="line">        self.img_path = []</span><br><span class="line">        self.totensor = transforms.ToTensor()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> folder_name <span class="keyword">in</span> os.listdir(self.img_root):</span><br><span class="line">            self.img_path += glob.glob(os.path.join(self.img_root, folder_name, <span class="string">"*.jpg"</span>))</span><br><span class="line">        self.img_path = sorted(self.img_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.img_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, idx)</span>:</span></span><br><span class="line">        img = cv2.imread(self.img_path[idx], cv2.IMREAD_GRAYSCALE)</span><br><span class="line">        img = Image.fromarray(img)</span><br><span class="line">        <span class="keyword">return</span> self.totensor(img), self.img_path[idx]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################################</span></span><br><span class="line"><span class="comment">#                                                           #</span></span><br><span class="line"><span class="comment">#       Data Transforms Functions                           # </span></span><br><span class="line"><span class="comment">#                                                           #</span></span><br><span class="line"><span class="comment">#############################################################</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">    From torchvision Transforms.py (+ Slightly changed)</span></span><br><span class="line"><span class="string">    (https://github.com/pytorch/vision/blob/master/torchvision/transforms/transforms.py)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compose</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Composes several transforms together.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        transforms (list of ``Transform`` objects): list of transforms to compose.</span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; transforms.Compose([</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt;     transforms.CenterCrop(10),</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt;     transforms.ToTensor(),</span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; ])</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, transforms)</span>:</span></span><br><span class="line">        self.transforms = transforms</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> self.transforms:</span><br><span class="line">            img,label = t(img, label)</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        format_string = self.__class__.__name__ + <span class="string">'('</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> self.transforms:</span><br><span class="line">            format_string += <span class="string">'\n'</span></span><br><span class="line">            format_string += <span class="string">'    &#123;0&#125;'</span>.format(t)</span><br><span class="line">        format_string += <span class="string">'\n)'</span></span><br><span class="line">        <span class="keyword">return</span> format_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ToTensor</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Convert a ``PIL Image`` or ``numpy.ndarray`` to tensor.</span></span><br><span class="line"><span class="string">    Converts a PIL Image or numpy.ndarray (H x W x C) in the range</span></span><br><span class="line"><span class="string">    [0, 255] to a torch.FloatTensor of shape (C x H x W) in the range [0.0, 1.0].</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, pic, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            pic (PIL Image or numpy.ndarray): Image to be converted to tensor.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            Tensor: Converted image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> to_tensor(pic), to_tensor(label)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__class__.__name__ + <span class="string">'()'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomVerticalFlip</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Vertically flip the given PIL Image randomly with a given probability.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        p (float): probability of the image being flipped. Default value is 0.5</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, p=<span class="number">0.5</span>)</span>:</span></span><br><span class="line">        self.p = p</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            img (PIL Image): Image to be flipped.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            PIL Image: Randomly flipped image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; self.p:</span><br><span class="line">            <span class="keyword">return</span> vflip(img), vflip(label)</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__class__.__name__ + <span class="string">'(p=&#123;&#125;)'</span>.format(self.p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomHorizontalFlip</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Horizontally flip the given PIL Image randomly with a given probability.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        p (float): probability of the image being flipped. Default value is 0.5</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, p=<span class="number">0.5</span>)</span>:</span></span><br><span class="line">        self.p = p</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            img (PIL Image): Image to be flipped.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            PIL Image: Randomly flipped image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> random.random() &lt; self.p:</span><br><span class="line">            <span class="keyword">return</span> hflip(img), hflip(label)</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__class__.__name__ + <span class="string">'(p=&#123;&#125;)'</span>.format(self.p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomRotation</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Rotate the image by angle.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        degrees (sequence or float or int): Range of degrees to select from.</span></span><br><span class="line"><span class="string">            If degrees is a number instead of sequence like (min, max), the range of degrees</span></span><br><span class="line"><span class="string">            will be (-degrees, +degrees).</span></span><br><span class="line"><span class="string">        resample (&#123;PIL.Image.NEAREST, PIL.Image.BILINEAR, PIL.Image.BICUBIC&#125;, optional):</span></span><br><span class="line"><span class="string">            An optional resampling filter. See `filters`_ for more information.</span></span><br><span class="line"><span class="string">            If omitted, or if the image has mode "1" or "P", it is set to PIL.Image.NEAREST.</span></span><br><span class="line"><span class="string">        expand (bool, optional): Optional expansion flag.</span></span><br><span class="line"><span class="string">            If true, expands the output to make it large enough to hold the entire rotated image.</span></span><br><span class="line"><span class="string">            If false or omitted, make the output image the same size as the input image.</span></span><br><span class="line"><span class="string">            Note that the expand flag assumes rotation around the center and no translation.</span></span><br><span class="line"><span class="string">        center (2-tuple, optional): Optional center of rotation.</span></span><br><span class="line"><span class="string">            Origin is the upper left corner.</span></span><br><span class="line"><span class="string">            Default is the center of the image.</span></span><br><span class="line"><span class="string">    .. _filters: https://pillow.readthedocs.io/en/latest/handbook/concepts.html#filters</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, degrees=<span class="number">360</span>, resample=False, expand=False, center=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(degrees, numbers.Number):</span><br><span class="line">            <span class="keyword">if</span> degrees &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"If degrees is a single number, it must be positive."</span>)</span><br><span class="line">            self.degrees = (-degrees, degrees)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> len(degrees) != <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"If degrees is a sequence, it must be of len 2."</span>)</span><br><span class="line">            self.degrees = degrees</span><br><span class="line"></span><br><span class="line">        self.resample = resample</span><br><span class="line">        self.expand = expand</span><br><span class="line">        self.center = center</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_params</span><span class="params">(degrees)</span>:</span></span><br><span class="line">        <span class="string">"""Get parameters for ``rotate`` for a random rotation.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            sequence: params to be passed to ``rotate`` for random rotation.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment">#angle = random.uniform(degrees[0], degrees[1])</span></span><br><span class="line">        angle_list = [<span class="number">0</span>,<span class="number">90</span>,<span class="number">180</span>,<span class="number">270</span>]</span><br><span class="line">        angle = random.choice(angle_list)</span><br><span class="line">        <span class="keyword">return</span> angle</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">            img (PIL Image): Image to be rotated.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            PIL Image: Rotated image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#angle = self.get_params(self.degrees)</span></span><br><span class="line">        angle = np.random.randint(self.degrees[<span class="number">0</span>], self.degrees[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> rotate(img, angle, self.resample, self.expand, self.center),\</span><br><span class="line">                rotate(label, angle, self.resample, self.expand, self.center)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        format_string = self.__class__.__name__ + <span class="string">'(degrees=&#123;0&#125;'</span>.format(self.degrees)</span><br><span class="line">        format_string += <span class="string">', resample=&#123;0&#125;'</span>.format(self.resample)</span><br><span class="line">        format_string += <span class="string">', expand=&#123;0&#125;'</span>.format(self.expand)</span><br><span class="line">        <span class="keyword">if</span> self.center <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            format_string += <span class="string">', center=&#123;0&#125;'</span>.format(self.center)</span><br><span class="line">        format_string += <span class="string">')'</span></span><br><span class="line">        <span class="keyword">return</span> format_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomAffine</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Random affine transformation of the image keeping center invariant</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        degrees (sequence or float or int): Range of degrees to select from.</span></span><br><span class="line"><span class="string">            If degrees is a number instead of sequence like (min, max), the range of degrees</span></span><br><span class="line"><span class="string">            will be (-degrees, +degrees). Set to 0 to deactivate rotations.</span></span><br><span class="line"><span class="string">        translate (tuple, optional): tuple of maximum absolute fraction for horizontal</span></span><br><span class="line"><span class="string">            and vertical translations. For example translate=(a, b), then horizontal shift</span></span><br><span class="line"><span class="string">            is randomly sampled in the range -img_width * a &lt; dx &lt; img_width * a and vertical shift is</span></span><br><span class="line"><span class="string">            randomly sampled in the range -img_height * b &lt; dy &lt; img_height * b. Will not translate by default.</span></span><br><span class="line"><span class="string">        scale (tuple, optional): scaling factor interval, e.g (a, b), then scale is</span></span><br><span class="line"><span class="string">            randomly sampled from the range a &lt;= scale &lt;= b. Will keep original scale by default.</span></span><br><span class="line"><span class="string">        shear (sequence or float or int, optional): Range of degrees to select from.</span></span><br><span class="line"><span class="string">            If degrees is a number instead of sequence like (min, max), the range of degrees</span></span><br><span class="line"><span class="string">            will be (-degrees, +degrees). Will not apply shear by default</span></span><br><span class="line"><span class="string">        resample (&#123;PIL.Image.NEAREST, PIL.Image.BILINEAR, PIL.Image.BICUBIC&#125;, optional):</span></span><br><span class="line"><span class="string">            An optional resampling filter. See `filters`_ for more information.</span></span><br><span class="line"><span class="string">            If omitted, or if the image has mode "1" or "P", it is set to PIL.Image.NEAREST.</span></span><br><span class="line"><span class="string">        fillcolor (int): Optional fill color for the area outside the transform in the output image. (Pillow&gt;=5.0.0)</span></span><br><span class="line"><span class="string">    .. _filters: https://pillow.readthedocs.io/en/latest/handbook/concepts.html#filters</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, degrees, translate=None, scale=None, shear=None, resample=False, fillcolor=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(degrees, numbers.Number):</span><br><span class="line">            <span class="keyword">if</span> degrees &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">"If degrees is a single number, it must be positive."</span>)</span><br><span class="line">            self.degrees = (-degrees, degrees)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span> isinstance(degrees, (tuple, list)) <span class="keyword">and</span> len(degrees) == <span class="number">2</span>, \</span><br><span class="line">                <span class="string">"degrees should be a list or tuple and it must be of length 2."</span></span><br><span class="line">            self.degrees = degrees</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> translate <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">assert</span> isinstance(translate, (tuple, list)) <span class="keyword">and</span> len(translate) == <span class="number">2</span>, \</span><br><span class="line">                <span class="string">"translate should be a list or tuple and it must be of length 2."</span></span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> translate:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0.0</span> &lt;= t &lt;= <span class="number">1.0</span>):</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">"translation values should be between 0 and 1"</span>)</span><br><span class="line">        self.translate = translate</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> scale <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">assert</span> isinstance(scale, (tuple, list)) <span class="keyword">and</span> len(scale) == <span class="number">2</span>, \</span><br><span class="line">                <span class="string">"scale should be a list or tuple and it must be of length 2."</span></span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> scale:</span><br><span class="line">                <span class="keyword">if</span> s &lt;= <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">"scale values should be positive"</span>)</span><br><span class="line">        self.scale = scale</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> shear <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(shear, numbers.Number):</span><br><span class="line">                <span class="keyword">if</span> shear &lt; <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">"If shear is a single number, it must be positive."</span>)</span><br><span class="line">                self.shear = (-shear, shear)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">assert</span> isinstance(shear, (tuple, list)) <span class="keyword">and</span> len(shear) == <span class="number">2</span>, \</span><br><span class="line">                    <span class="string">"shear should be a list or tuple and it must be of length 2."</span></span><br><span class="line">                self.shear = shear</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.shear = shear</span><br><span class="line"></span><br><span class="line">        self.resample = resample</span><br><span class="line">        self.fillcolor = fillcolor</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_params</span><span class="params">(degrees, translate, scale_ranges, shears, img_size)</span>:</span></span><br><span class="line">        <span class="string">"""Get parameters for affine transformation</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            sequence: params to be passed to the affine transformation</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        angle = random.uniform(degrees[<span class="number">0</span>], degrees[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> translate <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            max_dx = translate[<span class="number">0</span>] * img_size[<span class="number">0</span>]</span><br><span class="line">            max_dy = translate[<span class="number">1</span>] * img_size[<span class="number">1</span>]</span><br><span class="line">            translations = (np.round(random.uniform(-max_dx, max_dx)),</span><br><span class="line">                            np.round(random.uniform(-max_dy, max_dy)))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            translations = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> scale_ranges <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            scale = random.uniform(scale_ranges[<span class="number">0</span>], scale_ranges[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            scale = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> shears <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            shear = random.uniform(shears[<span class="number">0</span>], shears[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shear = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> angle, translations, scale, shear</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, img, label)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">            img (PIL Image): Image to be transformed.</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            PIL Image: Affine transformed image.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ret = self.get_params(self.degrees, self.translate, self.scale, self.shear, img.size)</span><br><span class="line">        <span class="keyword">return</span> affine(img, label, *ret, resample=self.resample, fillcolor=self.fillcolor)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="string">'&#123;name&#125;(degrees=&#123;degrees&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.translate <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            s += <span class="string">', translate=&#123;translate&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.scale <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            s += <span class="string">', scale=&#123;scale&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.shear <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            s += <span class="string">', shear=&#123;shear&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.resample &gt; <span class="number">0</span>:</span><br><span class="line">            s += <span class="string">', resample=&#123;resample&#125;'</span></span><br><span class="line">        <span class="keyword">if</span> self.fillcolor != <span class="number">0</span>:</span><br><span class="line">            s += <span class="string">', fillcolor=&#123;fillcolor&#125;'</span></span><br><span class="line">        s += <span class="string">')'</span></span><br><span class="line">        d = dict(self.__dict__)</span><br><span class="line">        d[<span class="string">'resample'</span>] = _pil_interpolation_to_str[d[<span class="string">'resample'</span>]]</span><br><span class="line">        <span class="keyword">return</span> s.format(name=self.__class__.__name__, **d)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">    From torchvision functional.py (+ Slightly changed)</span></span><br><span class="line"><span class="string">    (https://github.com/pytorch/vision/blob/master/torchvision/transforms/functional.py)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_is_pil_image</span><span class="params">(img)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> accimage <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">return</span> isinstance(img, (Image.Image, accimage.Image))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> isinstance(img, Image.Image)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_tensor</span><span class="params">(pic)</span>:</span></span><br><span class="line">    <span class="string">"""Convert a ``PIL Image`` or ``numpy.ndarray`` to tensor.</span></span><br><span class="line"><span class="string">    See ``ToTensor`` for more details.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pic (PIL Image or numpy.ndarray): Image to be converted to tensor.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Tensor: Converted image.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span>(_is_pil_image(pic) <span class="keyword">or</span> _is_numpy_image(pic)):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'pic should be PIL Image or ndarray. Got &#123;&#125;'</span>.format(type(pic)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> isinstance(pic, np.ndarray):</span><br><span class="line">        <span class="comment"># handle numpy array</span></span><br><span class="line">        img = torch.from_numpy(pic.transpose((<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)))</span><br><span class="line">        <span class="comment"># backward compatibility</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(img, torch.ByteTensor):</span><br><span class="line">            <span class="keyword">return</span> img.float().div(<span class="number">255</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> accimage <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> isinstance(pic, accimage.Image):</span><br><span class="line">        nppic = np.zeros([pic.channels, pic.height, pic.width], dtype=np.float32)</span><br><span class="line">        pic.copyto(nppic)</span><br><span class="line">        <span class="keyword">return</span> torch.from_numpy(nppic)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># handle PIL Image</span></span><br><span class="line">    <span class="keyword">if</span> pic.mode == <span class="string">'I'</span>:</span><br><span class="line">        img = torch.from_numpy(np.array(pic, np.int32, copy=<span class="keyword">False</span>))</span><br><span class="line">    <span class="keyword">elif</span> pic.mode == <span class="string">'I;16'</span>:</span><br><span class="line">        img = torch.from_numpy(np.array(pic, np.int16, copy=<span class="keyword">False</span>))</span><br><span class="line">    <span class="keyword">elif</span> pic.mode == <span class="string">'F'</span>:</span><br><span class="line">        img = torch.from_numpy(np.array(pic, np.float32, copy=<span class="keyword">False</span>))</span><br><span class="line">    <span class="keyword">elif</span> pic.mode == <span class="string">'1'</span>:</span><br><span class="line">        img = <span class="number">255</span> * torch.from_numpy(np.array(pic, np.uint8, copy=<span class="keyword">False</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        img = torch.ByteTensor(torch.ByteStorage.from_buffer(pic.tobytes()))</span><br><span class="line">    <span class="comment"># PIL image mode: L, P, I, F, RGB, YCbCr, RGBA, CMYK</span></span><br><span class="line">    <span class="keyword">if</span> pic.mode == <span class="string">'YCbCr'</span>:</span><br><span class="line">        nchannel = <span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> pic.mode == <span class="string">'I;16'</span>:</span><br><span class="line">        nchannel = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        nchannel = len(pic.mode)</span><br><span class="line">    img = img.view(pic.size[<span class="number">1</span>], pic.size[<span class="number">0</span>], nchannel)</span><br><span class="line">    <span class="comment"># put it from HWC to CHW format</span></span><br><span class="line">    <span class="comment"># yikes, this transpose takes 80% of the loading time/CPU</span></span><br><span class="line">    img = img.transpose(<span class="number">0</span>, <span class="number">1</span>).transpose(<span class="number">0</span>, <span class="number">2</span>).contiguous()</span><br><span class="line">    <span class="keyword">if</span> isinstance(img, torch.ByteTensor):</span><br><span class="line">        <span class="keyword">return</span> img.float().div(<span class="number">255</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vflip</span><span class="params">(img)</span>:</span></span><br><span class="line">    <span class="string">"""Vertically flip the given PIL Image.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img (PIL Image): Image to be flipped.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        PIL Image:  Vertically flipped image.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_pil_image(img):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'img should be PIL Image. Got &#123;&#125;'</span>.format(type(img)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img.transpose(Image.FLIP_TOP_BOTTOM)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hflip</span><span class="params">(img)</span>:</span></span><br><span class="line">    <span class="string">"""Horizontally flip the given PIL Image.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img (PIL Image): Image to be flipped.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        PIL Image:  Horizontall flipped image.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_pil_image(img):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'img should be PIL Image. Got &#123;&#125;'</span>.format(type(img)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img.transpose(Image.FLIP_LEFT_RIGHT)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rotate</span><span class="params">(img, angle, resample=False, expand=False, center=None)</span>:</span></span><br><span class="line">    <span class="string">"""Rotate the image by angle.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img (PIL Image): PIL Image to be rotated.</span></span><br><span class="line"><span class="string">        angle (float or int): In degrees degrees counter clockwise order.</span></span><br><span class="line"><span class="string">        resample (``PIL.Image.NEAREST`` or ``PIL.Image.BILINEAR`` or ``PIL.Image.BICUBIC``, optional):</span></span><br><span class="line"><span class="string">            An optional resampling filter. See `filters`_ for more information.</span></span><br><span class="line"><span class="string">            If omitted, or if the image has mode "1" or "P", it is set to ``PIL.Image.NEAREST``.</span></span><br><span class="line"><span class="string">        expand (bool, optional): Optional expansion flag.</span></span><br><span class="line"><span class="string">            If true, expands the output image to make it large enough to hold the entire rotated image.</span></span><br><span class="line"><span class="string">            If false or omitted, make the output image the same size as the input image.</span></span><br><span class="line"><span class="string">            Note that the expand flag assumes rotation around the center and no translation.</span></span><br><span class="line"><span class="string">        center (2-tuple, optional): Optional center of rotation.</span></span><br><span class="line"><span class="string">            Origin is the upper left corner.</span></span><br><span class="line"><span class="string">            Default is the center of the image.</span></span><br><span class="line"><span class="string">    .. _filters: https://pillow.readthedocs.io/en/latest/handbook/concepts.html#filters</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_pil_image(img):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'img should be PIL Image. Got &#123;&#125;'</span>.format(type(img)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img.rotate(angle, resample, expand, center)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_inverse_affine_matrix</span><span class="params">(center, angle, translate, scale, shear)</span>:</span></span><br><span class="line">    <span class="comment"># Helper method to compute inverse matrix for affine transformation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># As it is explained in PIL.Image.rotate</span></span><br><span class="line">    <span class="comment"># We need compute INVERSE of affine transformation matrix: M = T * C * RSS * C^-1</span></span><br><span class="line">    <span class="comment"># where T is translation matrix: [1, 0, tx | 0, 1, ty | 0, 0, 1]</span></span><br><span class="line">    <span class="comment">#       C is translation matrix to keep center: [1, 0, cx | 0, 1, cy | 0, 0, 1]</span></span><br><span class="line">    <span class="comment">#       RSS is rotation with scale and shear matrix</span></span><br><span class="line">    <span class="comment">#       RSS(a, scale, shear) = [ cos(a)*scale    -sin(a + shear)*scale     0]</span></span><br><span class="line">    <span class="comment">#                              [ sin(a)*scale    cos(a + shear)*scale     0]</span></span><br><span class="line">    <span class="comment">#                              [     0                  0          1]</span></span><br><span class="line">    <span class="comment"># Thus, the inverse is M^-1 = C * RSS^-1 * C^-1 * T^-1</span></span><br><span class="line"></span><br><span class="line">    angle = math.radians(angle)</span><br><span class="line">    shear = math.radians(shear)</span><br><span class="line">    scale = <span class="number">1.0</span> / scale</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Inverted rotation matrix with scale and shear</span></span><br><span class="line">    d = math.cos(angle + shear) * math.cos(angle) + math.sin(angle + shear) * math.sin(angle)</span><br><span class="line">    matrix = [</span><br><span class="line">        math.cos(angle + shear), math.sin(angle + shear), <span class="number">0</span>,</span><br><span class="line">        -math.sin(angle), math.cos(angle), <span class="number">0</span></span><br><span class="line">    ]</span><br><span class="line">    matrix = [scale / d * m <span class="keyword">for</span> m <span class="keyword">in</span> matrix]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Apply inverse of translation and of center translation: RSS^-1 * C^-1 * T^-1</span></span><br><span class="line">    matrix[<span class="number">2</span>] += matrix[<span class="number">0</span>] * (-center[<span class="number">0</span>] - translate[<span class="number">0</span>]) + matrix[<span class="number">1</span>] * (-center[<span class="number">1</span>] - translate[<span class="number">1</span>])</span><br><span class="line">    matrix[<span class="number">5</span>] += matrix[<span class="number">3</span>] * (-center[<span class="number">0</span>] - translate[<span class="number">0</span>]) + matrix[<span class="number">4</span>] * (-center[<span class="number">1</span>] - translate[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Apply center translation: C * RSS^-1 * C^-1 * T^-1</span></span><br><span class="line">    matrix[<span class="number">2</span>] += center[<span class="number">0</span>]</span><br><span class="line">    matrix[<span class="number">5</span>] += center[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> matrix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">affine</span><span class="params">(img, label, angle, translate, scale, shear, resample=<span class="number">0</span>, fillcolor=None)</span>:</span></span><br><span class="line">    <span class="string">"""Apply affine transformation on the image keeping image center invariant</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        img (PIL Image): PIL Image to be rotated.</span></span><br><span class="line"><span class="string">        angle (float or int): rotation angle in degrees between -180 and 180, clockwise direction.</span></span><br><span class="line"><span class="string">        translate (list or tuple of integers): horizontal and vertical translations(post-rotation translation)</span></span><br><span class="line"><span class="string">        scale (float): overall scale</span></span><br><span class="line"><span class="string">        shear (float): shear angle value in degrees between -180 to 180, clockwise direction.</span></span><br><span class="line"><span class="string">        resample (``PIL.Image.NEAREST`` or ``PIL.Image.BILINEAR`` or ``PIL.Image.BICUBIC``, optional):</span></span><br><span class="line"><span class="string">            An optional resampling filter.</span></span><br><span class="line"><span class="string">            See `filters`_ for more information.</span></span><br><span class="line"><span class="string">            If omitted, or if the image has mode "1" or "P", it is set to ``PIL.Image.NEAREST``.</span></span><br><span class="line"><span class="string">        fillcolor (int): Optional fill color for the area outside the transform in the output image. (Pillow&gt;=5.0.0)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _is_pil_image(img):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'img should be PIL Image. Got &#123;&#125;'</span>.format(type(img)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> isinstance(translate, (tuple, list)) <span class="keyword">and</span> len(translate) == <span class="number">2</span>, \</span><br><span class="line">        <span class="string">"Argument translate should be a list or tuple of length 2"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> scale &gt; <span class="number">0.0</span>, <span class="string">"Argument scale should be positive"</span></span><br><span class="line"></span><br><span class="line">    output_size = img.size</span><br><span class="line">    center = (img.size[<span class="number">0</span>] * <span class="number">0.5</span> + <span class="number">0.5</span>, img.size[<span class="number">1</span>] * <span class="number">0.5</span> + <span class="number">0.5</span>)</span><br><span class="line">    matrix = _get_inverse_affine_matrix(center, angle, translate, scale, shear)</span><br><span class="line">    kwargs = &#123;<span class="string">"fillcolor"</span>: fillcolor&#125; <span class="keyword">if</span> PILLOW_VERSION[<span class="number">0</span>] == <span class="string">'5'</span> <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> img.transform(output_size, Image.AFFINE, matrix, resample, **kwargs),\</span><br><span class="line">            label.transform(output_size, Image.AFFINE, matrix, resample, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">	source code From.</span></span><br><span class="line"><span class="string">	https://gist.github.com/oeway/2e3b989e0343f0884388ed7ed82eb3b0</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ElasticTransform</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Apply elastic transformation on a numpy.ndarray (H x W x C)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, alpha, sigma)</span>:</span></span><br><span class="line">        self.alpha = alpha</span><br><span class="line">        self.sigma = sigma</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, image, label)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(self.alpha, collections.Sequence):</span><br><span class="line">            alpha = random_num_generator(self.alpha)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            alpha = self.alpha</span><br><span class="line">        <span class="keyword">if</span> isinstance(self.sigma, collections.Sequence):</span><br><span class="line">            sigma = random_num_generator(self.sigma)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sigma = self.sigma</span><br><span class="line">        <span class="keyword">return</span> elastic_transform(image, label, alpha=alpha, sigma=sigma)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">elastic_transform</span><span class="params">(image, label, alpha=<span class="number">1000</span>, sigma=<span class="number">30</span>, spline_order=<span class="number">1</span>, mode=<span class="string">'nearest'</span>, random_state=np.random)</span>:</span></span><br><span class="line">    <span class="string">"""Elastic deformation of image as described in [Simard2003]_.</span></span><br><span class="line"><span class="string">    .. [Simard2003] Simard, Steinkraus and Platt, "Best Practices for</span></span><br><span class="line"><span class="string">       Convolutional Neural Networks applied to Visual Document Analysis", in</span></span><br><span class="line"><span class="string">       Proc. of the International Conference on Document Analysis and</span></span><br><span class="line"><span class="string">       Recognition, 2003.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment">#assert image.ndim == 3</span></span><br><span class="line">    image = np.array(image)</span><br><span class="line">    label = np.array(label)</span><br><span class="line">    shape = image.shape[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    dx = gaussian_filter((random_state.rand(*shape) * <span class="number">2</span> - <span class="number">1</span>),</span><br><span class="line">                         sigma, mode=<span class="string">"constant"</span>, cval=<span class="number">0</span>) * alpha</span><br><span class="line">    dy = gaussian_filter((random_state.rand(*shape) * <span class="number">2</span> - <span class="number">1</span>),</span><br><span class="line">                         sigma, mode=<span class="string">"constant"</span>, cval=<span class="number">0</span>) * alpha</span><br><span class="line"></span><br><span class="line">    x, y = np.meshgrid(np.arange(shape[<span class="number">0</span>]), np.arange(shape[<span class="number">1</span>]), indexing=<span class="string">'ij'</span>)</span><br><span class="line">    indices = [np.reshape(x + dx, (<span class="number">-1</span>, <span class="number">1</span>)), np.reshape(y + dy, (<span class="number">-1</span>, <span class="number">1</span>))]</span><br><span class="line"></span><br><span class="line">    result1 = map_coordinates(image, indices, order=spline_order, mode=mode).reshape(shape)</span><br><span class="line">    result2 = map_coordinates(label, indices, order=spline_order, mode=mode).reshape(shape)</span><br><span class="line">    <span class="keyword">return</span> Image.fromarray(result1), Image.fromarray(result2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_num_generator</span><span class="params">(config, random_state=np.random)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> config[<span class="number">0</span>] == <span class="string">'uniform'</span>:</span><br><span class="line">        ret = random_state.uniform(config[<span class="number">1</span>], config[<span class="number">2</span>], <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">elif</span> config[<span class="number">0</span>] == <span class="string">'lognormal'</span>:</span><br><span class="line">        ret = random_state.lognormal(config[<span class="number">1</span>], config[<span class="number">2</span>], <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(config)</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'unsupported format'</span>)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>
<h1 id="preprocess-py"><a href="#preprocess-py" class="headerlink" title="preprocess.py"></a>preprocess.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> nibabel <span class="keyword">as</span> nib</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> LabelBinarizer</span><br><span class="line"></span><br><span class="line">IMG_ROOT = <span class="string">'./Task01_BrainTumor/imagesTr'</span></span><br><span class="line">IMG_PATH = <span class="string">'./Task01_BrainTumor/imagesTr/BRATS_148.nii.gz'</span></span><br><span class="line">IMG_OUTPUT_ROOT = <span class="string">'./train/image_T1'</span></span><br><span class="line"></span><br><span class="line">LABEL_ROOT = <span class="string">'./Task01_BrainTumor/labelsTr'</span></span><br><span class="line">IABEL_PATH = <span class="string">'./Task01_BrainTumor/labelsTr/BRATS_148.nii.gz'</span></span><br><span class="line">LABEL_OUTPUT_ROOT = <span class="string">'./train/label'</span></span><br><span class="line"></span><br><span class="line">L0 = <span class="number">0</span>      <span class="comment"># Background</span></span><br><span class="line">L1 = <span class="number">50</span>     <span class="comment"># Necrotic and Non-enhancing Tumor</span></span><br><span class="line">L2 = <span class="number">100</span>    <span class="comment"># Edema</span></span><br><span class="line">L3 = <span class="number">150</span>    <span class="comment"># Enhancing Tumor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MRI Image channels Description</span></span><br><span class="line"><span class="comment"># ch0: FLAIR / ch1: T1 / ch2: T1c/ ch3: T2</span></span><br><span class="line"><span class="comment"># cf) In this project, we use FLAIR and T1c MRI dataset</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># Data Load Example</span></span><br><span class="line"><span class="comment">#img = nib.load(IMG_PATH)</span></span><br><span class="line"><span class="comment">#img = (img.get_fdata())[:,:,:,3]                # img shape = (240,240,155)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># MRI Label Channels Description</span></span><br><span class="line"><span class="comment"># 0: Background         / 1: Necrotic and non-enhancing tumor (paper, 1+3)</span></span><br><span class="line"><span class="comment"># 2: edema (paper, 2)   / 3: Enhancing tumor (paper, 4)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># &lt;Input&gt;           &lt;Prediction&gt;</span></span><br><span class="line"><span class="comment"># FLAIR             Complete(1,2,3)</span></span><br><span class="line"><span class="comment"># FLAIR             Core(1,3)</span></span><br><span class="line"><span class="comment"># T1c               Enhancing(3)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Data Load Example</span></span><br><span class="line"><span class="comment"># label = nib.load(LABEL_PATH)</span></span><br><span class="line"><span class="comment"># label = (label.get_fdata()).astype(np.uint16)   # label shape = (240,240,155)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nii2jpg_img</span><span class="params">(img_path, output_root)</span>:</span></span><br><span class="line">    img_name = (img_path.split(<span class="string">'/'</span>)[<span class="number">-1</span>]).split(<span class="string">'.'</span>)[<span class="number">0</span>]</span><br><span class="line">    output_path = os.path.join(output_root, img_name)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(output_root)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(output_path)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    img = nib.load(img_path)</span><br><span class="line">    img = (img.get_fdata())[:,:,:,<span class="number">1</span>]</span><br><span class="line">    img = (img/img.max())*<span class="number">255</span></span><br><span class="line">    img = img.astype(np.uint8)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(img.shape[<span class="number">2</span>]):</span><br><span class="line">        filename = os.path.join(output_path, img_name+<span class="string">'_'</span>+str(i)+<span class="string">'.jpg'</span>)</span><br><span class="line">        gray_img = img[:,:,i]</span><br><span class="line">        <span class="comment">#color_img = np.expand_dims(gray_img, 3)</span></span><br><span class="line">        <span class="comment">#color_img = np.concatenate([color_img, color_img, color_img], 2)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># COLOR LABELING</span></span><br><span class="line">        <span class="comment">#c255 = np.expand_dims(np.ones(gray_img.shape)*255, 3)</span></span><br><span class="line">        <span class="comment">#c0 = np.expand_dims(np.zeros(gray_img.shape), 3)</span></span><br><span class="line">        <span class="comment">#color = np.concatenate([c0,c0,c255], 2)</span></span><br><span class="line">        <span class="comment">#color_img = color_img.astype(np.float32) + color</span></span><br><span class="line">        <span class="comment">#color_img = (color_img / color_img.max()) *255</span></span><br><span class="line"></span><br><span class="line">        cv2.imwrite(filename, gray_img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nii2jpg_label</span><span class="params">(img_path, output_root)</span>:</span></span><br><span class="line">    img_name = (img_path.split(<span class="string">'/'</span>)[<span class="number">-1</span>]).split(<span class="string">'.'</span>)[<span class="number">0</span>]</span><br><span class="line">    output_path = os.path.join(output_root, img_name)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(output_root)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(output_path)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    img = nib.load(img_path)</span><br><span class="line">    img = (img.get_fdata())[:,:,:]</span><br><span class="line">    pdb.set_trace()</span><br><span class="line">    img = img*<span class="number">50</span></span><br><span class="line">    img = img.astype(np.uint8)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(img.shape[<span class="number">2</span>]):</span><br><span class="line">        filename = os.path.join(output_path, img_name+<span class="string">'_'</span>+str(i)+<span class="string">'.jpg'</span>)</span><br><span class="line">        gray_img = img[:,:,i]</span><br><span class="line">        <span class="comment">#color_img = np.expand_dims(gray_img, 3)</span></span><br><span class="line">        <span class="comment">#color_img = np.concatenate([color_img, color_img, color_img], 2)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># COLOR LABELING</span></span><br><span class="line">        <span class="comment">#c255 = np.expand_dims(np.ones(gray_img.shape)*255, 3)</span></span><br><span class="line">        <span class="comment">#c0 = np.expand_dims(np.zeros(gray_img.shape), 3)</span></span><br><span class="line">        <span class="comment">#color = np.concatenate([c0,c0,c255], 2)</span></span><br><span class="line">        <span class="comment">#color_img = color_img.astype(np.float32) + color</span></span><br><span class="line">        <span class="comment">#color_img = (color_img / color_img.max()) *255</span></span><br><span class="line"></span><br><span class="line">        cv2.imwrite(filename, gray_img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> path <span class="keyword">in</span> os.listdir(IMG_ROOT):</span><br><span class="line">    print(path)</span><br><span class="line">    <span class="keyword">if</span> path[<span class="number">0</span>] == <span class="string">'.'</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    nii2jpg_img(os.path.join(IMG_ROOT,path), IMG_OUTPUT_ROOT)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">for path in os.listdir(LABEL_ROOT):</span></span><br><span class="line"><span class="string">    print(path)</span></span><br><span class="line"><span class="string">    if path[0] == '.':</span></span><br><span class="line"><span class="string">        continue</span></span><br><span class="line"><span class="string">    nii2jpg_label(os.path.join(LABEL_ROOT,path), LABEL_OUTPUT_ROOT)</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<h1 id="trian-py"><a href="#trian-py" class="headerlink" title="trian.py"></a>trian.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.backends.cudnn <span class="keyword">as</span> cudnn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> dataset <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(args)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Variables and logger Init</span></span><br><span class="line">    device = config.device</span><br><span class="line">    cudnn.benchmark = <span class="keyword">True</span></span><br><span class="line">    get_logger()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Data Load</span></span><br><span class="line">    trainloader = data_loader(args, mode=<span class="string">'train'</span>)</span><br><span class="line">    validloader = data_loader(args, mode=<span class="string">'valid'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model Load</span></span><br><span class="line">    net, optimizer, best_score, start_epoch =\</span><br><span class="line">        load_model(args, class_num=config.class_num, mode=<span class="string">'train'</span>)</span><br><span class="line">    log_msg = <span class="string">'\n'</span>.join([<span class="string">'%s Train Start'</span>%(args.model)])</span><br><span class="line">    logging.info(log_msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(start_epoch, start_epoch+args.epochs):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Train Model</span></span><br><span class="line">        print(<span class="string">'\n\n\nEpoch: &#123;&#125;\n&lt;Train&gt;'</span>.format(epoch))</span><br><span class="line">        net.train(<span class="keyword">True</span>)</span><br><span class="line">        loss = <span class="number">0</span></span><br><span class="line">        lr = args.lr * (<span class="number">0.5</span> ** (epoch // <span class="number">4</span>))</span><br><span class="line">        <span class="keyword">for</span> param_group <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            param_group[<span class="string">"lr"</span>] = lr</span><br><span class="line">        torch.set_grad_enabled(<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">for</span> idx, (inputs, targets, paths) <span class="keyword">in</span> enumerate(trainloader):</span><br><span class="line">            inputs, targets = inputs.to(device), targets.to(device)</span><br><span class="line">            outputs = net(inputs)</span><br><span class="line">            <span class="keyword">if</span> type(outputs) == tuple:</span><br><span class="line">                outputs = outputs[<span class="number">0</span>]</span><br><span class="line">            batch_loss = dice_coef(outputs, targets)</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            batch_loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            loss += float(batch_loss)</span><br><span class="line">            progress_bar(idx, len(trainloader), <span class="string">'Loss: %.5f, Dice-Coef: %.5f'</span></span><br><span class="line">                         %((loss/(idx+<span class="number">1</span>)), (<span class="number">1</span>-(loss/(idx+<span class="number">1</span>)))))</span><br><span class="line">        log_msg = <span class="string">'\n'</span>.join([<span class="string">'Epoch: %d  Loss: %.5f,  Dice-Coef:  %.5f'</span>\</span><br><span class="line">                         %(epoch, loss/(idx+<span class="number">1</span>), <span class="number">1</span>-(loss/(idx+<span class="number">1</span>)))])</span><br><span class="line">        logging.info(log_msg)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Validate Model</span></span><br><span class="line">        print(<span class="string">'\n\n&lt;Validation&gt;'</span>)</span><br><span class="line">        net.eval()</span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> net.module.modules():</span><br><span class="line">            <span class="keyword">if</span> isinstance(module, torch.nn.modules.Dropout2d):</span><br><span class="line">                module.train(<span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">elif</span> isinstance(module, torch.nn.modules.Dropout):</span><br><span class="line">                module.train(<span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        loss = <span class="number">0</span></span><br><span class="line">        torch.set_grad_enabled(<span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">for</span> idx, (inputs, targets, paths) <span class="keyword">in</span> enumerate(validloader):</span><br><span class="line">            inputs, targets = inputs.to(device), targets.to(device)</span><br><span class="line">            outputs = net(inputs)</span><br><span class="line">            <span class="keyword">if</span> type(outputs) == tuple:</span><br><span class="line">                outputs = outputs[<span class="number">0</span>]</span><br><span class="line">            <span class="comment">#outputs = post_process(args, inputs, outputs, save=False)</span></span><br><span class="line">            batch_loss = dice_coef(outputs, targets, backprop=<span class="keyword">False</span>)</span><br><span class="line">            loss += float(batch_loss)</span><br><span class="line">            progress_bar(idx, len(validloader), <span class="string">'Loss: %.5f, Dice-Coef: %.5f'</span></span><br><span class="line">                         %((loss/(idx+<span class="number">1</span>)), (<span class="number">1</span>-(loss/(idx+<span class="number">1</span>)))))</span><br><span class="line">        log_msg = <span class="string">'\n'</span>.join([<span class="string">'Epoch: %d  Loss: %.5f,  Dice-Coef:  %.5f'</span></span><br><span class="line">                        %(epoch, loss/(idx+<span class="number">1</span>), <span class="number">1</span>-(loss/(idx+<span class="number">1</span>)))])</span><br><span class="line">        logging.info(log_msg)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Save Model</span></span><br><span class="line">        loss /= (idx+<span class="number">1</span>)</span><br><span class="line">        score = <span class="number">1</span> - loss</span><br><span class="line">        <span class="keyword">if</span> score &gt; best_score:</span><br><span class="line">            checkpoint = Checkpoint(net, optimizer, epoch, score)</span><br><span class="line">            checkpoint.save(os.path.join(args.ckpt_root, args.model+<span class="string">'.tar'</span>))</span><br><span class="line">            best_score = score</span><br><span class="line">            print(<span class="string">"Saving..."</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=__doc__)</span><br><span class="line">    parser.add_argument(<span class="string">"--resume"</span>, type=bool, default=<span class="keyword">False</span>,</span><br><span class="line">                        help=<span class="string">"Model Trianing resume."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--model"</span>, type=str, default=<span class="string">'pspnet_res50'</span>,</span><br><span class="line">                        help=<span class="string">"Model Name (unet, pspnet_squeeze, pspnet_res50,\</span></span><br><span class="line"><span class="string">                        pspnet_res34, pspnet_res50, deeplab)"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--in_channel"</span>, type=int, default=<span class="number">1</span>,</span><br><span class="line">                        help=<span class="string">"A number of images to use for input"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--batch_size"</span>, type=int, default=<span class="number">80</span>,</span><br><span class="line">                        help=<span class="string">"The batch size to load the data"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--epochs"</span>, type=int, default=<span class="number">30</span>,</span><br><span class="line">                        help=<span class="string">"The training epochs to run."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--drop_rate"</span>, type=float, default=<span class="number">0.1</span>,</span><br><span class="line">                        help=<span class="string">"Drop-out Rate"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--lr"</span>, type=float, default=<span class="number">0.001</span>,</span><br><span class="line">                        help=<span class="string">"Learning rate to use in training"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--data"</span>, type=str, default=<span class="string">"complete"</span>,</span><br><span class="line">                        help=<span class="string">"Label data type."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--img_root"</span>, type=str, default=<span class="string">"../../data/train/image_FLAIR"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the training image dataset."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--label_root"</span>, type=str, default=<span class="string">"../../data/train/label"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the training label datgaset"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--output_root"</span>, type=str, default=<span class="string">"./output/prediction"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the result predictions"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--ckpt_root"</span>, type=str, default=<span class="string">"./checkpoint"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the checkpoint files"</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    train(args)</span><br></pre></td></tr></table></figure>
<h1 id="utils-py"><a href="#utils-py" class="headerlink" title="utils.py"></a>utils.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> nibabel <span class="keyword">as</span> nib</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"><span class="keyword">import</span> pydensecrf.densecrf <span class="keyword">as</span> dcrf</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydensecrf.utils <span class="keyword">import</span> compute_unary, create_pairwise_bilateral,\</span><br><span class="line">         create_pairwise_gaussian, softmax_to_unary, unary_from_softmax</span><br><span class="line"></span><br><span class="line">_, term_width = os.popen(<span class="string">'stty size'</span>, <span class="string">'r'</span>).read().split()</span><br><span class="line">term_width = int(term_width)</span><br><span class="line"></span><br><span class="line">TOTAL_BAR_LENGTH = <span class="number">65.</span></span><br><span class="line">last_time = time.time()</span><br><span class="line">begin_time = last_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dice_coef</span><span class="params">(preds, targets, backprop=True)</span>:</span></span><br><span class="line">    smooth = <span class="number">1.0</span></span><br><span class="line">    class_num = <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> backprop:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(class_num):</span><br><span class="line">            pred = preds[:,i,:,:]</span><br><span class="line">            target = targets[:,i,:,:]</span><br><span class="line">            intersection = (pred * target).sum()</span><br><span class="line">            loss_ = <span class="number">1</span> - ((<span class="number">2.0</span> * intersection + smooth) / (pred.sum() + target.sum() + smooth))</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                loss = loss_</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                loss = loss + loss_</span><br><span class="line">        loss = loss/class_num</span><br><span class="line">        <span class="keyword">return</span> loss</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Need to generalize</span></span><br><span class="line">        targets = np.array(targets.argmax(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> len(preds.shape) &gt; <span class="number">3</span>:</span><br><span class="line">            preds = np.array(preds).argmax(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(class_num):</span><br><span class="line">            pred = (preds==i).astype(np.uint8)</span><br><span class="line">            target= (targets==i).astype(np.uint8)</span><br><span class="line">            intersection = (pred * target).sum()</span><br><span class="line">            loss_ = <span class="number">1</span> - ((<span class="number">2.0</span> * intersection + smooth) / (pred.sum() + target.sum() + smooth))</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                loss = loss_</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                loss = loss + loss_</span><br><span class="line">        loss = loss/class_num</span><br><span class="line">        <span class="keyword">return</span> loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_crf_img</span><span class="params">(inputs, outputs)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(outputs.shape[<span class="number">0</span>]):</span><br><span class="line">        img = inputs[i]</span><br><span class="line">        softmax_prob = outputs[i]</span><br><span class="line">        unary = unary_from_softmax(softmax_prob)</span><br><span class="line">        unary = np.ascontiguousarray(unary)</span><br><span class="line">        d = dcrf.DenseCRF(img.shape[<span class="number">0</span>] * img.shape[<span class="number">1</span>], <span class="number">2</span>)</span><br><span class="line">        d.setUnaryEnergy(unary)</span><br><span class="line">        feats = create_pairwise_gaussian(sdims=(<span class="number">10</span>,<span class="number">10</span>), shape=img.shape[:<span class="number">2</span>])</span><br><span class="line">        d.addPairwiseEnergy(feats, compat=<span class="number">3</span>, kernel=dcrf.DIAG_KERNEL,</span><br><span class="line">                            normalization=dcrf.NORMALIZE_SYMMETRIC)</span><br><span class="line">        feats = create_pairwise_bilateral(sdims=(<span class="number">50</span>,<span class="number">50</span>), schan=(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),</span><br><span class="line">                                          img=img, chdim=<span class="number">2</span>)</span><br><span class="line">        d.addPairwiseEnergy(feats, compat=<span class="number">10</span>, kernel=dcrf.DIAG_KERNEL,</span><br><span class="line">                            normalization=dcrf.NORMALIZE_SYMMETRIC)</span><br><span class="line">        Q = d.inference(<span class="number">5</span>)</span><br><span class="line">        res = np.argmax(Q, axis=<span class="number">0</span>).reshape((img.shape[<span class="number">0</span>], img.shape[<span class="number">1</span>]))</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            crf = np.expand_dims(res,axis=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res = np.expand_dims(res,axis=<span class="number">0</span>)</span><br><span class="line">            crf = np.concatenate((crf,res),axis=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> crf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">erode_dilate</span><span class="params">(outputs, kernel_size=<span class="number">7</span>)</span>:</span></span><br><span class="line">    kernel = np.ones((kernel_size,kernel_size),np.uint8)</span><br><span class="line">    outputs = outputs.astype(np.uint8)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(outputs.shape[<span class="number">0</span>]):</span><br><span class="line">        img = outputs[i]</span><br><span class="line">        img = cv2.morphologyEx(img, cv2.MORPH_OPEN, kernel)</span><br><span class="line">        img = cv2.morphologyEx(img, cv2.MORPH_CLOSE, kernel)</span><br><span class="line">        outputs[i] = img</span><br><span class="line">    <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_process</span><span class="params">(args, inputs, outputs, input_path=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 crf_flag=True, erode_dilate_flag=True,</span></span></span><br><span class="line"><span class="function"><span class="params">                 save=True, overlap=True)</span>:</span></span><br><span class="line">    inputs = (np.array(inputs.squeeze()).astype(np.float32)) * <span class="number">255</span></span><br><span class="line">    inputs = np.expand_dims(inputs, axis=<span class="number">3</span>)</span><br><span class="line">    inputs = np.concatenate((inputs,inputs,inputs), axis=<span class="number">3</span>)</span><br><span class="line">    outputs = np.array(outputs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Conditional Random Field</span></span><br><span class="line">    <span class="keyword">if</span> crf_flag:</span><br><span class="line">        outputs = get_crf_img(inputs, outputs)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        outputs = outputs.argmax(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Erosion and Dilation</span></span><br><span class="line">    <span class="keyword">if</span> erode_dilate_flag:</span><br><span class="line">        outputs = erode_dilate(outputs, kernel_size=<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">if</span> save == <span class="keyword">False</span>:</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    outputs = outputs*<span class="number">255</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(outputs.shape[<span class="number">0</span>]):</span><br><span class="line">        path = input_path[i].split(<span class="string">'/'</span>)</span><br><span class="line">        output_folder = os.path.join(args.output_root, path[<span class="number">-2</span>])</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.mkdir(output_folder)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        output_path = os.path.join(output_folder, path[<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">if</span> overlap:</span><br><span class="line">            img = outputs[i]</span><br><span class="line">            img = np.expand_dims(img, axis=<span class="number">2</span>)</span><br><span class="line">            zeros = np.zeros(img.shape)</span><br><span class="line">            img = np.concatenate((zeros,zeros,img), axis=<span class="number">2</span>)</span><br><span class="line">            img = np.array(img).astype(np.float32)</span><br><span class="line">            img = inputs[i] + img</span><br><span class="line">            <span class="keyword">if</span> img.max() &gt; <span class="number">0</span>:</span><br><span class="line">                img = (img/img.max())*<span class="number">255</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                img = (img/<span class="number">1</span>) * <span class="number">255</span></span><br><span class="line">            cv2.imwrite(output_path, img)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            img = outputs[i]</span><br><span class="line">            cv2.imwrite(output_path, img)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">TODO: Need to fix</span></span><br><span class="line"><span class="string">def save_img(args, inputs, outputs, input_paths, overlap=True):</span></span><br><span class="line"><span class="string">    inputs = (np.array(inputs.squeeze()).astype(np.float32)) * 255</span></span><br><span class="line"><span class="string">    inputs = np.expand_dims(inputs, axis=3)</span></span><br><span class="line"><span class="string">    inputs = np.concatenate((inputs,inputs,inputs), axis=3)</span></span><br><span class="line"><span class="string">    inputs = np.expand_dims(inputs, axis=3)</span></span><br><span class="line"><span class="string">    outputs = np.array(outputs.max(1)[1])*255</span></span><br><span class="line"><span class="string">    kernel = np.ones((5,5),np.uint8)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    for i, path in enumerate(input_paths):</span></span><br><span class="line"><span class="string">        path = path.split('/')[-2]</span></span><br><span class="line"><span class="string">        if i == 0:</span></span><br><span class="line"><span class="string">            compare = path</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            if compare != path:</span></span><br><span class="line"><span class="string">                raise ValueError('Output Merge Fail')</span></span><br><span class="line"><span class="string">            pass</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    final_img = None</span></span><br><span class="line"><span class="string">    output_path = os.path.join(args.output_root, path+'.nii.gz')</span></span><br><span class="line"><span class="string">    for i in range(outputs.shape[0]):</span></span><br><span class="line"><span class="string">        if overlap:</span></span><br><span class="line"><span class="string">            img = cv2.morphologyEx(outputs[i].astype(np.uint8), cv2.MORPH_OPEN, kernel)</span></span><br><span class="line"><span class="string">            img = cv2.morphologyEx(img, cv2.MORPH_CLOSE, kernel)</span></span><br><span class="line"><span class="string">            img = np.expand_dims(img, axis=2)</span></span><br><span class="line"><span class="string">            zeros = np.zeros(img.shape)</span></span><br><span class="line"><span class="string">            img = np.concatenate((zeros,zeros,img), axis=2)</span></span><br><span class="line"><span class="string">            img = np.expand_dims(img, axis=2)</span></span><br><span class="line"><span class="string">            img = np.array(img).astype(np.float32)</span></span><br><span class="line"><span class="string">            img = inputs[i] + img</span></span><br><span class="line"><span class="string">            if img.max() &gt; 0:</span></span><br><span class="line"><span class="string">                img = (img/img.max())*255</span></span><br><span class="line"><span class="string">            else:</span></span><br><span class="line"><span class="string">                img = (img/1) * 255</span></span><br><span class="line"><span class="string">            img = np.expand_dims(img, axis=3)</span></span><br><span class="line"><span class="string">            if i == 0:</span></span><br><span class="line"><span class="string">                final_img = img</span></span><br><span class="line"><span class="string">            else:</span></span><br><span class="line"><span class="string">                final_img = np.concatenate((final_img,img),axis=3)</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            img = output[i]</span></span><br><span class="line"><span class="string">    output_path = os.path.join(args.output_root, path)</span></span><br><span class="line"><span class="string">    final_img = nib.Nifti1Pair(final_img, np.eye(4))</span></span><br><span class="line"><span class="string">    nib.save(final_img, output_path)</span></span><br><span class="line"><span class="string">    print(output_path)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Checkpoint</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model, optimizer=None, epoch=<span class="number">0</span>, best_score=<span class="number">1</span>)</span>:</span></span><br><span class="line">        self.model = model</span><br><span class="line">        self.optimizer = optimizer</span><br><span class="line">        self.epoch = epoch</span><br><span class="line">        self.best_score = best_score</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        checkpoint = torch.load(path)</span><br><span class="line">        self.model.load_state_dict(checkpoint[<span class="string">"model_state"</span>])</span><br><span class="line">        self.epoch = checkpoint[<span class="string">"epoch"</span>]</span><br><span class="line">        self.best_score = checkpoint[<span class="string">"best_score"</span>]</span><br><span class="line">        <span class="keyword">if</span> self.optimizer:</span><br><span class="line">            self.optimizer.load_state_dict(checkpoint[<span class="string">"optimizer_state"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        state_dict = self.model.module.state_dict()</span><br><span class="line">        torch.save(&#123;<span class="string">"model_state"</span>: state_dict,</span><br><span class="line">                    <span class="string">"optimizer_state"</span>: self.optimizer.state_dict(),</span><br><span class="line">                    <span class="string">"epoch"</span>: self.epoch,</span><br><span class="line">                    <span class="string">"best_score"</span>: self.best_score&#125;, path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">progress_bar</span><span class="params">(current, total, msg=None)</span>:</span></span><br><span class="line">    <span class="string">''' Source Code from 'kuangliu/pytorch-cifar'</span></span><br><span class="line"><span class="string">        (https://github.com/kuangliu/pytorch-cifar/blob/master/utils.py)</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">global</span> last_time, begin_time</span><br><span class="line">    <span class="keyword">if</span> current == <span class="number">0</span>:</span><br><span class="line">        begin_time = time.time()  <span class="comment"># Reset for new bar.</span></span><br><span class="line"></span><br><span class="line">    cur_len = int(TOTAL_BAR_LENGTH*current/total)</span><br><span class="line">    rest_len = int(TOTAL_BAR_LENGTH - cur_len) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    sys.stdout.write(<span class="string">' ['</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(cur_len):</span><br><span class="line">        sys.stdout.write(<span class="string">'='</span>)</span><br><span class="line">    sys.stdout.write(<span class="string">'&gt;'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(rest_len):</span><br><span class="line">        sys.stdout.write(<span class="string">'.'</span>)</span><br><span class="line">    sys.stdout.write(<span class="string">']'</span>)</span><br><span class="line"></span><br><span class="line">    cur_time = time.time()</span><br><span class="line">    step_time = cur_time - last_time</span><br><span class="line">    last_time = cur_time</span><br><span class="line">    tot_time = cur_time - begin_time</span><br><span class="line"></span><br><span class="line">    L = []</span><br><span class="line">    L.append(<span class="string">'  Step: %s'</span> % format_time(step_time))</span><br><span class="line">    L.append(<span class="string">' | Tot: %s'</span> % format_time(tot_time))</span><br><span class="line">    <span class="keyword">if</span> msg:</span><br><span class="line">        L.append(<span class="string">' | '</span> + msg)</span><br><span class="line"></span><br><span class="line">    msg = <span class="string">''</span>.join(L)</span><br><span class="line">    sys.stdout.write(msg)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(term_width-int(TOTAL_BAR_LENGTH)-len(msg)<span class="number">-3</span>):</span><br><span class="line">        sys.stdout.write(<span class="string">' '</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Go back to the center of the bar.</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(term_width-int(TOTAL_BAR_LENGTH/<span class="number">2</span>)+<span class="number">2</span>):</span><br><span class="line">        sys.stdout.write(<span class="string">'\b'</span>)</span><br><span class="line">    sys.stdout.write(<span class="string">' %d/%d '</span> % (current+<span class="number">1</span>, total))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current &lt; total<span class="number">-1</span>:</span><br><span class="line">        sys.stdout.write(<span class="string">'\r'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sys.stdout.write(<span class="string">'\n'</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_time</span><span class="params">(seconds)</span>:</span></span><br><span class="line">    <span class="string">''' Source Code from 'kuangliu/pytorch-cifar'</span></span><br><span class="line"><span class="string">        (https://github.com/kuangliu/pytorch-cifar/blob/master/utils.py)</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    days = int(seconds / <span class="number">3600</span>/<span class="number">24</span>)</span><br><span class="line">    seconds = seconds - days*<span class="number">3600</span>*<span class="number">24</span></span><br><span class="line">    hours = int(seconds / <span class="number">3600</span>)</span><br><span class="line">    seconds = seconds - hours*<span class="number">3600</span></span><br><span class="line">    minutes = int(seconds / <span class="number">60</span>)</span><br><span class="line">    seconds = seconds - minutes*<span class="number">60</span></span><br><span class="line">    secondsf = int(seconds)</span><br><span class="line">    seconds = seconds - secondsf</span><br><span class="line">    millis = int(seconds*<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    f = <span class="string">''</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> days &gt; <span class="number">0</span>:</span><br><span class="line">        f += str(days) + <span class="string">'D'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> hours &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt;= <span class="number">2</span>:</span><br><span class="line">        f += str(hours) + <span class="string">'h'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> minutes &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt;= <span class="number">2</span>:</span><br><span class="line">        f += str(minutes) + <span class="string">'m'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> secondsf &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt;= <span class="number">2</span>:</span><br><span class="line">        f += str(secondsf) + <span class="string">'s'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> millis &gt; <span class="number">0</span> <span class="keyword">and</span> i &lt;= <span class="number">2</span>:</span><br><span class="line">        f += str(millis) + <span class="string">'ms'</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> f == <span class="string">''</span>:</span><br><span class="line">        f = <span class="string">'0ms'</span></span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_logger</span><span class="params">(level=<span class="string">"DEBUG"</span>, file_level=<span class="string">"DEBUG"</span>)</span>:</span></span><br><span class="line">    logger = logging.getLogger(<span class="keyword">None</span>)</span><br><span class="line">    logger.setLevel(level)</span><br><span class="line">    fomatter = logging.Formatter(</span><br><span class="line">            <span class="string">'%(asctime)s  [%(levelname)s]  %(message)s  (%(filename)s:  %(lineno)s)'</span>)</span><br><span class="line">    fileHandler = logging.handlers.TimedRotatingFileHandler(</span><br><span class="line">            <span class="string">'result.log'</span>, when=<span class="string">'d'</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    fileHandler.setLevel(file_level)</span><br><span class="line">    fileHandler.setFormatter(fomatter)</span><br><span class="line">    logger.addHandler(fileHandler)</span><br><span class="line">    <span class="keyword">return</span> logger</span><br></pre></td></tr></table></figure>
<h1 id="test-py"><a href="#test-py" class="headerlink" title="test.py"></a>test.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.backends.cudnn <span class="keyword">as</span> cudnn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> dataset <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(args)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Device Init</span></span><br><span class="line">    device = config.device</span><br><span class="line">    cudnn.benchmark = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Data Load</span></span><br><span class="line">    testloader = data_loader(args, mode=<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Model Load</span></span><br><span class="line">    net, _, _, _ = load_model(args, class_num=config.class_num, mode=<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line">    net.eval()</span><br><span class="line">    torch.set_grad_enabled(<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">for</span> idx, (inputs, paths) <span class="keyword">in</span> enumerate(testloader):</span><br><span class="line">        inputs = inputs.to(device)</span><br><span class="line">        outputs = net(inputs)</span><br><span class="line">        <span class="keyword">if</span> type(outputs) == tuple:</span><br><span class="line">            outputs = outputs[<span class="number">0</span>]</span><br><span class="line">        post_process(args, inputs, outputs, paths)</span><br><span class="line">        print(idx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=__doc__)</span><br><span class="line">    parser.add_argument(<span class="string">"--model"</span>, type=str, default=<span class="string">'pspnet'</span>, <span class="comment"># Need to be fixed</span></span><br><span class="line">                        help=<span class="string">"Model Name"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--batch_size"</span>, type=int, default=<span class="number">155</span>, <span class="comment"># Need to be fixed</span></span><br><span class="line">                        help=<span class="string">"The batch size to load the data"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--data"</span>, type=str, default=<span class="string">"complete"</span>,</span><br><span class="line">                        help=<span class="string">"Label data type."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--img_root"</span>, type=str, default=<span class="string">"../data/train/image_FLAIR"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the training image dataset."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--output_root"</span>, type=str, default=<span class="string">"./output/prediction"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the results."</span>)</span><br><span class="line">    parser.add_argument(<span class="string">"--ckpt_root"</span>, type=str, default=<span class="string">"./checkpoint"</span>,</span><br><span class="line">                        help=<span class="string">"The directory containing the trained model checkpoint"</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    test(args)</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>非常感谢各位老板投喂！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="https://raw.githubusercontent.com/hjyai94/Blog/master/source/uploads/%E5%BE%AE%E4%BF%A1%E6%89%93%E8%B5%8F.png" alt="HJY 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/07/进化算法/" rel="next" title="进化算法">
                <i class="fa fa-chevron-left"></i> 进化算法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="HJY" />
            
              <p class="site-author-name" itemprop="name">HJY</p>
              <p class="site-description motion-element" itemprop="description">HJY的装逼小站</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hjyai94" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#models"><span class="nav-number">1.</span> <span class="nav-text">models</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#init-py"><span class="nav-number">1.1.</span> <span class="nav-text">__init__.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#deeplab-py"><span class="nav-number">1.2.</span> <span class="nav-text">deeplab.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pspnet-py"><span class="nav-number">1.3.</span> <span class="nav-text">pspnet.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unet-py"><span class="nav-number">1.4.</span> <span class="nav-text">unet.py</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#config"><span class="nav-number">2.</span> <span class="nav-text">config</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dataset-py"><span class="nav-number">3.</span> <span class="nav-text">dataset.py</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#preprocess-py"><span class="nav-number">4.</span> <span class="nav-text">preprocess.py</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#trian-py"><span class="nav-number">5.</span> <span class="nav-text">trian.py</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#utils-py"><span class="nav-number">6.</span> <span class="nav-text">utils.py</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#test-py"><span class="nav-number">7.</span> <span class="nav-text">test.py</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HJY</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.3"></script>



  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
